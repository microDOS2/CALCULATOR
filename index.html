<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Channel Calculator — ALL‑IN</title>
<style>
  :root{ color-scheme: light dark }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; background:Canvas; color:CanvasText; line-height:1.45 }
  header{ position:sticky; top:0; z-index:10; padding:12px 16px; border-bottom:1px solid ButtonBorder; background:Canvas }
  header .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .wrap{ max-width:1680px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1.35fr 1fr; gap:16px }
  section{ background:Field; border:1px solid ButtonBorder; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:12px }
  h2{ margin:0; font-size:16px; display:flex; align-items:center; gap:8px }
  h3{ margin:10px 0 4px; font-size:14px; color:GrayText; border-bottom:1px solid ButtonBorder; padding-bottom:4px }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
  .grid-4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px }
  .sku-card {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    background: color-mix(in srgb, Field 95%, CanvasText 5%);
    border: 1px solid ButtonBorder;
    padding: 12px;
    border-radius: 12px;
    grid-template-areas:
      "name pills price price"
      "ing inner outer ."
      "d-cost d-packs s-cost s-packs"
      "rm rm rm rm";
  }
  .sku-card .rm { grid-area: rm; justify-self: start; }
  label{ display:block; margin:0 0 6px; font-size:12px; color:GrayText }
  input[type="text"],input[type="number"],select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid ButtonBorder; background:Field; color:FieldText; font-size:14px }
  input[readonly]{ background: color-mix(in srgb, Field 92%, CanvasText 8%); color: color-mix(in srgb, FieldText 70%, CanvasText 30%) }
  .btn{ appearance:none; border:1px solid ButtonBorder; background:ButtonFace; color:ButtonText; padding:8px 12px; border-radius:10px; font-size:13px; cursor:pointer }
  .btn.primary{ background:AccentColor; color:AccentColorText; border-color:AccentColor }
  .btn.small{ font-size:12px; padding:6px 10px }
  .chip{ background: color-mix(in srgb, Field 85%, CanvasText 15%); border:1px solid ButtonBorder; padding:4px 8px; border-radius:999px; font-size:12px; color: GrayText }
  .card{ background:Field; border:1px solid ButtonBorder; border-radius:12px; padding:10px; transition: opacity 0.3s ease; display:flex; flex-direction:column; gap:10px; }
  .kpi{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
  .big{ font-weight:700; font-size:19px }
  .thin{ font-variant-numeric:tabular-nums; letter-spacing:.3px }
  .divider{ height:1px; background:ButtonBorder; margin:6px 0 }
  .muted{ color:GrayText }
  .w-90{ width:90px } .w-120{ width:120px } .w-160{ width:160px } .w-180{ width:180px } .w-220{ width:220px }
  .q{ display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:999px; border:1px solid ButtonBorder; font-size:12px; color:GrayText; cursor:help; user-select:none }
  [data-tip]{ cursor:help }
  .tip{ position:absolute; z-index:20; max-width:560px; background:Canvas; color:CanvasText; border:1px solid ButtonBorder; border-radius:10px; padding:10px 12px; box-shadow:0 6px 24px rgba(0,0,0,.25); font-size:12px; line-height:1.4; display:none }
  .tip h3{ margin:0 0 6px; font-size:12px; color:GrayText }
  table{ width:100%; border-collapse:collapse; font-size:13px }
  th,td{ padding:8px 10px; border-bottom:1px solid ButtonBorder; text-align:right; white-space:nowrap }
  th:first-child,td:first-child{ text-align:left }
  #thirdPartySection details {
    border: 1px solid ButtonBorder;
    border-radius: 10px;
    margin-bottom: 10px;
    background: color-mix(in srgb, Field 95%, CanvasText 5%);
  }
  #thirdPartySection summary {
    padding: 10px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  #thirdPartySection summary:hover {
    background: color-mix(in srgb, Field 90%, CanvasText 10%);
  }
  #thirdPartySection .company-content {
    padding: 0 10px 10px;
  }
  #thirdPartySection table {
    font-size: 12px;
  }
  #thirdPartySection table td, #thirdPartySection table th {
    padding: 6px 8px;
  }
  #thirdPartySection input[type="number"] {
    width: 120px;
    padding: 6px 8px;
    font-size: 12px;
  }
  #thirdPartyCostSummary {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
  }
  .comm-tier { display:flex; flex-direction:column; gap:10px; }
  .comm-tier .card { background: color-mix(in srgb, Field 95%, CanvasText 5%); }
  #proj_table_hierarchical { font-size: 12px; }
  #proj_table_hierarchical td:nth-child(2), #proj_table_hierarchical td:nth-child(3), #proj_table_hierarchical td:nth-child(4) { text-align: right; }
  .level-pres { font-weight: bold; }
  .level-vp { padding-left: 20px !important; font-weight: bold; }
  .level-rsm { padding-left: 40px !important; }
  .level-sp { padding-left: 60px !important; font-style: italic; }
  .total-row { font-weight: bold; border-top: 2px solid ButtonBorder; }
  .po-tabs { display: flex; gap: 4px; border-bottom: 1px solid ButtonBorder; margin-bottom: 12px; }
  .po-tab { padding: 8px 12px; border: 1px solid ButtonBorder; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; background: color-mix(in srgb, Field 90%, CanvasText 10%); }
  .po-tab.active { background: Field; font-weight: bold; }
  .po-content { display: none; }
  .po-content.active { display: block; }
  #skuRows { display: flex; flex-direction: column; gap: 10px; }
  #orderComposition { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
  #monthlyVolumePerSku { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
</style>
</head><body>
<header>
  <div class="row">
    <div class="row" style="gap:8px">
      <strong>Channel Calculator — ALL‑IN</strong>
      <span class="chip" id="fmt_demo">Money format…</span>
      <span class="chip" id="status">Ready</span>
    </div>
    <div class="row">
      <button id="btn_choose_cols" class="btn">Choose columns</button>
      <select id="capture_sel" class="w-220"><option value="__full__">Full analytics (default)</option></select>
      <label class="row"><input id="autoCalc" type="checkbox" checked> Auto‑recalculate</label>
      <button id="recalcBtn" class="btn primary">Calculate / Recalculate</button>
    </div>
  </div>
</header>
<div class="wrap">
  <section>
    <h2>Product Specifications <span class="q" data-tip="prod">?</span></h2>
    <div id="skuRows">
      <!-- SKU rows will be generated by JS -->
    </div>
    <div class="row"><button class="btn" id="add_sku">Add SKU</button></div>
    <div class="grid-3">
      <div><label>Blended Packaging cost <span class="q" data-tip="packCost">?</span></label><input id="packCostPerPack" data-tip="packCost" type="text" value="$0" readonly></div>
      <div><label>Blended Display cost <span class="q" data-tip="dispCost">?</span></label><input id="dispCostPerPack" data-tip="dispCost" type="text" value="$0" readonly></div>
      <div><label>Blended Shipping Box cost <span class="q" data-tip="shipBoxCost">?</span></label><input id="shipBoxCostPerPack" data-tip="shipBoxCost" type="text" value="$0" readonly></div>
    </div>
    <div class="row"><span class="muted">Hover any <b>?</b> or <b>result value</b> for the formula with your numbers</span></div>
    <div class="divider"></div>
    <h2>Order Composition <span class="q" data-tip="orderComp">?</span></h2>
    <div id="orderComposition">
        <!-- Order composition fields will be generated by JS -->
    </div>
    <div class="row"><button class="btn" id="calc_order">Calculate Order</button></div>
    <div class="divider"></div>
    <h2>Ingredients <span class="q" data-tip="ingredients">?</span></h2>
    <div id="ingredients" class="grid-4"></div>
    <div class="row"><button class="btn" id="add_ing">Add ingredient</button><span class="muted">Name • milligrams per pill • cost per milligram</span></div>
    <div class="grid-2">
      <div class="card"><div class="muted">Blended ingredient cost per pack <span class="q" data-tip="k_ing">?</span></div><div id="kpi_ing" data-tip="k_ing" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Blended cost of goods per pack <span class="q" data-tip="k_cogs">?</span></div><div id="kpi_cogs" data-tip="k_cogs" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Ingredient Cost per milligram <span class="q" data-tip="k_mg">?</span></div><div id="kpi_costmg" data-tip="k_mg" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Ingredient Cost per gram <span class="q" data-tip="k_g">?</span></div><div id="kpi_costg" data-tip="k_g" class="big thin">$0</div></div>
    </div>
  </section>
  <section>
    <h2>Sales Channels <span class="q" data-tip="channels">?</span></h2>
    <div class="row" style="justify-content: space-between;">
        <div class="row" id="channel_toggles">
          <label class="row"><input id="includeR" type="checkbox" checked> Include Retail</label>
          <label class="row"><input id="includeW" type="checkbox" checked> Include Wholesale</label>
          <label class="row"><input id="includeD" type="checkbox" checked> Include Distributor</label>
        </div>
        <label class="row"><input id="autoMix" type="checkbox" checked> Auto‑redistribute mix</label>
    </div>
    <div class="grid-3">
      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_retail">Retail</strong><span class="muted">Price = Retail</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixR" class="w-120" type="number" value="50" data-tip="mix_input"></div>
          <div><label>Gross margin %</label><input id="gmR" data-tip="gmR" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpR" data-tip="gpR" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Revenue / pack</label><input id="revR" data-tip="revR" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opR" data-tip="opR" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omR" data-tip="omR" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
            <div><label>Cost per Pill</label><input id="costPerPillR" data-tip="costPerPillR" class="w-120" type="text" value="$0" readonly></div>
            <div><label>Profit per Pill</label><input id="profitPerPillR" data-tip="profitPerPillR" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Shipping per pack (USD) <span class="q" data-tip="shipCost">?</span></label><input id="shippingPerPack" class="w-120" type="number" step="0.01" value="2.50" data-tip="shipCost_input"></div>
          <label class="row"><input id="includeShip" type="checkbox" checked> Include shipping</label>
        </div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_wholesale">Wholesale</strong><span class="muted">Retail − Discount</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixW" class="w-120" type="number" value="30" data-tip="mix_input"></div>
          <div><label>Wholesale discount %</label><input id="wDisc" class="w-120" type="number" step="0.01" value="50" data-tip="wDisc_input"></div>
        </div>
        <div class="row">
          <div><label>Wholesale price / pack</label><input id="wPrice" data-tip="priceW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Gross margin %</label><input id="gmW" data-tip="gmW" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpW" data-tip="gpW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Retailer profit / pack</label><input id="retailerProfit" data-tip="retailerProfit" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opW" data-tip="opW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omW" data-tip="omW" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
            <div><label>Cost per Pill</label><input id="costPerPillW" data-tip="costPerPillW" class="w-120" type="text" value="$0" readonly></div>
            <div><label>Profit per Pill</label><input id="profitPerPillW" data-tip="profitPerPillW" class="w-120" type="text" value="$0" readonly></div>
        </div>
      </div>
      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_distributor">Distributor</strong><span class="muted">Wholesale − Discount</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixD" class="w-120" type="number" value="20" data-tip="mix_input"></div>
          <div><label>Distributor discount %</label><input id="dDisc" class="w-120" type="number" step="0.01" value="25" data-tip="dDisc_input"></div>
        </div>
        <div class="row">
          <div><label>Distributor price / pack</label><input id="dPrice" data-tip="priceD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Gross margin %</label><input id="gmD" data-tip="gmD" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpD" data-tip="gpD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Distributor profit / pack</label><input id="distProfit" data-tip="distProfit" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opD" data-tip="opD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omD" data-tip="omD" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
            <div><label>Cost per Pill</label><input id="costPerPillD" data-tip="costPerPillD" class="w-120" type="text" value="$0" readonly></div>
            <div><label>Profit per Pill</label><input id="profitPerPillD" data-tip="profitPerPillD" class="w-120" type="text" value="$0" readonly></div>
        </div>
      </div>
    </div>
    <div class="divider"></div>
    <h2>Monthly Costs (Operating Overhead) <span id="oh_total" class="chip" data-tip="oh_total_tip">Total: $0</span><span class="q" data-tip="overhead">?</span></h2>
    <div class="card">
        <label>Monthly Pack Volume per SKU</label>
        <div id="monthlyVolumePerSku"></div>
        <div class="grid-2">
            <div><label>Total Monthly Volume</label><input id="monthlyVolume" type="text" value="0" data-tip="monthlyVolume_total" readonly></div>
            <div><label>Overhead per Pill</label><input id="overheadPerPill" data-tip="overheadPerPill" type="text" value="$0" readonly></div>
        </div>
    </div>
    <div id="oh_rows"></div>
    <div class="row"><button class="btn" id="add_oh">Add overhead item</button><span class="muted">Name • Monthly cost</span></div>
    <div class="grid-3">
        <div>
            <label class="row"><input id="ohR" type="checkbox" checked> Include overhead in Retail</label>
        </div>
        <div>
            <label class="row"><input id="ohW" type="checkbox" checked> Include overhead in Wholesale</label>
        </div>
        <div>
            <label class="row"><input id="ohD" type="checkbox" checked> Include overhead in Distributor</label>
        </div>
    </div>

    <div class="divider"></div>
    <h2>Break-Even Analysis <span class="q" data-tip="be_section">?</span></h2>
    <div class="row" style="justify-content: space-between;">
        <label class="row"><input id="be_include_overhead" type="checkbox" checked> Include Monthly Overhead in Calculation</label>
    </div>
    <div class="grid-2">
        <div class="card">
            <div class="muted">Retail Break-Even <span class="q" data-tip="be_retail">?</span></div>
            <div id="be_retail" class="big thin">—</div>
        </div>
        <div class="card">
            <div class="muted">Wholesale Break-Even <span class="q" data-tip="be_wholesale">?</span></div>
            <div id="be_wholesale" class="big thin">—</div>
        </div>
        <div class="card">
            <div class="muted">Distributor Break-Even <span class="q" data-tip="be_distributor">?</span></div>
            <div id="be_distributor" class="big thin">—</div>
        </div>
        <div class="card">
            <div class="muted">Blended Break-Even <span class="q" data-tip="be_blended">?</span></div>
            <div id="be_blended" class="big thin">—</div>
        </div>
    </div>

    <div class="divider"></div>
    <h2>Blended Key Performance Indicators</h2>
    <div id="blended_kpis">
        <div class="kpi">
          <div class="card"><div class="muted">Blended revenue per pack <span class="q" data-tip="brev">?</span></div><div id="kpi_brev" data-tip="brev" class="big thin">$0</div></div>
          <div class="card"><div class="muted">Blended gross profit per pack <span class="q" data-tip="bgpp">?</span></div><div id="kpi_bgpp" data-tip="bgpp" class="big thin">$0</div></div>
          <div class="card"><div class="muted">Blended gross margin (percent) <span class="q" data-tip="bgmp">?</span></div><div id="kpi_bgmp" data-tip="bgmp" class="big thin">0%</div></div>
        </div>
        <div class="kpi">
          <div class="card"><div class="muted">Overhead per pack <span class="q" data-tip="ohpp">?</span></div><div id="kpi_ohpp" data-tip="ohpp" class="big thin">$0</div></div>
          <div class="card"><div class="muted">Blended operating profit per pack <span class="q" data-tip="bopp">?</span></div><div id="kpi_bopp" data-tip="bopp" class="big thin">$0</div></div>
          <div class="card"><div class="muted">Blended operating margin (percent) <span class="q" data-tip="bomp">?</span></div><div id="kpi_bomp" data-tip="bomp" class="big thin">0%</div></div>
        </div>
    </div>
    <div id="blended_kpi_warning" class="card" style="display:none; text-align:center; color:GrayText;">Please select at least one sales channel to calculate Blended KPIs.</div>

  </section>
  <!-- START: Purchase Orders Section -->
  <section style="grid-column:1 / -1">
    <h2>Purchase Orders <span class="q" data-tip="po_section">?</span></h2>
    <div class="po-tabs">
      <div class="po-tab active" data-tab="retail">Retail</div>
      <div class="po-tab" data-tab="wholesale">Wholesale</div>
      <div class="po-tab" data-tab="distributor">Distributor</div>
    </div>

    <div id="po-retail" class="po-content active"></div>
    <div id="po-wholesale" class="po-content"></div>
    <div id="po-distributor" class="po-content"></div>
  </section>
  <!-- END: Purchase Orders Section -->
  <!-- START: New Sales Commissions Section -->
  <section style="grid-column:1 / -1">
    <h2>Sales Commission Hierarchy <span class="q" data-tip="comm_section_main">?</span></h2>

    <!-- President Tier -->
    <div class="comm-tier">
        <h3>President of Sales <span class="q" data-tip="comm_pres_tier">?</span></h3>
        <div id="president_card" class="card">
            <!-- President card content will be generated by JS -->
        </div>
    </div>
    <!-- VP Tier -->
    <div class="comm-tier">
        <div class="row" style="justify-content: space-between;">
            <h3>VPs of Sales <span class="q" data-tip="comm_vp_tier">?</span></h3>
            <button id="add_vp" class="btn small">Add VP of Sales</button>
        </div>
        <div id="vps_container"></div>
    </div>
    <!-- RSM Tier -->
    <div class="comm-tier">
        <div class="row" style="justify-content: space-between;">
            <h3>Regional Sales Managers (RSMs) <span class="q" data-tip="comm_rsm_tier">?</span></h3>
            <button id="add_rsm" class="btn small">Add RSM</button>
        </div>
        <div id="rsms_container"></div>
    </div>
    <!-- Salesperson Tier -->
    <div class="comm-tier">
        <div class="row" style="justify-content: space-between;">
            <h3>Salespersons <span class="q" data-tip="comm_sp_tier">?</span></h3>
            <button id="add_sp" class="btn small">Add Salesperson</button>
        </div>
        <div id="sps_container"></div>
    </div>
    <div class="divider"></div>
    <h2>Commission Projections</h2>
    <div id="comm_proj_table" class="card">
      <div class="row" style="padding-bottom: 10px;">
        <div><label>Projection Period View</label>
          <select id="projPeriod" class="w-160"><option>Daily</option><option>Weekly</option><option selected>Monthly</option><option>Yearly</option></select>
        </div>
         <span class="muted" style="align-self: flex-end;">(Calculations are based on the selected period)</span>
      </div>
      <div class="scroller" style="max-height:400px; overflow:auto;">
        <table id="proj_table_hierarchical">
            <thead>
                <tr>
                    <th>Role / Name</th>
                    <th>Base Pay</th>
                    <th>Bonuses</th>
                    <th>Override</th>
                    <th>Total Pay</th>
                </tr>
            </thead>
            <tbody id="proj_body_hierarchical"></tbody>
        </table>
      </div>
    </div>
  </section>
  <!-- END: New Sales Commissions Section -->
  <!-- START: Third Party Companies Section -->
  <section id="thirdPartySection" style="grid-column:1 / -1">
    <h2>Third Party Companies <span class="q" data-tip="thirdParty_section">?</span></h2>
    <div id="thirdPartyCompaniesContainer"></div>
    <div id="thirdPartyCostSummary">
        <div class="card">
            <div class="muted">Total Monthly Cost <span class="q" data-tip="tp_monthly">?</span></div>
            <div id="tp_monthly_cost" class="big thin">$0.00</div>
        </div>
        <div class="card">
            <div class="muted">Total Weekly Cost <span class="q" data-tip="tp_weekly">?</span></div>
            <div id="tp_weekly_cost" class="big thin">$0.00</div>
        </div>
        <div class="card">
            <div class="muted">Total Daily Cost <span class="q" data-tip="tp_daily">?</span></div>
            <div id="tp_daily_cost" class="big thin">$0.00</div>
        </div>
    </div>
  </section>
  <!-- END: Third Party Companies Section -->
  <section style="grid-column:1 / -1">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h2>Scenarios (v6) <span class="q" data-tip="scenarios">?</span></h2>
        <div class="muted">Save inputs & outputs with timestamps. Capture controls which columns are stored.</div>
      </div>
      <div class="row">
        <input id="scenario_label" class="w-160" type="text" placeholder="Scenario label">
        <button id="btn_save" class="btn primary">Save scenario</button>
        <button id="btn_csv" class="btn">Download CSV</button>
        <button id="btn_clear" class="btn">Clear all</button>
      </div>
    </div>
    <div class="scroller" style="max-height:420px; overflow:auto">
      <table id="scenarios_tbl">
        <thead id="scenarios_head"></thead>
        <tbody id="scenarios_body"></tbody>
      </table>
    </div>
  </section>
</div>
<div id="tip" class="tip"></div>
<div id="modal" style="display:none; position:fixed; inset:0; background:color-mix(in srgb, Canvas 70%, CanvasText 30%); align-items:center; justify-content:center; z-index:50">
  <div style="background:Field; border:1px solid ButtonBorder; border-radius:16px; padding:16px; width:min(980px, 92vw); max-height:85vh; overflow:auto; display:flex; flex-direction:column; gap:12px">
    <div class="row" style="justify-content:space-between"><strong>Choose columns to capture</strong><button id="modal_close" class="btn small">Close</button></div>
    <div id="cols_groups"></div>
    <div class="row" style="justify-content:flex-end">
      <input id="cap_name" class="w-220" placeholder="Name this capture (e.g., Sales Focus)">
      <button id="save_capture" class="btn primary">Save capture</button>
    </div>
  </div>
</div>
<script>
// ===== Utilities =====
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function num(v){ const x = Number(v); return isFinite(x)? x : 0 }
function pct(x){ if(!isFinite(x)||x===0) return '0%'; return (x*100).toFixed(1).replace(/\.0$/, '')+'%' }
function money(n) { return '$' + (Number(n) || 0).toFixed(2); }
function money3(n){ const x = Number(n||0); const s = Math.abs(x).toFixed(3); let out = s.replace(/\.([0-9]{2})0$/, '.$1'); out = out.replace(/\.00$/, ''); out = out.replace(/\B(?=(\d{3})+(?!\d))/g, ','); return (x<0?'-':'')+'$'+out }
(function(){ const demo=[12,12.5,12.345,12.340,0].map(money3).join(' · '); $('#fmt_demo').textContent='Formatter: '+demo })();
// ===== Tooltip engine =====
const TIP = $('#tip');
const tooltips = {};
let LATEST_CALC = {}; // Holds the latest calculation results
function showTip(key, evt){
    const target = evt.target.closest('[data-tip], .q');
    if (!target) return;
    const tipKey = target.getAttribute('data-tip');
    const t = tooltips[tipKey];
    if(!t) return;
    TIP.innerHTML = '<h3>'+t.title+'</h3><div>'+t.body(target)+'</div>';
    const r=target.getBoundingClientRect();
    TIP.style.display='block';
    TIP.style.top=(r.top+window.scrollY+r.height+6)+'px';
    TIP.style.left=Math.min(r.left+window.scrollX+10, window.scrollX+window.innerWidth-TIP.offsetWidth-20)+'px'
}
function hideTip(){ TIP.style.display='none' }
function initializeTooltipEvents() {
    document.body.addEventListener('mouseover', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            showTip(null, e);
        }
    });
    document.body.addEventListener('mouseout', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            hideTip();
        }
    });
    document.body.addEventListener('focusin', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            showTip(null, e);
        }
    });
    document.body.addEventListener('focusout', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            hideTip();
        }
    });
}
// ===== Dynamic rows builders =====
function makeIngRow(name='', mg='', usdmg=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 ingName" placeholder="Ingredient" value="'+name+'" data-tip="ingName_input"> <input class="w-120 ingMg" type="number" step="0.0001" placeholder="mg/pill" value="'+mg+'" data-tip="ingMg_input"> <input class="w-120 ingUsdMg" type="number" step="0.000001" placeholder="$ / mg" value="'+usdmg+'" data-tip="ingUsdMg_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makeOhRow(name='', cost=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 ohName" placeholder="Name" value="'+name+'" data-tip="ohName_input"> <input class="w-120 ohCost" type="number" step="0.01" placeholder="$/month" value="'+cost+'" data-tip="ohCost_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makeSkuRow(p){
  const d = document.createElement('div');
  d.className='sku-card';
  d.innerHTML = `
    <div style="grid-area: name"><label>SKU</label><input class="skuName" type="text" value="${p.sku}" readonly data-tip="sku"></div>
    <div style="grid-area: pills"><label>Pills/pack</label><input class="pills" type="number" value="${p.pills}" data-tip="pills_input"></div>
    <div style="grid-area: price"><label>Retail price/pack</label><input class="retailPrice" type="number" step="0.01" value="${p.price}" data-tip="price_input"></div>
    
    <div style="grid-area: ing"><label>Ingredient Cost/pack</label><input class="ingCostSku" type="text" value="$0" data-tip="ingCostSku" readonly></div>
    <div style="grid-area: inner"><label>Inner Pkg Cost</label><input class="innerPkgCost" type="number" step="0.01" value="${p.innerPkg}" data-tip="innerPkgCost_input"></div>
    <div style="grid-area: outer"><label>Outer Box Cost</label><input class="outerBoxCost" type="number" step="0.01" value="${p.outerBox}" data-tip="outerBoxCost_input"></div>
    
    <div style="grid-area: d-cost"><label>Display Box Cost</label><input class="displayBoxCost" type="number" step="0.01" value="${p.displayBox}" data-tip="displayBoxCost_input"></div>
    <div style="grid-area: d-packs"><label>Packs per Display</label><input class="packsPerDisplay" type="number" value="${p.packsPerDisplay}" data-tip="packsPerDisplay_input"></div>
    <div style="grid-area: s-cost"><label>Shipping Box Cost</label><input class="shippingBoxCost" type="number" step="0.01" value="${p.shippingBox}" data-tip="shippingBoxCost_input"></div>
    <div style="grid-area: s-packs"><label>Packs per Ship Box</label><input class="packsPerShipBox" type="number" value="${p.packsPerShipBox}" data-tip="packsPerShipBox_input"></div>

    <div class="rm"><button class="btn small">Remove</button></div>
  `;
  d.querySelector('.rm button').onclick = () => { d.remove(); updateOrderComposition(); updateMonthlyVolumeInputs(); if($('#autoCalc').checked) render(); };
  return d;
}
function makeOrderRow(sku, qty=0){
  const d = document.createElement('div'); d.className='card';
  d.innerHTML = `<div><label>SKU: ${sku}</label><input class="orderQty" type="number" value="${qty}" data-tip="orderQty_input"></div>`;
  return d;
}
function makeMonthlyVolumeRow(sku, qty = 1) {
    const d = document.createElement('div');
    d.className = 'card';
    d.innerHTML = `<div><label>SKU: ${sku}</label><input class="monthlyVolumeSku" type="number" value="${qty}" data-tip="monthlyVolume_sku_input"></div>`;
    return d;
}
// ===== Wire add buttons =====
$('#add_ing').onclick = ()=>{ $('#ingredients').appendChild(makeIngRow()); if($('#autoCalc').checked) render() };
$('#add_oh').onclick = ()=>{ $('#oh_rows').appendChild(makeOhRow()); if($('#autoCalc').checked) render() };
$('#add_sku').onclick = ()=>{ 
    const newPills = 10;
    $('#skuRows').appendChild(makeSkuRow({
        sku: `${newPills}-pack`,
        pills: newPills,
        price: 57.50,
        innerPkg: 1.75,
        outerBox: 1.75,
        displayBox: 0,
        packsPerDisplay: 1,
        shippingBox: 1.5,
        packsPerShipBox: 1
    })); 
    updateOrderComposition(); 
    updateMonthlyVolumeInputs();
    if($('#autoCalc').checked) render(); 
};
$('#calc_order').onclick = render;
// ===== State + math =====
function getState(){
  const S={};
  S.skus = $$('#skuRows .sku-card').map(r => ({
    sku: r.querySelector('.skuName').value,
    pills: num(r.querySelector('.pills').value),
    retailPrice: num(r.querySelector('.retailPrice').value),
    innerPkgCost: num(r.querySelector('.innerPkgCost').value),
    outerBoxCost: num(r.querySelector('.outerBoxCost').value),
    displayBoxCost: num(r.querySelector('.displayBoxCost').value),
    packsPerDisplay: Math.max(1, num(r.querySelector('.packsPerDisplay').value)),
    shippingBoxCost: num(r.querySelector('.shippingBoxCost').value),
    packsPerShipBox: Math.max(1, num(r.querySelector('.packsPerShipBox').value))
  }));
  S.order = $$('#orderComposition .card').map(r => ({
    sku: r.querySelector('label').textContent.replace('SKU: ', ''),
    qty: num(r.querySelector('.orderQty').value)
  }));
  S.includeShip = $('#includeShip')? $('#includeShip').checked : true;
  S.shippingPerPack = num($('#shippingPerPack')?.value || 0);
  S.wDisc = num($('#wDisc').value);
  S.dDisc = num($('#dDisc').value);
  S.mixR = $('#includeR').checked ? num($('#mixR').value) : 0;
  S.mixW = $('#includeW').checked ? num($('#mixW').value) : 0;
  S.mixD = $('#includeD').checked ? num($('#mixD').value) : 0;
  S.ohR = $('#ohR').checked; S.ohW = $('#ohW').checked; S.ohD = $('#ohD').checked;
  S.monthlyVolume = $$('#monthlyVolumePerSku .monthlyVolumeSku').reduce((total, input) => total + num(input.value), 0);
  S.ing = $$('#ingredients .row').map(r=>({ mg:num(r.querySelector('.ingMg').value), usdmg:num(r.querySelector('.ingUsdMg').value) }));
  S.oh = $$('#oh_rows .row').map(r=> num(r.querySelector('.ohCost').value));
  return S;
}
function calc(){
  const S = getState();
  const totalPacks = S.order.reduce((sum, o) => sum + o.qty, 0);
  const totalPills = S.order.reduce((sum, o) => {
    const sku = S.skus.find(s => s.sku === o.sku);
    return sum + (sku ? o.qty * sku.pills : 0);
  }, 0);

  const weightedRetailPrice = S.order.reduce((sum, o) => {
    const sku = S.skus.find(s => s.sku === o.sku);
    return sum + (sku ? o.qty * sku.retailPrice : 0);
  }, 0) / (totalPacks || 1);

  const weightedPackagingCost = S.order.reduce((sum, o) => {
    const sku = S.skus.find(s => s.sku === o.sku);
    return sum + (sku ? o.qty * (sku.innerPkgCost + sku.outerBoxCost) : 0);
  }, 0) / (totalPacks || 1);

  const weightedDisplayCost = S.order.reduce((sum, o) => {
    const sku = S.skus.find(s => s.sku === o.sku);
    const amortizedDisplay = sku ? sku.displayBoxCost / sku.packsPerDisplay : 0;
    return sum + (sku ? o.qty * amortizedDisplay : 0);
  }, 0) / (totalPacks || 1);

  const weightedShippingBoxCost = S.order.reduce((sum, o) => {
    const sku = S.skus.find(s => s.sku === o.sku);
    const amortizedShipping = sku ? sku.shippingBoxCost / sku.packsPerShipBox : 0;
    return sum + (sku ? o.qty * amortizedShipping : 0);
  }, 0) / (totalPacks || 1);
  
  const weightedPillsPerPack = totalPills / (totalPacks || 1);
  
  const ingPerPack = S.ing.reduce((a, x) => a + (x.mg * weightedPillsPerPack * x.usdmg), 0);
  const cogs = ingPerPack + weightedPackagingCost + weightedDisplayCost + weightedShippingBoxCost;
  const priceR = weightedRetailPrice;
  const priceW = priceR * (1 - S.wDisc / 100);
  const priceD = priceW * (1 - S.dDisc / 100);
  const gpR = priceR - cogs, gpW = priceW - cogs, gpD = priceD - cogs;
  const gmR = priceR > 0 ? gpR / priceR : 0, gmW = priceW > 0 ? gpW / priceW : 0, gmD = priceD > 0 ? gpD / priceD : 0;
  const ohTotal = S.oh.reduce((a, x) => a + x, 0);

  const totalMonthlyVolume = Math.max(1, S.monthlyVolume);
  const ohPerPack = totalMonthlyVolume > 0 ? ohTotal / totalMonthlyVolume : 0;

  const ohPerPackR = S.ohR ? ohPerPack : 0;
  const ohPerPackW = S.ohW ? ohPerPack : 0;
  const ohPerPackD = S.ohD ? ohPerPack : 0;

  const shipPerPack = S.includeShip ? S.shippingPerPack : 0;

  const opR = gpR - ohPerPackR - shipPerPack;
  const opW = gpW - ohPerPackW;
  const opD = gpD - ohPerPackD;
  const omR = priceR > 0 ? opR / priceR : 0, omW = priceW > 0 ? opW / priceW : 0, omD = priceD > 0 ? opD / priceD : 0;
  const mR = S.mixR / 100, mW = S.mixW / 100, mD = S.mixD / 100;
  const brev = priceR * mR + priceW * mW + priceD * mD;
  const bgpp = gpR * mR + gpW * mW + gpD * mD;
  const bopp = opR * mR + opW * mW + opD * mD;
  const bgmp = brev > 0 ? bgpp / brev : 0;
  const bomp = brev > 0 ? bopp / brev : 0;

  const retailerProfit = priceR - priceW;
  const distProfit = priceW - priceD;

  const totalMgPerPack = S.ing.reduce((a, x) => a + x.mg * weightedPillsPerPack, 0);
  const costPerMg = totalMgPerPack > 0 ? ingPerPack / totalMgPerPack : 0;
  const costPerGram = costPerMg * 1000;

  // Per-pill calculations
  const costPerPill = weightedPillsPerPack > 0 ? cogs / weightedPillsPerPack : 0;
  const profitPerPillR = weightedPillsPerPack > 0 ? opR / weightedPillsPerPack : 0;
  const profitPerPillW = weightedPillsPerPack > 0 ? opW / weightedPillsPerPack : 0;
  const profitPerPillD = weightedPillsPerPack > 0 ? opD / weightedPillsPerPack : 0;
  const overheadPerPill = weightedPillsPerPack > 0 ? ohPerPack / weightedPillsPerPack : 0;

  const commissionResults = calculateAllCommissions(S, { priceR, priceW, priceD, gpR, gpW, gpD });

  const beIncludeOverhead = $('#be_include_overhead').checked;
  const totalFixedCosts = beIncludeOverhead ? S.oh.reduce((a, x) => a + x, 0) : 0;
  const be_units_R = opR > 0 ? totalFixedCosts / opR : Infinity;
  const be_units_W = opW > 0 ? totalFixedCosts / opW : Infinity;
  const be_units_D = opD > 0 ? totalFixedCosts / opD : Infinity;
  const be_units_B = bopp > 0 ? totalFixedCosts / bopp : Infinity;
  const be_rev_R = be_units_R * priceR;
  const be_rev_W = be_units_W * priceW;
  const be_rev_D = be_units_D * priceD;
  const be_rev_B = be_units_B * brev;
  LATEST_CALC = { S, ingPerPack, packPerPack: weightedPackagingCost, dispPerPack: weightedDisplayCost, weightedShippingBoxCost, cogs, priceR, priceW, priceD, gpR, gpW, gpD, gmR, gmW, gmD, ohPerPack, ohPerPackR, ohPerPackW, ohPerPackD, shipPerPack, opR, opW, opD, omR, omW, omD, brev, bgpp, bopp, bgmp, bomp, retailerProfit, distProfit, costPerMg, costPerGram, commissionResults, totalFixedCosts, be_units_R, be_units_W, be_units_D, be_units_B, be_rev_R, be_rev_W, be_rev_D, be_rev_B, ohTotal, totalPacks, totalPills, weightedRetailPrice, weightedPillsPerPack, costPerPill, profitPerPillR, profitPerPillW, profitPerPillD, overheadPerPill, totalMonthlyVolume };
  return LATEST_CALC;
}
function updateOrderComposition(){
    const currentQuantities = {};
    $$('#orderComposition .card').forEach(card => {
        const skuName = card.querySelector('label').textContent.replace('SKU: ', '');
        const qty = num(card.querySelector('.orderQty').value);
        currentQuantities[skuName] = qty;
    });

    const skus = $$('#skuRows .sku-card').map(r => r.querySelector('.skuName').value);
    const container = $('#orderComposition');
    container.innerHTML = '';

    skus.forEach(skuName => {
        const savedQty = currentQuantities[skuName] || 0;
        container.appendChild(makeOrderRow(skuName, savedQty));
    });
}
function updateMonthlyVolumeInputs() {
    const currentVolumes = {};
    $$('#monthlyVolumePerSku .card').forEach(card => {
        const skuName = card.querySelector('label').textContent.replace('SKU: ', '');
        const qty = num(card.querySelector('.monthlyVolumeSku').value);
        currentVolumes[skuName] = qty;
    });

    const skus = $$('#skuRows .sku-card').map(r => r.querySelector('.skuName').value);
    const container = $('#monthlyVolumePerSku');
    container.innerHTML = '';

    skus.forEach(skuName => {
        const savedQty = currentVolumes[skuName] || 1;
        container.appendChild(makeMonthlyVolumeRow(skuName, savedQty));
    });
}
function render(){
  const C = calc();
  const { S } = C;
  
  // Per-SKU Ingredient Cost
  const ingPerPill = S.ing.reduce((a, x) => a + (x.mg * x.usdmg), 0);
  $$('#skuRows .sku-card').forEach(row => {
    const pills = num(row.querySelector('.pills').value);
    const ingCost = ingPerPill * pills;
    row.querySelector('.ingCostSku').value = money3(ingCost);
  });
  
  updateMonthlyVolumeInputs();
  $('#packCostPerPack').value = money3(C.packPerPack);
  $('#dispCostPerPack').value = money3(C.dispPerPack);
  $('#shipBoxCostPerPack').value = money3(C.weightedShippingBoxCost);
  $('#kpi_ing').textContent = money3(C.ingPerPack);
  $('#kpi_cogs').textContent = money3(C.cogs);
  $('#kpi_costmg').textContent = C.costPerMg > 0 ? money3(C.costPerMg) : '$0';
  $('#kpi_costg').textContent = C.costPerGram > 0 ? money(C.costPerGram) : '$0';
  $('#wPrice').value = money3(C.priceW);
  $('#dPrice').value = money3(C.priceD);
  $('#revR').value = money3(C.priceR);
  $('#gpR').value = money3(C.gpR); $('#gmR').value = pct(C.gmR);
  $('#gpW').value = money3(C.gpW); $('#gmW').value = pct(C.gmW);
  $('#gpD').value = money3(C.gpD); $('#gmD').value = pct(C.gmD);
  $('#opR').value = money3(C.opR); $('#omR').value = pct(C.omR);
  $('#opW').value = money3(C.opW); $('#omW').value = pct(C.omW);
  $('#opD').value = money3(C.opD); $('#omD').value = pct(C.omD);
  $('#retailerProfit').value = money3(C.retailerProfit);
  $('#distProfit').value = money3(C.distProfit);

  // Per Pill Metrics
  $('#costPerPillR').value = money3(C.costPerPill);
  $('#profitPerPillR').value = money3(C.profitPerPillR);
  $('#costPerPillW').value = money3(C.costPerPill);
  $('#profitPerPillW').value = money3(C.profitPerPillW);
  $('#costPerPillD').value = money3(C.costPerPill);
  $('#profitPerPillD').value = money3(C.profitPerPillD);
  $('#overheadPerPill').value = money3(C.overheadPerPill);
  $('#monthlyVolume').value = C.totalMonthlyVolume.toLocaleString();

  const totalMix = S.mixR + S.mixW + S.mixD;
  const showBlended = totalMix > 0;
  $('#blended_kpis').style.display = showBlended ? 'block' : 'none';
  $('#blended_kpi_warning').style.display = showBlended ? 'none' : 'block';
  if (showBlended) {
      $('#kpi_brev').textContent = money3(C.brev);
      $('#kpi_bgpp').textContent = money3(C.bgpp);
      $('#kpi_bgmp').textContent = pct(C.bgmp);
      $('#kpi_ohpp').textContent = money3(C.ohPerPack);
      $('#kpi_bopp').textContent = money3(C.bopp);
      $('#kpi_bomp').textContent = pct(C.bomp);
  }
  // Render Break-Even
  const formatRetailBE = (units, rev, pillsPerPack, packsPerDisplay) => {
      if (!isFinite(units)) return 'Unprofitable';
      const totalPills = Math.ceil(units) * pillsPerPack;
      return `
          <div class="big thin">${Math.ceil(units).toLocaleString()} packs</div>
          <div class="muted" style="font-size:12px;">
              (${totalPills.toLocaleString()} pills)<br>
              ${money(rev)}
          </div>
      `;
  };
  const formatMasterPackBE = (units, rev, unitType, packsPerUnit) => {
      if (!isFinite(units)) return 'Unprofitable';
      const masterUnits = units / packsPerUnit;
      return `
          <div class="big thin">${masterUnits.toFixed(2)}</div>
          <div>${unitType}</div>
          <div class="muted" style="font-size:12px;">
              (${Math.ceil(units).toLocaleString()} individual packs)<br>
              ${money(rev)}
          </div>
      `;
  };
  const formatBlendedBE = (units, rev, mixR, mixW, mixD) => {
      if (!isFinite(units)) return 'Unprofitable';
      const packsR = Math.ceil(units * (mixR / 100));
      const packsW = Math.ceil(units * (mixW / 100));
      const packsD = Math.ceil(units * (mixD / 100));
      return `
          <div class="big thin">${Math.ceil(units).toLocaleString()} total packs</div>
          <div class="muted" style="font-size:12px; text-align:left;">
              Retail: ${packsR.toLocaleString()} packs<br>
              Wholesale: ${packsW.toLocaleString()} packs<br>
              Distributor: ${packsD.toLocaleString()} packs<br>
              <b>Total Revenue: ${money(rev)}</b>
          </div>
      `;
  };
  $('#be_retail').innerHTML = formatRetailBE(C.be_units_R, C.be_rev_R, C.weightedPillsPerPack);
  $('#be_wholesale').innerHTML = formatMasterPackBE(C.be_units_W, C.be_rev_W, 'WHOLESALE master packs', 100);
  $('#be_distributor').innerHTML = formatMasterPackBE(C.be_units_D, C.be_rev_D, 'MASTER DISTRIBUTOR PACKS', 5000);
  $('#be_blended').innerHTML = formatBlendedBE(C.be_units_B, C.be_rev_B, S.mixR, S.mixW, S.mixD);
  $('#oh_total').textContent = `Total: ${money(C.ohTotal)}`;

  // Render new commission table
  renderCommissionTable(C.commissionResults);
  // Render Purchase Orders
  calculatePurchaseOrders(C);
  // tooltips
  wireTips(C);
  // scenarios UI
  drawScenarioTableHeaders();
  drawScenarioRows();
  $('#status').textContent = 'Calculated ' + new Date().toLocaleString();
}
function wireTips(C){
  const S=C.S; const ship = S.includeShip? money3(C.shipPerPack)+' per pack' : '$0 not included';
  const beIncludeOverhead = $('#be_include_overhead').checked;
  const beFixedCosts = beIncludeOverhead ? 'Total Fixed Costs' : '$0 (Overhead Excluded)';
  const poTotals = calculatePurchaseOrderTotals(C);
  const tips = {
    prod:{title:'Product specs', body:()=> 'Define your product SKUs here. All calculations below are based on the weighted average of the SKUs in the "Order Composition".'},
    pills:{title:'Pills per pack', body:()=> 'Weighted average: '+C.weightedPillsPerPack.toFixed(2)+' pills/pack'},
    price:{title:'Retail price', body:()=> 'Weighted average: = <b>'+money3(C.weightedRetailPrice)+'</b>'},
    packCost:{title:'Blended Packaging/pack', body:()=> 'This is the weighted average packaging cost (inner + outer) per pack, based on your "Order Composition" and the per-SKU packaging costs.'},
    dispCost:{title:'Blended Display/pack', body:()=> 'This is the weighted average amortized display cost per pack, based on your "Order Composition" and the per-SKU display costs and packs per display.'},
    shipBoxCost: {title:'Blended Shipping Box/pack', body:()=> 'This is the weighted average amortized shipping box cost per pack, based on your "Order Composition" and the per-SKU shipping box costs.'},
    ingredients:{title:'Ingredients', body:()=> 'Define the components of a single pill here.'},
    ingCostSku: {title: 'Ingredient Cost per SKU', body: (target) => {
        const row = target.closest('.sku-card');
        if (!row) return '...';
        const pills = num(row.querySelector('.pills').value);
        const ingPerPill = LATEST_CALC.S.ing.reduce((a, x) => a + (x.mg * x.usdmg), 0);
        const ingCost = ingPerPill * pills;
        return `Total ingredient cost for one pill (${money3(ingPerPill)}) × ${pills} pills in this pack = <b>${money3(ingCost)}</b>`;
    }},
    k_ing:{title:'Blended ingredient cost / pack', body:()=> 'This is the weighted average ingredient cost per pack based on your "Order Composition". = <b>'+money3(C.ingPerPack)+'</b>'},
    k_cogs:{title:'Blended COGS / pack', body:()=> `Blended Cost of Goods Sold, weighted by "Order Composition".<br>${money3(C.ingPerPack)} (Ingredients) + ${money3(C.packPerPack)} (Packaging) + ${money3(C.dispPerPack)} (Display) + ${money3(C.weightedShippingBoxCost)} (Shipping Box) = <b>${money3(C.cogs)}</b>`},
    k_mg:{title:'Ingredient Cost $/mg & $/kg', body:()=> { const C = LATEST_CALC; const S = C.S; const mg=S.ing.reduce((a,x)=>a+x.mg*C.weightedPillsPerPack,0); if(!mg) return '—'; const mgString = `${money3(C.ingPerPack)} / ${mg.toFixed(0)} mg = <b>${money3(C.costPerMg)}/mg</b>`; const kgString = `${money(C.costPerGram)}/g × 1000 = <b>${money(C.costPerGram * 1000)}/kg</b>`; return `${mgString}<br>${kgString}`; }},
    k_g:{title:'Ingredient Cost $/gram', body:()=> { const C = LATEST_CALC; const S = C.S; const mg=S.ing.reduce((a,x)=>a+x.mg*C.weightedPillsPerPack,0); return mg? money3(C.costPerMg)+' × 1000 = <b>'+money(C.costPerGram)+'</b>':'—' }},
    channels:{title:'Channels', body:()=> 'Wholesale/Distributor apply discounts to the weighted average Retail price.'},
    mix:{title:'Mix %', body:()=> 'Auto‑redistribute keeps R/W/D totaling 100%'},
    priceW:{title:'Wholesale price', body:()=> money3(C.weightedRetailPrice)+' × (1 − '+C.S.wDisc.toFixed(2)+'%) = <b>'+money3(C.priceW)+'</b>'},
    priceD:{title:'Distributor price', body:()=> money3(C.priceW)+' (Wholesale) × (1 − '+C.S.dDisc.toFixed(2)+'%) = <b>'+money3(C.priceD)+'</b>'},
    gpR:{title:'Retail GP/pack', body:()=> money3(C.priceR)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpR)+'</b>'},
    gpW:{title:'Wholesale GP/pack', body:()=> money3(C.priceW)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpW)+'</b>'},
    gpD:{title:'Distributor GP/pack', body:()=> money3(C.priceD)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpD)+'</b>'},
    gmR:{title:'Retail GM%', body:()=> money3(C.gpR)+' / '+money3(C.priceR)+' = <b>'+pct(C.gmR)+'</b>'},
    gmW:{title:'Wholesale GM%', body:()=> money3(C.gpW)+' / '+money3(C.priceW)+' = <b>'+pct(C.gmW)+'</b>'},
    gmD:{title:'Distributor GM%', body:()=> money3(C.gpD)+' / '+money3(C.priceD)+' = <b>'+pct(C.gmD)+'</b>'},
    opR:{title:'Retail OP/pack', body:()=> `${money3(C.gpR)} - ${money3(C.ohPerPackR)} (Overhead) - ${ship} = <b>${money3(C.opR)}</b>`},
    opW:{title:'Wholesale OP/pack', body:()=> `${money3(C.gpW)} - ${money3(C.ohPerPackW)} (Overhead) = <b>${money3(C.opW)}</b>`},
    opD:{title:'Distributor OP/pack', body:()=> `${money3(C.gpD)} - ${money3(C.ohPerPackD)} (Overhead) = <b>${money3(C.opD)}</b>`},
    omR:{title:'Retail OM%', body:()=> money3(C.opR)+' / '+money3(C.priceR)+' = <b>'+pct(C.omR)+'</b>'},
    omW:{title:'Wholesale OM%', body:()=> money3(C.opW)+' / '+money3(C.priceW)+' = <b>'+pct(C.omW)+'</b>'},
    omD:{title:'Distributor OM%', body:()=> money3(C.opD)+' / '+money3(C.priceD)+' = <b>'+pct(C.omD)+'</b>'},
    costPerPillR: {title: 'Cost Per Pill (Retail)', body:()=> `Total COGS per Pack / Weighted Pills per Pack.<br>${money3(C.cogs)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.costPerPill)}</b>`},
    profitPerPillR: {title: 'Profit Per Pill (Retail)', body:()=> `Operating Profit per Pack / Weighted Pills per Pack.<br>${money3(C.opR)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.profitPerPillR)}</b>`},
    costPerPillW: {title: 'Cost Per Pill (Wholesale)', body:()=> `Total COGS per Pack / Weighted Pills per Pack.<br>${money3(C.cogs)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.costPerPill)}</b>`},
    profitPerPillW: {title: 'Profit Per Pill (Wholesale)', body:()=> `Operating Profit per Pack / Weighted Pills per Pack.<br>${money3(C.opW)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.profitPerPillW)}</b>`},
    costPerPillD: {title: 'Cost Per Pill (Distributor)', body:()=> `Total COGS per Pack / Weighted Pills per Pack.<br>${money3(C.cogs)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.costPerPill)}</b>`},
    profitPerPillD: {title: 'Profit Per Pill (Distributor)', body:()=> `Operating Profit per Pack / Weighted Pills per Pack.<br>${money3(C.opD)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.profitPerPillD)}</b>`},
    overheadPerPill: {title: 'Overhead Per Pill', body:()=> `Overhead per Pack / Weighted Pills per Pack.<br>${money3(C.ohPerPack)} / ${C.weightedPillsPerPack.toFixed(2)} = <b>${money3(C.overheadPerPill)}</b>`},
    po_summary_cost_pill: {title: 'Average Cost per Pill', body:()=> 'The average cost (COGS) per pill for this entire purchase order.'},
    po_summary_profit_pill: {title: 'Average Profit per Pill', body:()=> 'The average gross profit per pill for this entire purchase order.'},
    brev:{title:'Blended revenue/pack', body:()=> money3(C.priceR)+'×'+C.S.mixR+'% + '+money3(C.priceW)+'×'+C.S.mixW+'% + '+money3(C.priceD)+'×'+C.S.mixD+'% = <b>'+money3(C.brev)+'</b>'},
    bgpp:{title:'Blended GP/pack', body:()=> money3(C.gpR)+'×'+C.S.mixR+'% + '+money3(C.gpW)+'×'+C.S.mixW+'% + '+money3(C.gpD)+'×'+C.S.mixD+'% = <b>'+money3(C.bgpp)+'</b>'},
    bgmp:{title:'Blended GM%', body:()=> money3(C.bgpp)+' / '+money3(C.brev)+' = <b>'+pct(C.bgmp)+'</b>'},
    ohpp:{title:'Overhead / pack', body:()=> 'Total Monthly Overhead / Total Monthly Pack Volume<br>'+money(C.ohTotal)+' / '+C.S.monthlyVolume.toLocaleString()+' = <b>'+money3(C.ohPerPack)+'</b>'},
    bopp:{title:'Blended OP/pack', body:()=> money3(C.opR)+'×'+C.S.mixR+'% + '+money3(C.opW)+'×'+C.S.mixW+'% + '+money3(C.opD)+'×'+C.S.mixD+'% = <b>'+money3(C.bopp)+'</b>'},
    bomp:{title:'Blended OM%', body:()=> money3(C.bopp)+' / '+money3(C.brev)+' = <b>'+pct(C.bomp)+'</b>'},
    scenarios:{title:'Scenarios', body:()=> 'v6 storage with timestamps. Use Choose columns to define capture.'},
    comm:{title:'Sales commissions', body:()=> 'Per salesperson: select channels, choose commission type, add optional bonuses. Calculated for selected period.'},
    revR: {title:'Retail Revenue/pack', body:()=> 'This is the weighted average retail price per pack. = <b>'+money3(C.priceR)+'</b>'},
    retailerProfit: {title: 'Retailer Profit/pack', body:()=> 'The profit the retailer makes on a wholesale transaction.<br>'+money3(C.priceR)+' (Retail) - '+money3(C.priceW)+' (Wholesale Price) = <b>'+money3(C.retailerProfit)+'</b>'},
    distProfit: {title: 'Distributor Profit/pack', body:()=> 'The profit the distributor makes.<br>'+money3(C.priceW)+' (Wholesale) - '+money3(C.priceD)+' (Distributor Price) = <b>'+money3(C.distProfit)+'</b>'},
    shipCost: {title: 'Shipping Cost', body:()=> 'Cost to ship a single retail order.'},
    overhead: {title: 'Monthly Overhead', body:()=> 'Fixed monthly business costs (salaries, rent, etc.).'},
    oh_total_tip: {title: 'Overhead Allocation', body:()=> { const C = LATEST_CALC; const S = C.S; const activeChannels = [S.ohR && 'Retail', S.ohW && 'Wholesale', S.ohD && 'Distributor'].filter(Boolean); return `The total overhead of <b>${money(C.ohTotal)}</b> is split between <b>${activeChannels.length}</b> channels (${activeChannels.join(', ')}), allocating <b>${money(C.ohPerPack)}</b> per pack to each.`}},
    pills_input: {title: 'Input: Pills per pack', body:()=> 'Enter the number of pills in each retail pack.'},
    price_input: {title: 'Input: Retail price', body:()=> 'Enter the final consumer price for one pack.'},
    innerPkgCost_input: {title: 'Input: Inner Package Cost', body:()=> 'Cost of the primary container for the pills (e.g., bottle, blister pack).'},
    outerBoxCost_input: {title: 'Input: Outer Box Cost', body:()=> 'Cost of the branded retail box for a single pack.'},
    displayBoxCost_input: {title: 'Input: Display Box Cost', body:()=> 'Cost of the larger box used for retail display.'},
    packsPerDisplay_input: {title: 'Input: Packs per Display', body:()=> 'How many individual packs fit into one Display Box?'},
    shippingBoxCost_input: {title: 'Input: Shipping Box Cost', body:()=> 'Cost of the master carton used for shipping.'},
    packsPerShipBox_input: {title: 'Input: Packs per Shipping Box', body:()=> 'How many individual packs fit into one shipping box?'},
    mix_input: {title: 'Input: Mix %', body:()=> 'What percentage of sales comes from this channel?'},
    wDisc_input: {title: 'Input: Wholesale Discount %', body:()=> {
      const wDisc = num($('#wDisc').value);
      if (wDisc === 50) {
        return 'KEYSTONE PRICING';
      }
      return 'Discount off retail price for wholesale customers.';
    }},
    dDisc_input: {title: 'Input: Distributor Discount %', body:()=> 'Discount off WHOLESALE price for distributors.'},
    shipCost_input: {title: 'Input: Shipping per pack', body:()=> 'Enter the shipping cost for a single retail pack.'},
    monthlyVolume_sku_input: {title: 'Input: Monthly Volume for SKU', body:()=> `Enter the projected monthly sales volume for this specific SKU.`},
    monthlyVolume_total: {title: 'Total Monthly Volume', body:()=> `This is the sum of all individual SKU monthly volumes.`},
    ingName_input: {title: 'Input: Ingredient Name', body:()=> 'Name of the ingredient.'},
    ingMg_input: {title: 'Input: Milligrams per Pill', body:()=> 'How many milligrams of this ingredient are in one pill.'},
    ingUsdMg_input: {title: 'Input: Cost per Milligram', body:()=> 'The cost for one milligram of this ingredient.'},
    ohName_input: {title: 'Input: Overhead Item Name', body:()=> 'Name of the monthly overhead cost (e.g., Salaries).'},
    ohCost_input: {title: 'Input: Monthly Cost', body:()=> 'The total cost for this item per month.'},
    ch_retail: {title: 'Retail Channel', body:()=> 'Direct-to-consumer sales at full retail price.'},
    ch_wholesale: {title: 'Wholesale Channel', body:()=> 'Sales to retailers at a discounted price.'},
    ch_distributor: {title: 'Distributor Channel', body:()=> 'Sales to distributors at a secondary discount, calculated from the Wholesale Price.'},
    thirdParty_section: {title: 'Third Party Companies', body:()=> 'Model costs from various third-party service providers. Check the "Include" box for a company to add its costs to the total calculation.'},
    tp_monthly: {title: 'Total Monthly Cost', body:()=> 'The sum of all monthly costs from the "included" third-party companies.'},
    tp_weekly: {title: 'Total Weekly Cost', body:()=> 'The total monthly cost divided by 4.33 (average weeks in a month).'},
    tp_daily: {title: 'Total Daily Cost', body:()=> 'The total monthly cost divided by 30.44 (average days in a month).'},
    comm_section_main: {title: 'Sales Commission Hierarchy', body:()=> 'Model a four-tier commission structure from President down to Salesperson. Set overrides, assign personnel, and specify which channels apply at each level.'},
    comm_pres_tier: {title: 'President of Sales', body:()=> 'The top-level executive. Earns an override based on the performance of all VPs (and their teams) that are checked to be included.'},
    comm_vp_tier: {title: 'VPs of Sales', body:()=> 'Add one or more VPs. They earn an override based on the channel-specific performance of salespersons assigned to them. Check the box on their card to include their entire team in the President\'s override.'},
    comm_rsm_tier: {title: 'Regional Sales Managers (RSMs)', body:()=> 'Add one or more RSMs and assign them to a VP. They earn an override based on the performance of their assigned salespersons across the channels specified for the RSM.'},
    comm_sp_tier: {title: 'Salespersons', body:()=> 'The front-line sales team. Assign each salesperson to an RSM. Then, for each sales channel (Retail, Wholesale, Distributor), assign that channel\'s performance to a specific VP. This allows a single rep\'s sales to be split across multiple VPs.'},
    comm_name: {title: 'Name', body:()=> 'Enter the name for this individual.'},
    comm_type: {title: 'Commission Type', body:()=> 'Select how the commission or override is calculated. "% of Gross Revenue" is based on the top-line sales price. "$ per Pack Sold" is a fixed amount for each unit sold.'},
    comm_val: {title: 'Commission Value', body:()=> 'Enter the percentage (e.g., 5 for 5%) or dollar amount (e.g., 1.50 for $1.50) for the commission.'},
    comm_channels: {title: 'Applicable Channels', body:()=> 'Select the sales channels that this person\'s commission or override applies to. Only performance from checked channels will be included in their calculation.'},
    comm_assign_vp: {title: 'Assign to VP', body:()=> 'Assign this RSM to a specific VP. The performance of this RSM and their entire team will roll up to the selected VP.'},
    comm_assign_rsm: {title: 'Assign to RSM', body:()=> 'Assign this salesperson to a specific RSM.'},
    comm_include_pres: {title: 'Include in President\'s Override', body:()=> 'Check this box to include this VP and their entire hierarchy (all their RSMs and salespersons) in the President of Sales\' override calculation.'},
    comm_channel_assign_vp: {title: 'Assign Channel to VP', body:()=> 'For this specific sales channel (e.g., Retail), select which VP will receive the credit for this salesperson\'s performance. This allows splitting a single rep\'s performance across different VPs based on the channel.'},
    comm_bonuses: {title: 'Target Bonuses', body:()=> 'Add performance-based bonuses. Select a metric (Units, Revenue, or Profit), set a threshold, and define the bonus amount paid when the threshold is met.'},
    be_section: {title: 'Break-Even Analysis', body:()=> `Calculates the units needed to cover fixed costs. A "Pack" is the base retail unit, containing ${C.weightedPillsPerPack.toFixed(2)} pills on average. A "WHOLESALE master pack" = 100 packs. A "MASTER DISTRIBUTOR PACK" = 5000 packs.`},
    be_retail: {title: 'Retail Break-Even', body:()=> `${beFixedCosts} / Retail Operating Profit per Pack`},
    be_wholesale: {title: 'Wholesale Break-Even', body:()=> `${beFixedCosts} / Wholesale Operating Profit per Pack`},
    be_distributor: {title: 'Distributor Break-Even', body:()=> `${beFixedCosts} / Distributor Operating Profit per Pack`},
    be_blended: {title: 'Blended Break-Even', body:()=> `${beFixedCosts} / Blended Operating Profit per Pack`},
    po_section: {title: 'Purchase Orders', body:()=> 'Calculates total cost and profit for the entire order specified in the "Order Composition" section.'},
    orderComp: {title: 'Order Composition', body:()=> 'Specify quantities for each SKU. This order mix drives all calculations in the sheet.'},
    orderQty_input: {title: 'Input: Order Quantity', body:()=> 'Enter the number of packs for this SKU in the order.'},
    sku: {title: 'SKU', body:()=> 'Stock Keeping Unit. The name is dynamically generated from the "Pills per pack" value.'},
    po_summary_gp: {title: 'Total Gross Profit from Order', body:()=> 'The total profit from this specific order before considering fixed monthly overhead costs.'},
    po_summary_oh: {title: 'Total Monthly Overhead', body:()=> 'The total fixed monthly costs for the business (e.g., rent, salaries).'},
    po_summary_net: {title: 'Net Impact on Monthly Profit', body:()=> `This shows how much this single order contributes to covering the fixed monthly costs.<br><b>${money(poTotals.retail.totalProfit)}</b> (Gross Profit) - <b>${money(C.ohTotal)}</b> (Monthly Overhead) = <b>${money(poTotals.retail.totalProfit - C.ohTotal)}</b>`}
  };
  ALL_COLUMNS.forEach(col => {
    tips[`col_tip_${col.key}`] = { title: col.label, body: () => col.tooltip };
  });
  Object.assign(tooltips, tips);
}
function updateChannelStates() {
    const channels = [
        { id: 'R', card: $('#mixR').closest('.card'), checkbox: $('#includeR'), mixInput: $('#mixR') },
        { id: 'W', card: $('#mixW').closest('.card'), checkbox: $('#includeW'), mixInput: $('#mixW') },
        { id: 'D', card: $('#mixD').closest('.card'), checkbox: $('#includeD'), mixInput: $('#mixD') }
    ];
    channels.forEach(ch => {
        const isEnabled = ch.checkbox.checked;
        ch.card.style.opacity = isEnabled ? '1' : '0.6';
        ch.card.querySelectorAll('input, select').forEach(input => {
            if (input.type !== 'checkbox') {
                 input.disabled = !isEnabled;
            }
        });
        if (!isEnabled) {
            ch.mixInput.value = 0;
        }
    });
}
function enforceMix(changedId) {
    if (!$('#autoMix').checked) return;
    const channels = [
        { id: 'R', checkbox: $('#includeR'), mixInput: $('#mixR') },
        { id: 'W', checkbox: $('#includeW'), mixInput: $('#mixW') },
        { id: 'D', checkbox: $('#includeD'), mixInput: $('#mixD') }
    ];
    const activeChannels = channels.filter(ch => ch.checkbox.checked);
    if (activeChannels.length === 0) {
        channels.forEach(ch => ch.mixInput.value = 0);
        if ($('#autoCalc').checked) render();
        return;
    }
    const changedChannel = activeChannels.find(ch => ch.mixInput.id === changedId);
    if (changedChannel) {
        let val = Math.max(0, Math.min(100, num(changedChannel.mixInput.value)));
        changedChannel.mixInput.value = val;
        const otherActiveChannels = activeChannels.filter(ch => ch.mixInput.id !== changedId);
        if (otherActiveChannels.length > 0) {
            const rem = 100 - val;
            const split = rem / otherActiveChannels.length;
            otherActiveChannels.forEach(ch => ch.mixInput.value = split.toFixed(1));
        } else {
             changedChannel.mixInput.value = 100;
        }
    } else {
        const split = 100 / activeChannels.length;
        activeChannels.forEach(ch => ch.mixInput.value = split.toFixed(1));
    }
    const finalTotal = activeChannels.reduce((sum, ch) => sum + num(ch.mixInput.value), 0);
    const diff = 100 - finalTotal;
    if (diff.toFixed(1) != 0.0 && activeChannels.length > 0) {
        activeChannels[0].mixInput.value = (num(activeChannels[0].mixInput.value) + diff).toFixed(1);
    }
    if ($('#autoCalc').checked) render();
}
// ===== Scenarios (v6) + captures + migration =====
const LS_KEY='channel_calc_scenarios_v6';
const OLD_KEYS=['channel_calc_scenarios_v3','channel_calc_scenarios_v5'];
let CAPTURES={ '__full__': [] };
const ALL_COLUMNS = [
  {key:'savedAt', label:'Saved', tooltip: 'The date the scenario was saved.'},
  {key:'label', label:'Label', tooltip: 'A custom name for the scenario.'},
  {key:'lastCalculatedAt', label:'Last Calculated At', tooltip: 'The last time the calculations were run for this scenario.'},
  {key:'pills', label:'Pills', tooltip: 'Number of pills per pack.'},
  {key:'retailPrice', label:'Retail Price', tooltip: 'The selling price to the end customer.'},
  {key:'packsPerDisplay', label:'Packs per Display', tooltip: 'Number of packs in a shipping display.'},
  {key:'ingPerPack', label:'Ingredients / pack', tooltip: 'Total cost of ingredients for one pack.'},
  {key:'packPerPack', label:'Packaging / pack', tooltip: 'Total cost of packaging for one pack.'},
  {key:'dispPerPack', label:'Display / pack', tooltip: 'Amortized cost of the display per pack.'},
  {key:'cogs', label:'Total COGS', tooltip: 'Total Cost of Goods Sold per pack.'},
  {key:'ohPerPack', label:'Overhead / pack', tooltip: 'Amortized monthly overhead cost per pack.'},
  {key:'shipPerPack', label:'Shipping / pack', tooltip: 'Amortized shipping cost per pack for retail orders.'},
  {key:'wDisc', label:'Wholesale Discount %', tooltip: 'Discount percentage for wholesale channel.'},
  {key:'dDisc', label:'Distributor Discount %', tooltip: 'Discount percentage for distributor channel.'},
  {key:'mixR', label:'Mix Retail %', tooltip: 'Percentage of sales from the retail channel.'},
  {key:'mixW', label:'Mix Wholesale %', tooltip: 'Percentage of sales from the wholesale channel.'},
  {key:'mixD', label:'Mix Distributor %', tooltip: 'Percentage of sales from the distributor channel.'},
  {key:'gmR', label:'Gross Margin % Retail', tooltip: 'Gross Margin percentage for the retail channel.'},
  {key:'gmW', label:'Gross Margin % Wholesale', tooltip: 'Gross Margin percentage for the wholesale channel.'},
  {key:'gmD', label:'Gross Margin % Distributor', tooltip: 'Gross Margin percentage for the distributor channel.'},
  {key:'omR', label:'Operating Margin % Retail', tooltip: 'Operating Margin percentage for the retail channel.'},
  {key:'omW', label:'Operating Margin % Wholesale', tooltip: 'Operating Margin percentage for the wholesale channel.'},
  {key:'omD', label:'Operating Margin % Distributor', tooltip: 'Operating Margin percentage for the distributor channel.'},
  {key:'brev', label:'Blended Revenue/Pack', tooltip: 'Blended revenue per pack across all active channels.'},
  {key:'bgpp', label:'Blended Gross Profit/Pack', tooltip: 'Blended gross profit per pack across all active channels.'},
  {key:'bgmp', label:'Blended Gross Margin %', tooltip: 'Blended gross margin percentage across all active channels.'},
  {key:'bopp', label:'Blended Operating Profit/Pack', tooltip: 'Blended operating profit per pack across all active channels.'},
  {key:'bomp', label:'Blended Operating Margin %', tooltip: 'Blended operating margin percentage across all active channels.'},
  {key:'salespersonCount', label:'Salesperson Count', tooltip: 'Total number of salespersons.'},
  {key:'totalComm', label:'Total Commissions', tooltip: 'Total commissions paid for the projection period.'},
  {key:'totalBonus', label:'Total Bonuses', tooltip: 'Total bonuses paid for the projection period.'},
  {key:'commPctGross', label:'Commission % of Revenue', tooltip: 'Total commissions as a percentage of total revenue.'},
  {key:'commPctOp', label:'Commission % of Operating Profit', tooltip: 'Total commissions as a percentage of operating profit.'},
  {key:'totalRevenue', label:'Total Revenue', tooltip: 'Total projected revenue for the period.'},
  {key:'totalOpProfit', label:'Blended OP Profit', tooltip: 'Total projected operating profit for the period.'},
  {key:'anonymous', label:'Anonymous', tooltip: 'Placeholder for user data.'},
  {key:'if', label:'IF', tooltip: 'Placeholder for conditional logic.'},
  {key:'load', label:'Load', tooltip: 'Load this scenario\'s inputs.'}
];
const SCENARIO_TABLE_KEYS = ALL_COLUMNS.map(c => c.key).filter(k => k !== 'load');
function ensureFullCapture(){ CAPTURES['__full__'] = ALL_COLUMNS.map(c=>c.key) }
function currentCaptureKeys(){ const sel=$('#capture_sel').value; return CAPTURES[sel]||ALL_COLUMNS.map(c=>c.key) }
function drawScenarioTableHeaders(){ const head=$('#scenarios_head'); head.innerHTML=''; const tr=document.createElement('tr'); SCENARIO_TABLE_KEYS.forEach(key=>{ const colInfo = ALL_COLUMNS.find(c => c.key === key); const th=document.createElement('th'); th.textContent=colInfo.label; tr.appendChild(th) }); const th=document.createElement('th'); th.textContent='Load'; tr.appendChild(th); head.appendChild(tr) }
function loadScenarios(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]') }catch(e){ return [] } }
function saveScenarios(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)) }
function migrateOld(){ /* Migration logic can be re-added if needed */ }
function scenarioFromCurrent(C){
  const S=C.S;
  const row={};
  row.savedAt = new Date().toLocaleDateString();
  row.label = ($('#scenario_label').value||'').trim();
  row.retailPrice=money(C.weightedRetailPrice);
  row.cogs=money(C.cogs);
  row.brev=money(C.brev);
  row.bopp=money(C.bopp);
  row.totalRevenue = money(C.commissionResults?.totalRevenue || 0);
  row.commPctGross = pct(C.commissionResults?.commPctGross || 0);
  row.totalOpProfit = money(C.commissionResults?.totalOpProfit || 0);
  row.anonymous = 'Anonymous';
  row.if = 'IF';
  row.__inputs={ skus:S.skus, order:S.order, wDisc:S.wDisc, dDisc:S.dDisc, mixR:S.mixR, mixW:S.mixW, mixD:S.mixD, monthlyVolume:S.monthlyVolume, includeShip:S.includeShip, shippingPerPack:S.shippingPerPack, oh: S.oh };
  return row
}
function drawScenarioRows(){
  const body=$('#scenarios_body');
  body.innerHTML='';
  const list=loadScenarios();
  list.forEach((r)=>{
    const tr=document.createElement('tr');
    SCENARIO_TABLE_KEYS.forEach(key=>{
      const td=document.createElement('td');
      td.textContent = r[key] ?? '—';
      tr.appendChild(td)
    });
    const td=document.createElement('td');
    const btn=document.createElement('button');
    btn.className='btn small';
    btn.textContent='Load';
    btn.onclick=()=> restoreScenario(r.__inputs||{});
    td.appendChild(btn);
    tr.appendChild(td);
    body.appendChild(tr)
  })
}
function restoreScenario(inputs){
  $('#skuRows').innerHTML = '';
  (inputs.skus || [
    {sku:'3-pack', pills:3, price:21.95, innerPkg:1.50, outerBox:1.75, displayBox:0, packsPerDisplay:1, shippingBox:1.5, packsPerShipBox:1}
  ]).forEach(s => $('#skuRows').appendChild(makeSkuRow({
    sku: s.sku,
    pills: s.pills,
    price: s.retailPrice,
    innerPkg: s.innerPkgCost,
    outerBox: s.outerBoxCost,
    displayBox: s.displayBoxCost,
    packsPerDisplay: s.packsPerDisplay,
    shippingBox: s.shippingBoxCost,
    packsPerShipBox: s.packsPerShipBox
  })));
  updateOrderComposition();
  $$('#orderComposition .card').forEach(card => {
    const skuName = card.querySelector('label').textContent.replace('SKU: ', '');
    const orderItem = (inputs.order || []).find(o => o.sku === skuName);
    if (orderItem) {
        card.querySelector('.orderQty').value = orderItem.qty;
    }
  });
  if(inputs.wDisc!=null) $('#wDisc').value=inputs.wDisc;
  if(inputs.dDisc!=null) $('#dDisc').value=inputs.dDisc;
  if(inputs.mixR!=null) $('#mixR').value=inputs.mixR;
  if(inputs.mixW!=null) $('#mixW').value=inputs.mixW;
  if(inputs.mixD!=null) $('#mixD').value=inputs.mixD;
  
  // Restore monthly volumes
  updateMonthlyVolumeInputs(); // Make sure the inputs exist
  $$('#monthlyVolumePerSku .card').forEach(card => {
    const skuName = card.querySelector('label').textContent.replace('SKU: ', '');
    const volumeItem = (inputs.monthlyVolumes || []).find(v => v.sku === skuName);
    if (volumeItem) {
        card.querySelector('.monthlyVolumeSku').value = volumeItem.qty;
    }
  });

  if(inputs.includeShip!=null) $('#includeShip').checked=!!inputs.includeShip;
  if(inputs.shippingPerPack!=null) $('#shippingPerPack').value=inputs.shippingPerPack;

  // Restore dynamic rows
  $('#oh_rows').innerHTML = '';
  if(inputs.oh) inputs.oh.forEach((cost, i) => $('#oh_rows').appendChild(makeOhRow(`Overhead ${i+1}`, cost)));

  render();
}
function onSaveScenario(){ const C=calc(); const row=scenarioFromCurrent(C); const list=loadScenarios(); list.unshift(row); saveScenarios(list); drawScenarioRows() }
function toCSV(){ const list=loadScenarios(); if(!list.length){ alert('No scenarios saved.'); return } const keys=SCENARIO_TABLE_KEYS.filter(c=>c !== 'load'); const header=keys.map(k => (ALL_COLUMNS.find(c=>c.key===k) || {}).label).join(','); const rows=list.map(r=> keys.map(k=> (r[k]??'').toString().replace(/\"/g,'""')).map(x=>'"'+x+'"').join(',')); const csv=[header, ...rows].join('\n'); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='scenarios.csv'; a.click(); URL.revokeObjectURL(url) }
// Capture modal
const GROUPS = {
  'Meta': ['savedAt','label','lastCalculatedAt'],
  'Product': ['pills','retailPrice','packsPerDisplay'],
  'Costs': ['ingPerPack','packPerPack','dispPerPack','cogs','ohPerPack','shipPerPack'],
  'Channels': ['wDisc','dDisc','mixR','mixW','mixD','gmR','gmW','gmD','omR','omW','omD'],
  'Blended': ['brev','bgpp','bgmp','bopp','bomp'],
  'Commissions': ['salespersonCount','totalComm','totalBonus','commPctGross','commPctOp']
};
function openCaptureModal(){
  wireTips(calc()); // Ensure tooltips are populated
  const host=$('#cols_groups');
  host.innerHTML='';
  for(const [group,keys] of Object.entries(GROUPS)){
    const card=document.createElement('div');
    card.className='card';
    const h=document.createElement('div');
    h.innerHTML='<strong>'+group+'</strong>';
    card.appendChild(h);
    keys.forEach(k=>{
      const c=document.createElement('div');
      c.className='row';
      const id='col_'+k;
      const colInfo = ALL_COLUMNS.find(x=>x.key===k) || {label: k, tooltip: ''};
      c.innerHTML = `<label class="row" style="justify-content:flex-start" data-tip="col_tip_${k}"><input id="${id}" type="checkbox" checked> ${colInfo.label}</label>`;
      card.appendChild(c);
    });
    host.appendChild(card);
  }
  $('#modal').style.display='flex';
}
function saveCapture(){ const name = ($('#cap_name').value||'').trim() || 'Custom capture'; const keys=[]; Object.values(GROUPS).flat().forEach(k=>{ if($('#col_'+k).checked) keys.push(k) }); CAPTURES[name]=keys; const opt=document.createElement('option'); opt.value=name; opt.textContent=name; $('#capture_sel').appendChild(opt); $('#capture_sel').value=name; $('#modal').style.display='none' }
// ===== START: Third Party Section Logic =====
const thirdPartyData = {
    "Sales Company": [
        "Sales Strategy Development", "Territory & Channel Mapping", "Prospecting & Lead Generation", "CRM Setup & Management", "Pipeline Management", "Sales Collateral Creation", "Sales Training & Coaching", "Sales Call Execution", "Trade Show Representation", "Distributor & Retailer Outreach", "Key Account Management", "Sales Order Processing", "Negotiation & Contract Closing", "Commission on Sales", "Sales Performance Reporting", "Wholesale Account Setup Fees", "Retail Buyer Introductions", "Customer Relationship Mgmt", "Merchandising & Display Setup", "Sampling & Demo Programs", "Incentive Program Mgmt", "Channel Conflict Resolution", "Market Feedback Reporting", "Sales Forecasting", "Customer Onboarding & Education"
    ],
    "Operations Company": [
        "Operations Strategy Development", "SOP Creation & Documentation", "Workflow Optimization", "Process Automation & Tech", "KPI Dashboard Setup", "Supply Chain Management", "Vendor Contract Negotiation", "Inventory Oversight", "Freight & Shipping Coordination", "Procurement & Purchasing", "Quality Control Audits", "Risk & Compliance Oversight", "Facility & Equipment Management", "Workforce Scheduling", "Safety & OSHA Programs", "Lean / Cost Reduction", "Returns & Reverse Logistics", "ERP/CRM/WMS Integration", "Customer Service Oversight", "Performance Tracking Reports", "Multi-Channel Ops Alignment", "Training & Onboarding", "IT Infrastructure Support", "Project Management Services", "Crisis & Contingency Planning"
    ],
    "Fulfillment Company": [
        "Inbound Receiving Fees", "SKU Setup Fees", "Quality Control on Receipt", "Pallet Breakdown / Sorting", "Storage Fees (pallet/bin)", "Climate-Controlled Storage", "Long-Term Storage Fees", "Pick Fees (per item)", "Pack Fees (per order)", "Packaging Materials", "Custom Packaging / Branded Boxes", "Kitting & Assembly", "Shipping Label Fees", "Carrier Postage (pass-through)", "Freight Coordination (LTL/FTL)", "International Shipping Docs", "Returns Processing Fees", "Rework / Relabeling", "Lot & Expiration Tracking", "Subscription Box Assembly", "Account Management Fee", "Tech Integration Fee", "Inventory Cycle Counting", "Disposal / Liquidation Fees", "Rush Order / Priority Handling"
    ],
    "Business Management Company": [
        "Business Strategy Development", "Market & Channel Planning", "Fractional CEO/COO Advisory", "OKRs & Roadmap Development", "Financial Modeling & Forecasting", "Budget Development & Oversight", "Profitability & Margin Analysis", "Fundraising & Investor Support", "Governance & Board Reporting", "Risk & Compliance Oversight", "Contract & Legal Coordination", "Licensing & Regulatory Filing", "Vendor Oversight & Coordination", "Cross-System Integration", "HR & Org Design", "Compensation & Incentive Planning", "Executive Recruiting Support", "Performance Management Systems", "Capital Allocation Strategy", "Strategic Partnership Dev.", "Channel Performance Reviews", "Quarterly Business Reviews", "KPI Dashboard Reporting", "Scenario Planning & Stress Tests", "Crisis & Contingency Mgmt"
    ],
    "Marketing Company": [
        "Marketing Strategy Development", "Brand Identity & Guidelines", "Logo & Visual Design", "Content Writing (blogs, copy)", "Photography (product, lifestyle)", "Video Production", "Graphic Design (ads, infographics)", "Paid Media Management", "Ad Spend (pass-through)", "Conversion Rate Optimization", "Website & Landing Page Design", "Search Engine Optimization (SEO)", "Social Media Management", "Influencer & Affiliate Mgmt", "Email Marketing Campaigns", "Marketing Automation (HubSpot, etc.)", "PR & Media Outreach", "Event Marketing (launch, pop-ups)", "Sponsorship Management", "Analytics Dashboards & Reporting", "Customer Segmentation & Personas", "Market Research & Competitor Analysis", "Product Launch Campaigns", "Creative Direction (tone/look/feel)", "Crisis Communication & Reputation"
    ]
};
function buildThirdPartySection() {
    const container = $('#thirdPartyCompaniesContainer');
    container.innerHTML = '';
    for (const [company, items] of Object.entries(thirdPartyData)) {
        const details = document.createElement('details');
        const companyId = company.replace(/\s+/g, '-');
        let tableRows = items.map((item, index) => `
            <tr>
                <td>${index + 1}</td>
                <td>${item}</td>
                <td><input type="number" class="tp-cost" value="0.00" step="0.01" data-company="${companyId}"></td>
            </tr>
        `).join('');
        details.innerHTML = `
            <summary>
                <span>${company}</span>
                <label class="row" onclick="event.stopPropagation()">
                    <input type="checkbox" class="tp-include" id="include-${companyId}">
                    Include in calculations
                </label>
            </summary>
            <div class="company-content">
                <div class="scroller" style="max-height:300px; overflow:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px;">#</th>
                                <th>Line Item</th>
                                <th style="width:120px;">Cost ($)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        container.appendChild(details);
    }
}
function calculateThirdPartyCosts() {
    let totalMonthlyCost = 0;
    const companies = Object.keys(thirdPartyData);
    companies.forEach(company => {
        const companyId = company.replace(/\s+/g, '-');
        const includeCheckbox = $(`#include-${companyId}`);
        if (includeCheckbox && includeCheckbox.checked) {
            const costInputs = $$(`.tp-cost[data-company="${companyId}"]`);
            costInputs.forEach(input => {
                totalMonthlyCost += num(input.value);
            });
        }
    });
    const weeklyCost = totalMonthlyCost / 4.33; // Average weeks in a month
    const dailyCost = totalMonthlyCost / 30.44; // Average days in a month
    $('#tp_monthly_cost').textContent = money(totalMonthlyCost);
    $('#tp_weekly_cost').textContent = money(weeklyCost);
    $('#tp_daily_cost').textContent = money(dailyCost);
}
function wireThirdPartyEvents() {
    const container = $('#thirdPartySection');
    container.addEventListener('input', (e) => {
        if (e.target.classList.contains('tp-cost') || e.target.classList.contains('tp-include')) {
            calculateThirdPartyCosts();
        }
    });
     container.addEventListener('change', (e) => {
        if (e.target.classList.contains('tp-include')) {
            calculateThirdPartyCosts();
        }
    });
}
// ===== END: Third Party Section Logic =====
// ===== START: Commission Hierarchy Logic =====
let nextId = 0;
const getUID = () => nextId++;
function createPresidentCard() {
    const card = document.createElement('div');
    card.dataset.id = getUID();
    card.innerHTML = `
        <div class="row"><input type="text" class="comm-name w-160" placeholder="President's Name" value="President of Sales" data-tip="comm_name"></div>
        <div class="row" data-tip="comm_channels"><label class="row"><input class="comm-chR" type="checkbox" checked> Retail</label><label class="row"><input class="comm-chW" type="checkbox" checked> Wholesale</label><label class="row"><input class="comm-chD" type="checkbox" checked> Distributor</label></div>
        <div class="grid-2"><div><label>Override type</label><select class="comm-type w-160" data-tip="comm_type"><option value="pctGrossRev">% of Gross Revenue</option><option value="perPack">$ per Pack Sold</option></select></div><div><label>Override value</label><input class="comm-val w-120" type="number" step="0.01" value="0.5" data-tip="comm_val"></div></div>
    `;
    return card;
}
function createVPCard() {
    const card = document.createElement('div');
    card.dataset.id = getUID();
    card.innerHTML = `
        <div class="row" style="justify-content: space-between;">
            <input type="text" class="comm-name w-160" placeholder="VP Name" value="VP ${card.dataset.id}" data-tip="comm_name">
            <button class="btn small rm-vp">Remove VP</button>
        </div>
        <div class="row" data-tip="comm_channels"><label class="row"><input class="comm-chR" type="checkbox" checked> Retail</label><label class="row"><input class="comm-chW" type="checkbox" checked> Wholesale</label><label class="row"><input class="comm-chD" type="checkbox" checked> Distributor</label></div>
        <div class="grid-2"><div><label>Override type</label><select class="comm-type w-160" data-tip="comm_type"><option value="pctGrossRev">% of Gross Revenue</option><option value="perPack">$ per Pack Sold</option></select></div><div><label>Override value</label><input class="comm-val w-120" type="number" step="0.01" value="1" data-tip="comm_val"></div></div>
        <label class="row"><input type="checkbox" class="comm-include-pres" checked data-tip="comm_include_pres"> Include in President's Override</label>
    `;
    card.querySelector('.rm-vp').onclick = () => { card.remove(); updateAllDropdowns(); if($('#autoCalc').checked) render(); };
    return card;
}
function createRSMCard() {
    const card = document.createElement('div');
    card.dataset.id = getUID();
    card.innerHTML = `
        <div class="row" style="justify-content: space-between;">
            <input type="text" class="comm-name w-160" placeholder="RSM Name" value="RSM ${card.dataset.id}" data-tip="comm_name">
            <button class="btn small rm-rsm">Remove RSM</button>
        </div>
        <div class="row" data-tip="comm_channels"><label class="row"><input class="comm-chR" type="checkbox" checked> Retail</label><label class="row"><input class="comm-chW" type="checkbox" checked> Wholesale</label><label class="row"><input class="comm-chD" type="checkbox" checked> Distributor</label></div>
        <div class="grid-2"><div><label>Override type</label><select class="comm-type w-160" data-tip="comm_type"><option value="pctGrossRev">% of Gross Revenue</option><option value="perPack">$ per Pack Sold</option></select></div><div><label>Override value</label><input class="comm-val w-120" type="number" step="0.01" value="2" data-tip="comm_val"></div></div>
        <div><label>Assign to VP</label><select class="comm-assign-vp" data-tip="comm_assign_vp"><option value="">-- Unassigned --</option></select></div>
    `;
    card.querySelector('.rm-rsm').onclick = () => { card.remove(); updateAllDropdowns(); if($('#autoCalc').checked) render(); };
    return card;
}
function createSPCard() {
    const card = document.createElement('div');
    card.dataset.id = getUID();
    card.innerHTML = `
        <div class="row" style="justify-content: space-between;">
            <input type="text" class="comm-name w-160" placeholder="Salesperson Name" value="Rep ${card.dataset.id}" data-tip="comm_name">
            <button class="btn small rm-sp">Remove Salesperson</button>
        </div>
        <div class="row" data-tip="comm_channels"><label class="row"><input class="comm-chR" type="checkbox" checked> Retail</label><label class="row"><input class="comm-chW" type="checkbox" checked> Wholesale</label><label class="row"><input class="comm-chD" type="checkbox" checked> Distributor</label></div>
        <div class="grid-2"><div><label>Commission type</label><select class="comm-type w-160" data-tip="comm_type"><option value="pctGrossRev">% of Gross Revenue</option><option value="perPack">$ per Pack Sold</option></select></div><div><label>Commission value</label><input class="comm-val w-120" type="number" step="0.01" value="5" data-tip="comm_val"></div></div>
        <div><label>Assign to RSM</label><select class="comm-assign-rsm" data-tip="comm_assign_rsm"><option value="">-- Unassigned --</option></select></div>
        <div class="divider"></div>
        <label>Channel VP Assignment</label>
        <div class="grid-3">
            <div><label>Retail</label><select class="comm-ch-assign-vp-r" data-tip="comm_channel_assign_vp"><option value="">-- None --</option></select></div>
            <div><label>Wholesale</label><select class="comm-ch-assign-vp-w" data-tip="comm_channel_assign_vp"><option value="">-- None --</option></select></div>
            <div><label>Distributor</label><select class="comm-ch-assign-vp-d" data-tip="comm_channel_assign_vp"><option value="">-- None --</option></select></div>
        </div>
        <div class="divider"></div>
        <div><label>Target Bonuses</label><div class="comm-bonuses"></div><button class="btn small add-bonus">Add Bonus</button></div>
    `;
    card.querySelector('.rm-sp').onclick = () => { card.remove(); if($('#autoCalc').checked) render(); };
    card.querySelector('.add-bonus').onclick = () => {
        const r = document.createElement('div');
        r.className = 'row';
        r.innerHTML = '<select class="w-160 bMetric" data-tip="bMetric_input"><option value="units">Units Sold</option><option value="grossRev">Gross Revenue</option><option value="grossProfit">Gross Profit</option></select> <input class="w-120 bThresh" type="number" step="0.01" placeholder="Threshold" data-tip="bThresh_input"> <input class="w-120 bAmt" type="number" step="0.01" placeholder="Bonus (USD)" data-tip="bAmt_input"> <button class="btn small rm-bonus">X</button>';
        r.querySelector('.rm-bonus').onclick = () => r.remove();
        card.querySelector('.comm-bonuses').appendChild(r);
    };
    return card;
}
function updateAllDropdowns() {
    const vps = Array.from($$('#vps_container .card')).map(c => ({ id: c.dataset.id, name: c.querySelector('.comm-name').value }));
    const rsms = Array.from($$('#rsms_container .card')).map(c => ({ id: c.dataset.id, name: c.querySelector('.comm-name').value }));
    // Update RSM 'Assign to VP' dropdowns
    $$('.comm-assign-vp').forEach(sel => {
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">-- Unassigned --</option>';
        vps.forEach(vp => sel.innerHTML += `<option value="${vp.id}">${vp.name}</option>`);
        sel.value = currentVal;
    });
    // Update SP 'Assign to RSM' dropdowns
    $$('.comm-assign-rsm').forEach(sel => {
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">-- Unassigned --</option>';
        rsms.forEach(rsm => sel.innerHTML += `<option value="${rsm.id}">${rsm.name}</option>`);
        sel.value = currentVal;
    });
    // Update SP 'Channel VP Assignment' dropdowns
    ['r', 'w', 'd'].forEach(ch => {
        $$(`.comm-ch-assign-vp-${ch}`).forEach(sel => {
            const currentVal = sel.value;
            sel.innerHTML = '<option value="">-- None --</option>';
            vps.forEach(vp => sel.innerHTML += `<option value="${vp.id}">${vp.name}</option>`);
            sel.value = currentVal;
        });
    });
}
function getCommissionState() {
    const president = $('#president_card');
    const state = {
        president: {
            id: president.dataset.id,
            name: president.querySelector('.comm-name').value,
            type: president.querySelector('.comm-type').value,
            val: num(president.querySelector('.comm-val').value),
            chR: president.querySelector('.comm-chR').checked,
            chW: president.querySelector('.comm-chW').checked,
            chD: president.querySelector('.comm-chD').checked,
        },
        vps: [],
        rsms: [],
        sps: [],
    };
    $$('#vps_container .card').forEach(c => {
        state.vps.push({
            id: c.dataset.id,
            name: c.querySelector('.comm-name').value,
            type: c.querySelector('.comm-type').value,
            val: num(c.querySelector('.comm-val').value),
            chR: c.querySelector('.comm-chR').checked,
            chW: c.querySelector('.comm-chW').checked,
            chD: c.querySelector('.comm-chD').checked,
            includePres: c.querySelector('.comm-include-pres').checked,
        });
    });
    $$('#rsms_container .card').forEach(c => {
        state.rsms.push({
            id: c.dataset.id,
            name: c.querySelector('.comm-name').value,
            type: c.querySelector('.comm-type').value,
            val: num(c.querySelector('.comm-val').value),
            chR: c.querySelector('.comm-chR').checked,
            chW: c.querySelector('.comm-chW').checked,
            chD: c.querySelector('.comm-chD').checked,
            assignedVP: c.querySelector('.comm-assign-vp').value,
        });
    });
    $$('#sps_container .card').forEach(c => {
        state.sps.push({
            id: c.dataset.id,
            name: c.querySelector('.comm-name').value,
            type: c.querySelector('.comm-type').value,
            val: num(c.querySelector('.comm-val').value),
            chR: c.querySelector('.comm-chR').checked,
            chW: c.querySelector('.comm-chW').checked,
            chD: c.querySelector('.comm-chD').checked,
            assignedRSM: c.querySelector('.comm-assign-rsm').value,
            assignedVp_R: c.querySelector('.comm-ch-assign-vp-r').value,
            assignedVp_W: c.querySelector('.comm-ch-assign-vp-w').value,
            assignedVp_D: c.querySelector('.comm-ch-assign-vp-d').value,
            bonuses: Array.from(c.querySelectorAll('.comm-bonuses .row')).map(r => ({
                metric: r.querySelector('.bMetric').value,
                thresh: num(r.querySelector('.bThresh').value),
                amt: num(r.querySelector('.bAmt').value)
            }))
        });
    });
    return state;
}
function calculateAllCommissions(S, C) {
    const commState = getCommissionState();

    const periodSel = $('#projPeriod').value;
    const mult = periodSel === 'Daily' ? 1/30.44 : periodSel === 'Weekly' ? 1/4.33 : periodSel === 'Yearly' ? 12 : 1;
    const vol = S.monthlyVolume * mult;

    const vR = vol * (S.mixR / 100);
    const vW = vol * (S.mixW / 100);
    const vD = vol * (S.mixD / 100);
    const perf = {
        R: { vol: vR, rev: vR * C.priceR, gp: vR * C.gpR },
        W: { vol: vW, rev: vW * C.priceW, gp: vW * C.gpW },
        D: { vol: vD, rev: vD * C.priceD, gp: vD * C.gpD },
    };
    // 1. Calculate base pay for Salespersons
    commState.sps.forEach(sp => {
        let base = 0, units = 0, grossRev = 0, grossProfit = 0;
        if (sp.chR) { units += perf.R.vol; grossRev += perf.R.rev; grossProfit += perf.R.gp; }
        if (sp.chW) { units += perf.W.vol; grossRev += perf.W.rev; grossProfit += perf.W.gp; }
        if (sp.chD) { units += perf.D.vol; grossRev += perf.D.rev; grossProfit += perf.D.gp; }

        if (sp.type === 'pctGrossRev') base = grossRev * (sp.val / 100);
        else if (sp.type === 'perPack') base = units * sp.val;

        let bonus = 0;
        sp.bonuses.forEach(b => {
            const metricVal = b.metric === 'units' ? units : b.metric === 'grossRev' ? grossRev : grossProfit;
            if (metricVal >= b.thresh) bonus += b.amt;
        });
        sp.basePay = base;
        sp.bonusPay = bonus;
        sp.totalPay = base + bonus;
    });
    // 2. Calculate overrides for RSMs
    commState.rsms.forEach(rsm => {
        let units = 0, grossRev = 0, grossProfit = 0;
        commState.sps.filter(sp => sp.assignedRSM === rsm.id).forEach(sp => {
            if (rsm.chR) { units += perf.R.vol; grossRev += perf.R.rev; grossProfit += perf.R.gp; }
            if (rsm.chW) { units += perf.W.vol; grossRev += perf.W.rev; grossProfit += perf.W.gp; }
            if (rsm.chD) { units += perf.D.vol; grossRev += perf.D.rev; grossProfit += perf.D.gp; }
        });
        let override = 0;
        if (rsm.type === 'pctGrossRev') override = grossRev * (rsm.val / 100);
        else if (rsm.type === 'perPack') override = units * rsm.val;
        rsm.overridePay = override;
        rsm.totalPay = override;
    });
    // 3. Calculate overrides for VPs
    commState.vps.forEach(vp => {
        let units = 0, grossRev = 0, grossProfit = 0;
        commState.sps.forEach(sp => {
            if (vp.chR && sp.assignedVp_R === vp.id) { units += perf.R.vol; grossRev += perf.R.rev; grossProfit += perf.R.gp; }
            if (vp.chW && sp.assignedVp_W === vp.id) { units += perf.W.vol; grossRev += perf.W.rev; grossProfit += perf.W.gp; }
            if (vp.chD && sp.assignedVp_D === vp.id) { units += perf.D.vol; grossRev += perf.D.rev; grossProfit += perf.D.gp; }
        });
        let override = 0;
        if (vp.type === 'pctGrossRev') override = grossRev * (vp.val / 100);
        else if (vp.type === 'perPack') override = units * vp.val;
        vp.overridePay = override;
        vp.totalPay = override;
    });
    // 4. Calculate override for President
    let pres_units = 0, pres_grossRev = 0, pres_grossProfit = 0;
    const includedVPs = commState.vps.filter(vp => vp.includePres).map(vp => vp.id);
    const includedRSMs = commState.rsms.filter(rsm => includedVPs.includes(rsm.assignedVP)).map(rsm => rsm.id);

    commState.sps.filter(sp => includedRSMs.includes(sp.assignedRSM)).forEach(sp => {
        if (commState.president.chR) { pres_units += perf.R.vol; pres_grossRev += perf.R.rev; pres_grossProfit += perf.R.gp; }
        if (commState.president.chW) { pres_units += perf.W.vol; pres_grossRev += perf.W.rev; pres_grossProfit += perf.W.gp; }
        if (commState.president.chD) { pres_units += perf.D.vol; pres_grossRev += perf.D.rev; pres_grossProfit += perf.D.gp; }
    });

    let pres_override = 0;
    if (commState.president.type === 'pctGrossRev') pres_override = pres_grossRev * (commState.president.val / 100);
    else if (commState.president.type === 'perPack') pres_override = pres_units * commState.president.val;
    commState.president.overridePay = pres_override;
    commState.president.totalPay = pres_override;

    // Calculate totals
    const totalRevenue = perf.R.rev + perf.W.rev + perf.D.rev;
    const totalOpProfit = (C.opR * vR + C.opW * vW + C.opD * vD) * mult;
    const totalComm = commState.sps.reduce((sum, sp) => sum + sp.totalPay, 0) + commState.rsms.reduce((sum, rsm) => sum + rsm.totalPay, 0) + commState.vps.reduce((sum, vp) => sum + vp.totalPay, 0) + commState.president.totalPay;
    const totalBonus = commState.sps.reduce((sum, sp) => sum + sp.bonusPay, 0);
    const commPctGross = totalRevenue > 0 ? totalComm / totalRevenue : 0;
    const commPctOp = totalOpProfit > 0 ? totalComm / totalOpProfit : 0;

    return { ...commState, totalRevenue, totalOpProfit, totalComm, totalBonus, commPctGross, commPctOp };
}
function renderCommissionTable(results) {
    const tbody = $('#proj_body_hierarchical');
    tbody.innerHTML = '';
    let grandTotal = 0;
    // President
    let tr = document.createElement('tr');
    tr.className = 'level-pres';
    tr.innerHTML = `<td>${results.president.name}</td><td>-</td><td>-</td><td>${money(results.president.overridePay)}</td><td>${money(results.president.totalPay)}</td>`;
    tbody.appendChild(tr);
    grandTotal += results.president.totalPay;
    // VPs
    results.vps.forEach(vp => {
        tr = document.createElement('tr');
        tr.className = 'level-vp';
        tr.innerHTML = `<td>${vp.name}</td><td>-</td><td>-</td><td>${money(vp.overridePay)}</td><td>${money(vp.totalPay)}</td>`;
        tbody.appendChild(tr);
        grandTotal += vp.totalPay;
        // RSMs under this VP
        results.rsms.filter(rsm => rsm.assignedVP === vp.id).forEach(rsm => {
            tr = document.createElement('tr');
            tr.className = 'level-rsm';
            tr.innerHTML = `<td>${rsm.name}</td><td>-</td><td>-</td><td>${money(rsm.overridePay)}</td><td>${money(rsm.totalPay)}</td>`;
            tbody.appendChild(tr);
            grandTotal += rsm.totalPay;
            // SPs under this RSM
            results.sps.filter(sp => sp.assignedRSM === rsm.id).forEach(sp => {
                tr = document.createElement('tr');
                tr.className = 'level-sp';
                tr.innerHTML = `<td>${sp.name}</td><td>${money(sp.basePay)}</td><td>${money(sp.bonusPay)}</td><td>-</td><td>${money(sp.totalPay)}</td>`;
                tbody.appendChild(tr);
                grandTotal += sp.totalPay;
            });
        });
    });

    // Unassigned people
    // ... logic for unassigned can be added here if needed
    // Total Row
    tr = document.createElement('tr');
    tr.className = 'total-row';
    tr.innerHTML = `<td><strong>Grand Total</strong></td><td></td><td></td><td></td><td><strong>${money(grandTotal)}</strong></td>`;
    tbody.appendChild(tr);
}
function wireCommissionEvents() {
    $('#add_vp').onclick = () => { $('#vps_container').appendChild(createVPCard()); updateAllDropdowns(); };
    $('#add_rsm').onclick = () => { $('#rsms_container').appendChild(createRSMCard()); updateAllDropdowns(); };
    $('#add_sp').onclick = () => { $('#sps_container').appendChild(createSPCard()); updateAllDropdowns(); };

    // Event delegation for name changes to update dropdowns
    document.querySelector('#vps_container').addEventListener('input', e => {
        if (e.target.classList.contains('comm-name')) updateAllDropdowns();
    });
    document.querySelector('#rsms_container').addEventListener('input', e => {
        if (e.target.classList.contains('comm-name')) updateAllDropdowns();
    });
}
// ===== END: Commission Hierarchy Logic =====
// ===== START: Purchase Order Logic =====
function calculatePurchaseOrderTotals(C) {
    const { S } = C;

    let totalPills = 0;
    let totalCOGS = 0;
    const totals = {
        retail: { totalRevenue: 0, totalProfit: 0, lineItems: [], costPerPill: 0, profitPerPill: 0 },
        wholesale: { totalRevenue: 0, totalProfit: 0, lineItems: [], costPerPill: 0, profitPerPill: 0 },
        distributor: { totalRevenue: 0, totalProfit: 0, lineItems: [], costPerPill: 0, profitPerPill: 0 }
    };

    S.order.forEach(orderItem => {
        const sku = S.skus.find(s => s.sku === orderItem.sku);
        if (!sku || orderItem.qty === 0) return;

        const lineItemPills = sku.pills * orderItem.qty;
        totalPills += lineItemPills;

        const ingPerPack = S.ing.reduce((a, x) => a + (x.mg * sku.pills * x.usdmg), 0);
        const packagingCost = sku.innerPkgCost + sku.outerBoxCost;
        const dispPerPack = sku.displayBoxCost / sku.packsPerDisplay;
        const shipBoxPerPack = sku.shippingBoxCost / sku.packsPerShipBox;
        const cogs = ingPerPack + packagingCost + dispPerPack + shipBoxPerPack;
        totalCOGS += cogs * orderItem.qty;

        const priceR = sku.retailPrice;
        const priceW = priceR * (1 - S.wDisc / 100);
        const priceD = priceW * (1 - S.dDisc / 100);

        const gpR = priceR - cogs;
        const gpW = priceW - cogs;
        const gpD = priceD - cogs;

        const profitR = (gpR * orderItem.qty) - (S.includeShip ? S.shippingPerPack * orderItem.qty : 0);
        const profitW = (gpW * orderItem.qty);
        const profitD = (gpD * orderItem.qty);

        const lineItemRevenueR = priceR * orderItem.qty;
        totals.retail.totalRevenue += lineItemRevenueR;
        totals.retail.totalProfit += profitR;
        totals.retail.lineItems.push({ sku: sku.sku, qty: orderItem.qty, pills: lineItemPills, cost: lineItemRevenueR, profit: profitR });

        const lineItemRevenueW = priceW * orderItem.qty;
        totals.wholesale.totalRevenue += lineItemRevenueW;
        totals.wholesale.totalProfit += profitW;
        totals.wholesale.lineItems.push({ sku: sku.sku, qty: orderItem.qty, pills: lineItemPills, cost: lineItemRevenueW, profit: profitW });

        const lineItemRevenueD = priceD * orderItem.qty;
        totals.distributor.totalRevenue += lineItemRevenueD;
        totals.distributor.totalProfit += profitD;
        totals.distributor.lineItems.push({ sku: sku.sku, qty: orderItem.qty, pills: lineItemPills, cost: lineItemRevenueD, profit: profitD });
    });

    if (totalPills > 0) {
        const avgCostPerPill = totalCOGS / totalPills;
        totals.retail.costPerPill = avgCostPerPill;
        totals.wholesale.costPerPill = avgCostPerPill;
        totals.distributor.costPerPill = avgCostPerPill;
        
        totals.retail.profitPerPill = totals.retail.totalProfit / totalPills;
        totals.wholesale.profitPerPill = totals.wholesale.totalProfit / totalPills;
        totals.distributor.profitPerPill = totals.distributor.totalProfit / totalPills;
    }

    return { ...totals, totalPills };
}

function calculatePurchaseOrders(C) {
    if (!C) C = calc();
    const poTotals = calculatePurchaseOrderTotals(C);
    const { ohTotal } = C;

    const generateTableHTML = (lineItems, grandTotalProfit, perPillCost, perPillProfit) => {
        let table = `<div class="scroller" style="max-height:300px; overflow:auto;"><table><thead><tr><th>SKU</th><th>Quantity</th><th>Total Pills</th><th>Total Revenue</th><th>Gross Profit</th></tr></thead><tbody>`;

        lineItems.forEach(item => {
            table += `<tr><td>${item.sku}</td><td>${item.qty.toLocaleString()}</td><td>${item.pills.toLocaleString()}</td><td>${money(item.cost)}</td><td>${money(item.profit)}</td></tr>`;
        });

        table += `</tbody><tfoot><tr class="total-row"><td><strong>Grand Total</strong></td><td></td><td><strong>${poTotals.totalPills.toLocaleString()}</strong></td><td><strong>${money(lineItems.reduce((a,b)=>a+b.cost,0))}</strong></td><td><strong>${money(grandTotalProfit)}</strong></td></tr></tfoot></table></div>`;

        table += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top:16px;">
            <div class="card" data-tip="po_summary_gp"><div class="muted">Total Gross Profit from Order</div><div class="big thin">${money(grandTotalProfit)}</div></div>
            <div class="card" data-tip="po_summary_oh"><div class="muted">Total Monthly Overhead</div><div class="big thin">${money(ohTotal)}</div></div>
            <div class="card" data-tip="po_summary_net"><div class="muted">Net Impact on Monthly Profit</div><div class="big thin">${money(grandTotalProfit - ohTotal)}</div></div>
            <div class="card" data-tip="po_summary_cost_pill"><div class="muted">Avg Cost per Pill</div><div class="big thin">${money3(perPillCost)}</div></div>
            <div class="card" data-tip="po_summary_profit_pill"><div class="muted">Avg Profit per Pill</div><div class="big thin">${money3(perPillProfit)}</div></div>
        </div>`;

        return table;
    };

    $('#po-retail').innerHTML = generateTableHTML(poTotals.retail.lineItems, poTotals.retail.totalProfit, poTotals.retail.costPerPill, poTotals.retail.profitPerPill);
    $('#po-wholesale').innerHTML = generateTableHTML(poTotals.wholesale.lineItems, poTotals.wholesale.totalProfit, poTotals.wholesale.costPerPill, poTotals.wholesale.profitPerPill);
    $('#po-distributor').innerHTML = generateTableHTML(poTotals.distributor.lineItems, poTotals.distributor.totalProfit, poTotals.distributor.costPerPill, poTotals.distributor.profitPerPill);
}


function wirePOEvents() {
    $$('.po-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            $$('.po-tab').forEach(t => t.classList.remove('active'));
            $$('.po-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            $(`#po-${tab.dataset.tab}`).classList.add('active');
        });
    });
    $('#be_include_overhead').addEventListener('change', render);
}
// ===== END: Purchase Order Logic =====
// ===== Events =====
function wireInputs(){
    document.addEventListener('input', e => {
        const t = e.target;

        if (t.classList.contains('pills')) {
            const row = t.closest('.sku-card');
            const skuInput = row.querySelector('.skuName');
            const pillCount = num(t.value);
            skuInput.value = `${pillCount}-pack`;

            const retailPriceInput = row.querySelector('.retailPrice');
            const pricingTiers = { '3': '21.95', '10': '57.50', '15': '82.50', '30': '157.50' };
            if (pricingTiers[pillCount]) {
                retailPriceInput.value = pricingTiers[pillCount];
            }
            updateOrderComposition();
            updateMonthlyVolumeInputs();
        }

        if (t.id === 'mixR' || t.id === 'mixW' || t.id === 'mixD') {
            enforceMix(t.id);
        }

        if ($('#autoCalc').checked) {
            render();
        }
    });

    $('#channel_toggles').addEventListener('change', () => {
        updateChannelStates();
        enforceMix(null);
    });
    $('#recalcBtn').onclick = render;
    $('#btn_save').onclick = onSaveScenario;
    $('#btn_csv').onclick = toCSV;
    $('#btn_clear').onclick = ()=>{ localStorage.removeItem(LS_KEY); drawScenarioRows() };
    $('#btn_choose_cols').onclick = openCaptureModal;
    $('#modal_close').onclick = ()=> $('#modal').style.display='none';
    $('#save_capture').onclick = saveCapture;
}
// ===== Boot =====
function boot(){
    // Set default values for the top-left section from the image
    $('#skuRows').appendChild(makeSkuRow({
        sku:'3-pack', 
        pills:3, 
        price:21.95, 
        innerPkg: 1.50, 
        outerBox: 1.75,
        displayBox: 0,
        packsPerDisplay: 1,
        shippingBox: 1.5,
        packsPerShipBox: 1
    }));
    updateOrderComposition();
    updateMonthlyVolumeInputs();
    $('#ingredients').innerHTML = '';
    $('#ingredients').appendChild(makeIngRow('Metocin 4-HO-MET', 2, 0.7));
    $('#ingredients').appendChild(makeIngRow('Filler', 800, 0.000075));
    $('#ingredients').appendChild(makeIngRow('Binder', 198, 0.00015));

    // Set other defaults from the image
    $('#includeR').checked = true;
    $('#includeW').checked = false;
    $('#includeD').checked = false;
    $('#mixR').value = 100;
    $('#mixW').value = 0;
    $('#mixD').value = 0;
    $('#wDisc').value = 50;
    $('#dDisc').value = 25;
    $('#shippingPerPack').value = 2.50;
    $('#oh_rows').innerHTML = '';
    $('#oh_rows').appendChild(makeOhRow('Salaries', 10000));
    $('#oh_rows').appendChild(makeOhRow('RENT', 5000));
    $('#oh_rows').appendChild(makeOhRow('INSURANCE', 1000));
    $('#oh_rows').appendChild(makeOhRow('POWER', 500));

    ensureFullCapture();
    initializeTooltipEvents();
    wireInputs();
    migrateOld();
    updateChannelStates();

    // --- Third Party Section Initialization ---
    buildThirdPartySection();
    wireThirdPartyEvents();
    calculateThirdPartyCosts();

    // --- Commission Hierarchy Initialization with Defaults ---
    $('#president_card').innerHTML = '';
    $('#vps_container').innerHTML = '';
    $('#rsms_container').innerHTML = '';
    $('#sps_container').innerHTML = '';
    const presCard = createPresidentCard();
    presCard.querySelector('.comm-name').value = "President of Sales";
    presCard.querySelector('.comm-type').value = "pctGrossRev";
    presCard.querySelector('.comm-val').value = "1";
    $('#president_card').appendChild(presCard);
    const vpCard = createVPCard();
    vpCard.querySelector('.comm-name').value = "VP of Sales";
    vpCard.querySelector('.comm-type').value = "pctGrossRev";
    vpCard.querySelector('.comm-val').value = "2";
    $('#vps_container').appendChild(vpCard);
    const vpId = vpCard.dataset.id;
    const rsmCard = createRSMCard();
    rsmCard.querySelector('.comm-name').value = "RSM 1";
    rsmCard.querySelector('.comm-type').value = "pctGrossRev";
    rsmCard.querySelector('.comm-val').value = "3";
    $('#rsms_container').appendChild(rsmCard);
    const rsmId = rsmCard.dataset.id;
    const spCard = createSPCard();
    spCard.querySelector('.comm-name').value = "Salesperson 1";
    spCard.querySelector('.comm-type').value = "pctGrossRev";
    spCard.querySelector('.comm-val').value = "5";
    $('#sps_container').appendChild(spCard);
    const spId = spCard.dataset.id;

    wireCommissionEvents();
    updateAllDropdowns();
    // Set assignments after dropdowns are populated
    rsmCard.querySelector('.comm-assign-vp').value = vpId;
    spCard.querySelector('.comm-assign-rsm').value = rsmId;
    spCard.querySelector('.comm-ch-assign-vp-r').value = vpId;
    spCard.querySelector('.comm-ch-assign-vp-w').value = vpId;
    spCard.querySelector('.comm-ch-assign-vp-d').value = vpId;
    // --- Purchase Order Initialization ---
    wirePOEvents();
    render();
}
boot();
</script>
</body>
</html>

