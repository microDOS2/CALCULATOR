<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Channel Calculator — ALL‑IN</title>
<style>
  :root{ color-scheme: light dark }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; background:Canvas; color:CanvasText; line-height:1.45 }
  header{ position:sticky; top:0; z-index:10; padding:12px 16px; border-bottom:1px solid ButtonBorder; background:Canvas }
  header .row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .wrap{ max-width:1680px; margin:0 auto; padding:16px; display:grid; grid-template-columns: 1.35fr 1fr; gap:16px }
  section{ background:Field; border:1px solid ButtonBorder; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap:12px }
  h2{ margin:0; font-size:16px; display:flex; align-items:center; gap:8px }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
  .grid-4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px }
  label{ display:block; margin:0 0 6px; font-size:12px; color:GrayText }
  input[type="text"],input[type="number"],select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid ButtonBorder; background:Field; color:FieldText; font-size:14px }
  input[readonly]{ background: color-mix(in srgb, Field 92%, CanvasText 8%); color: color-mix(in srgb, FieldText 70%, CanvasText 30%) }
  .btn{ appearance:none; border:1px solid ButtonBorder; background:ButtonFace; color:ButtonText; padding:8px 12px; border-radius:10px; font-size:13px; cursor:pointer }
  .btn.primary{ background:AccentColor; color:AccentColorText; border-color:AccentColor }
  .btn.small{ font-size:12px; padding:6px 10px }
  .chip{ background: color-mix(in srgb, Field 85%, CanvasText 15%); border:1px solid ButtonBorder; padding:4px 8px; border-radius:999px; font-size:12px; color: GrayText }
  .card{ background:Field; border:1px solid ButtonBorder; border-radius:12px; padding:10px; transition: opacity 0.3s ease; }
  .kpi{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
  .big{ font-weight:700; font-size:19px }
  .thin{ font-variant-numeric:tabular-nums; letter-spacing:.3px }
  .divider{ height:1px; background:ButtonBorder; margin:6px 0 }
  .muted{ color:GrayText }
  .w-90{ width:90px } .w-120{ width:120px } .w-160{ width:160px } .w-180{ width:180px } .w-220{ width:220px }

  .q{ display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; border-radius:999px; border:1px solid ButtonBorder; font-size:12px; color:GrayText; cursor:help; user-select:none }
  [data-tip]{ cursor:help }
  .tip{ position:absolute; z-index:20; max-width:560px; background:Canvas; color:CanvasText; border:1px solid ButtonBorder; border-radius:10px; padding:10px 12px; box-shadow:0 6px 24px rgba(0,0,0,.25); font-size:12px; line-height:1.4; display:none }
  .tip h3{ margin:0 0 6px; font-size:12px; color:GrayText }

  table{ width:100%; border-collapse:collapse; font-size:13px }
  th,td{ padding:8px 10px; border-bottom:1px solid ButtonBorder; text-align:right; white-space:nowrap }
  th:first-child,td:first-child{ text-align:left }
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="row" style="gap:8px">
      <strong>Channel Calculator — ALL‑IN</strong>
      <span class="chip" id="fmt_demo">Money format…</span>
      <span class="chip" id="status">Ready</span>
    </div>
    <div class="row">
      <button id="btn_choose_cols" class="btn">Choose columns</button>
      <select id="capture_sel" class="w-220"><option value="__full__">Full analytics (default)</option></select>
      <label class="row"><input id="autoCalc" type="checkbox" checked> Auto‑recalculate</label>
      <button id="recalcBtn" class="btn primary">Calculate / Recalculate</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section>
    <h2>Product Specifications <span class="q" data-tip="prod">?</span></h2>
    <div class="grid-3">
      <div><label>Pills per pack <span class="q" data-tip="pills">?</span></label><input id="pills" type="number" value="3" data-tip="pills_input"></div>
      <div><label>Retail price per pack (USD) <span class="q" data-tip="price">?</span></label><input id="retailPrice" type="number" step="0.01" value="12.95" data-tip="price_input"></div>
      <div><label>Packs per display <span class="q" data-tip="packsDisp">?</span></label><input id="packsPerDisplay" type="number" value="12" data-tip="packsDisp_input"></div>
    </div>

    <div class="grid-3">
      <div><label>Packaging cost per pack <span class="q" data-tip="packCost">?</span></label><input id="packCostPerPack" data-tip="packCost" type="text" value="$0" readonly></div>
      <div><label>Amortized display cost per pack <span class="q" data-tip="dispCost">?</span></label><input id="dispCostPerPack" data-tip="dispCost" type="text" value="$0" readonly></div>
      <div class="row"><span class="muted">Hover any <b>?</b> or <b>result value</b> for the formula with your numbers</span></div>
    </div>

    <div class="divider"></div>

    <h2>Ingredients <span class="q" data-tip="ingredients">?</span></h2>
    <div id="ingredients" class="grid-4"></div>
    <div class="row"><button class="btn" id="add_ing">Add ingredient</button><span class="muted">Name • milligrams per pill • cost per milligram</span></div>

    <div class="grid-2">
      <div class="card"><div class="muted">Total ingredient cost per pack <span class="q" data-tip="k_ing">?</span></div><div id="kpi_ing" data-tip="k_ing" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Total cost of goods per pack (for Gross) <span class="q" data-tip="k_cogs">?</span></div><div id="kpi_cogs" data-tip="k_cogs" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Fully loaded cost per milligram <span class="q" data-tip="k_mg">?</span></div><div id="kpi_costmg" data-tip="k_mg" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Fully loaded cost per gram <span class="q" data-tip="k_g">?</span></div><div id="kpi_costg" data-tip="k_g" class="big thin">$0</div></div>
    </div>

    <div class="divider"></div>

    <h2>Packaging Cost Breakdown <span class="q" data-tip="packRows">?</span></h2>
    <div id="pack_rows"></div>
    <div class="row"><button class="btn" id="add_pack">Add packaging item</button><span class="muted">Name • Cost / pack</span></div>

    <h2>Display Cost Breakdown <span class="q" data-tip="dispRows">?</span></h2>
    <div id="disp_rows"></div>
    <div class="row"><button class="btn" id="add_disp">Add display item</button><span class="muted">Name • Cost / display</span></div>
  </section>

  <section>
    <h2>Sales Channels <span class="q" data-tip="channels">?</span></h2>
    <div class="row" style="justify-content: space-between;">
        <div class="row" id="channel_toggles">
          <label class="row"><input id="includeR" type="checkbox" checked> Include Retail</label>
          <label class="row"><input id="includeW" type="checkbox" checked> Include Wholesale</label>
          <label class="row"><input id="includeD" type="checkbox" checked> Include Distributor</label>
        </div>
        <label class="row"><input id="autoMix" type="checkbox" checked> Auto‑redistribute mix</label>
    </div>


    <div class="grid-3">
      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_retail">Retail</strong><span class="muted">Price = Retail</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixR" class="w-120" type="number" value="50" data-tip="mix_input"></div>
          <div><label>Gross margin %</label><input id="gmR" data-tip="gmR" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpR" data-tip="gpR" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Revenue / pack</label><input id="revR" data-tip="revR" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opR" data-tip="opR" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omR" data-tip="omR" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Shipping / retail order (USD) <span class="q" data-tip="shipCost">?</span></label><input id="shipCost" class="w-120" type="number" step="0.01" value="2.50" data-tip="shipCost_input"></div>
          <div><label>Packs / retail order</label><input id="packsPerOrder" class="w-120" type="number" value="1" data-tip="packsPerOrder_input"></div>
          <label class="row"><input id="includeShip" type="checkbox" checked> Include shipping</label>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_wholesale">Wholesale</strong><span class="muted">Retail − Discount</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixW" class="w-120" type="number" value="30" data-tip="mix_input"></div>
          <div><label>Wholesale discount %</label><input id="wDisc" class="w-120" type="number" step="0.01" value="25" data-tip="wDisc_input"></div>
        </div>
        <div class="row">
          <div><label>Wholesale price / pack</label><input id="wPrice" data-tip="priceW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Gross margin %</label><input id="gmW" data-tip="gmW" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpW" data-tip="gpW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Retailer profit / pack</label><input id="retailerProfit" data-tip="retailerProfit" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opW" data-tip="opW" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omW" data-tip="omW" class="w-120" type="text" value="0%" readonly></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between"><strong data-tip="ch_distributor">Distributor</strong><span class="muted">Retail − Discount</span></div>
        <div class="row">
          <div><label>Mix percent <span class="q" data-tip="mix">?</span></label><input id="mixD" class="w-120" type="number" value="20" data-tip="mix_input"></div>
          <div><label>Distributor discount %</label><input id="dDisc" class="w-120" type="number" step="0.01" value="40" data-tip="dDisc_input"></div>
        </div>
        <div class="row">
          <div><label>Distributor price / pack</label><input id="dPrice" data-tip="priceD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Gross margin %</label><input id="gmD" data-tip="gmD" class="w-120" type="text" value="0%" readonly></div>
        </div>
        <div class="row">
          <div><label>Gross profit / pack</label><input id="gpD" data-tip="gpD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Distributor profit / pack</label><input id="distProfit" data-tip="distProfit" class="w-120" type="text" value="$0" readonly></div>
        </div>
        <div class="row">
          <div><label>Operating profit / pack</label><input id="opD" data-tip="opD" class="w-120" type="text" value="$0" readonly></div>
          <div><label>Operating margin %</label><input id="omD" data-tip="omD" class="w-120" type="text" value="0%" readonly></div>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <h2>Monthly Costs (Operating Overhead) <span class="q" data-tip="overhead">?</span></h2>
    <div class="row">
      <div><label>Monthly pack volume</label><input id="monthlyVolume" class="w-160" type="number" value="1000" data-tip="monthlyVolume_input"></div>
    </div>
    <div id="oh_rows"></div>
    <div class="row"><button class="btn" id="add_oh">Add overhead item</button><span class="muted">Name • Monthly cost</span></div>
    <div class="row">
      <label class="row"><input id="ohR" type="checkbox" checked> Include overhead in Retail</label>
      <label class="row"><input id="ohW" type="checkbox" checked> Include overhead in Wholesale</label>
      <label class="row"><input id="ohD" type="checkbox" checked> Include overhead in Distributor</label>
    </div>

    <div class="divider"></div>

    <h2>Sales Commissions <span class="q" data-tip="comm">?</span></h2>
    <div id="salespersons"></div>
    <div class="row"><button class="btn" id="add_sp">Add salesperson</button><span class="muted">Channels • Commission type • Value • Bonuses</span></div>

    <div id="projTable" class="card"></div>
    
    <div class="divider"></div>

    <h2>Blended Key Performance Indicators</h2>
    <div class="kpi">
      <div class="card"><div class="muted">Blended revenue per pack <span class="q" data-tip="brev">?</span></div><div id="kpi_brev" data-tip="brev" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Blended gross profit per pack <span class="q" data-tip="bgpp">?</span></div><div id="kpi_bgpp" data-tip="bgpp" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Blended gross margin (percent) <span class="q" data-tip="bgmp">?</span></div><div id="kpi_bgmp" data-tip="bgmp" class="big thin">0%</div></div>
    </div>
    <div class="kpi">
      <div class="card"><div class="muted">Overhead per pack <span class="q" data-tip="ohpp">?</span></div><div id="kpi_ohpp" data-tip="ohpp" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Blended operating profit per pack <span class="q" data-tip="bopp">?</span></div><div id="kpi_bopp" data-tip="bopp" class="big thin">$0</div></div>
      <div class="card"><div class="muted">Blended operating margin (percent) <span class="q" data-tip="bomp">?</span></div><div id="kpi_bomp" data-tip="bomp" class="big thin">0%</div></div>
    </div>
    
    <div class="divider"></div>
    
    <h2>Commission Projections</h2>
    <div id="comm_proj_table" class="card"></div>

  </section>

  <section style="grid-column:1 / -1">
    <div class="row" style="justify-content:space-between; align-items:flex-end">
      <div>
        <h2>Scenarios (v6) <span class="q" data-tip="scenarios">?</span></h2>
        <div class="muted">Save inputs & outputs with timestamps. Capture controls which columns are stored.</div>
      </div>
      <div class="row">
        <input id="scenario_label" class="w-160" type="text" placeholder="Scenario label">
        <button id="btn_save" class="btn primary">Save scenario</button>
        <button id="btn_csv" class="btn">Download CSV</button>
        <button id="btn_clear" class="btn">Clear all</button>
      </div>
    </div>

    <div class="scroller" style="max-height:420px; overflow:auto">
      <table id="scenarios_tbl">
        <thead id="scenarios_head"></thead>
        <tbody id="scenarios_body"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="tip" class="tip"></div>

<div id="modal" style="display:none; position:fixed; inset:0; background:color-mix(in srgb, Canvas 70%, CanvasText 30%); align-items:center; justify-content:center; z-index:50">
  <div style="background:Field; border:1px solid ButtonBorder; border-radius:16px; padding:16px; width:min(980px, 92vw); max-height:85vh; overflow:auto; display:flex; flex-direction:column; gap:12px">
    <div class="row" style="justify-content:space-between"><strong>Choose columns to capture</strong><button id="modal_close" class="btn small">Close</button></div>
    <div id="cols_groups"></div>
    <div class="row" style="justify-content:flex-end">
      <input id="cap_name" class="w-220" placeholder="Name this capture (e.g., Sales Focus)">
      <button id="save_capture" class="btn primary">Save capture</button>
    </div>
  </div>
</div>

<script>
// ===== Utilities =====
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function num(v){ const x = Number(v); return isFinite(x)? x : 0 }
function pct(x){ if(!isFinite(x)||x===0) return '0%'; return (x*100).toFixed(1).replace(/\.0$/, '')+'%'}
function money(n) { return '$' + (Number(n) || 0).toFixed(2); }
function money3(n){ const x = Number(n||0); const s = Math.abs(x).toFixed(3); let out = s.replace(/\.([0-9]{2})0$/, '.$1'); out = out.replace(/\.00$/, ''); out = out.replace(/\B(?=(\d{3})+(?!\d))/g, ','); return (x<0?'-':'')+'$'+out }
(function(){ const demo=[12,12.5,12.345,12.340,0].map(money3).join(' · '); $('#fmt_demo').textContent='Formatter: '+demo })();

// ===== Tooltip engine =====
const TIP = $('#tip');
const T = {};

function showTip(key, evt){ 
    const target = evt.target.closest('[data-tip], .q');
    if (!target) return;
    const tipKey = target.getAttribute('data-tip');
    const t = T[tipKey]; 
    if(!t) return; 
    TIP.innerHTML = '<h3>'+t.title+'</h3><div>'+t.body()+'</div>'; 
    const r=target.getBoundingClientRect(); 
    TIP.style.display='block'; 
    TIP.style.top=(r.top+window.scrollY+r.height+6)+'px'; 
    TIP.style.left=Math.min(r.left+window.scrollX+10, window.scrollX+window.innerWidth-TIP.offsetWidth-20)+'px' 
}
function hideTip(){ TIP.style.display='none' }

function initializeTooltipEvents() {
    document.body.addEventListener('mouseover', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            showTip(null, e);
        }
    });
    document.body.addEventListener('mouseout', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            hideTip();
        }
    });
    document.body.addEventListener('focusin', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            showTip(null, e);
        }
    });
    document.body.addEventListener('focusout', (e) => {
        if (e.target.closest('[data-tip], .q')) {
            hideTip();
        }
    });
}


// ===== Dynamic rows builders =====
function makeIngRow(name='', mg='', usdmg=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 ingName" placeholder="Ingredient" value="'+name+'" data-tip="ingName_input"> <input class="w-120 ingMg" type="number" step="0.0001" placeholder="mg/pill" value="'+mg+'" data-tip="ingMg_input"> <input class="w-120 ingUsdMg" type="number" step="0.000001" placeholder="$ / mg" value="'+usdmg+'" data-tip="ingUsdMg_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makePackRow(name='', cost=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 packName" placeholder="Name" value="'+name+'" data-tip="packName_input"> <input class="w-120 packCost" type="number" step="0.01" placeholder="$/pack" value="'+cost+'" data-tip="packCost_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makeDispRow(name='', cost=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 dispName" placeholder="Name" value="'+name+'" data-tip="dispName_input"> <input class="w-120 dispCost" type="number" step="0.01" placeholder="$/display" value="'+cost+'" data-tip="dispCost_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makeOhRow(name='', cost=''){
  const d=document.createElement('div'); d.className='row';
  d.innerHTML = '<input class="w-160 ohName" placeholder="Name" value="'+name+'" data-tip="ohName_input"> <input class="w-120 ohCost" type="number" step="0.01" placeholder="$/month" value="'+cost+'" data-tip="ohCost_input"> <button class="btn small rm">Remove</button>';
  d.querySelector('.rm').onclick = ()=>{ d.remove(); if($('#autoCalc').checked) render() };
  return d;
}
function makeSP(){
  const c=document.createElement('div'); c.className='card';
  c.innerHTML='\
    <div class="row"><input type="text" class="w-160 spName" placeholder="Salesperson name" value="Lead Rep" data-tip="spName_input"> <button class="btn small spRm">Remove person</button></div>\
    <div class="row"><label class="row"><input class="spR" type="checkbox" checked> Retail</label><label class="row"><input class="spW" type="checkbox" checked> Wholesale</label><label class="row"><input class="spD" type="checkbox" checked> Distributor</label></div>\
    <div class="grid-2"><div><label>Commission type</label><select class="w-160 spType" data-tip="spType_input"><option value="pctGrossRev">% of Gross Revenue</option><option value="perPack">$ per Pack Sold</option></select></div><div><label>Commission value</label><input class="w-120 spVal" type="number" step="0.01" value="5" data-tip="spVal_input"></div></div>\
    <div><label>Target bonuses</label>\
      <div class="row spBonuses"></div>\
      <button class="btn small addBonus">Add bonus</button>\
    </div>';
  c.querySelector('.spRm').onclick=()=>{ c.remove(); if($('#autoCalc').checked) render() };
  c.querySelector('.addBonus').onclick=()=>{
    const r=document.createElement('div'); r.className='row';
    r.innerHTML='<select class="w-160 bMetric" data-tip="bMetric_input"><option value="units">Units Sold</option><option value="grossRev">Gross Revenue</option><option value="grossProfit">Gross Profit</option></select> <input class="w-120 bThresh" type="number" step="0.01" placeholder="Threshold" data-tip="bThresh_input"> <input class="w-120 bAmt" type="number" step="0.01" placeholder="Bonus (USD)" data-tip="bAmt_input"> <button class="btn small bRm">Remove</button>';
    r.querySelector('.bRm').onclick=()=>{ r.remove(); if($('#autoCalc').checked) render() };
    c.querySelector('.spBonuses').appendChild(r);
  };
  return c;
}

// ===== Seed defaults so outputs are non-zero on first load =====
$('#ingredients').appendChild(makeIngRow('Metocin (4‑HO‑MET)', 2, 0.002));
$('#pack_rows').appendChild(makePackRow('Box / Outer', 0.50));
$('#disp_rows').appendChild(makeDispRow('Counter Display', 0));
$('#oh_rows').appendChild(makeOhRow('Salaries', 5000));
$('#salespersons').appendChild(makeSP());

// ===== Wire add buttons =====
$('#add_ing').onclick = ()=>{ $('#ingredients').appendChild(makeIngRow()); if($('#autoCalc').checked) render() };
$('#add_pack').onclick = ()=>{ $('#pack_rows').appendChild(makePackRow()); if($('#autoCalc').checked) render() };
$('#add_disp').onclick = ()=>{ $('#disp_rows').appendChild(makeDispRow()); if($('#autoCalc').checked) render() };
$('#add_oh').onclick   = ()=>{ $('#oh_rows').appendChild(makeOhRow()); if($('#autoCalc').checked) render() };
$('#add_sp').onclick   = ()=>{ $('#salespersons').appendChild(makeSP()); if($('#autoCalc').checked) render() };

// ===== State + math =====
function getState(){
  const S={};
  S.pills = num($('#pills').value);
  S.retailPrice = num($('#retailPrice').value);
  S.packsPerDisplay = Math.max(1, num($('#packsPerDisplay').value));
  S.includeShip = $('#includeShip')? $('#includeShip').checked : true;
  S.shipCost = num($('#shipCost')?.value || 0);
  S.packsPerOrder = Math.max(1, num($('#packsPerOrder')?.value || 1));
  S.wDisc = num($('#wDisc').value);
  S.dDisc = num($('#dDisc').value);
  S.mixR = $('#includeR').checked ? num($('#mixR').value) : 0;
  S.mixW = $('#includeW').checked ? num($('#mixW').value) : 0;
  S.mixD = $('#includeD').checked ? num($('#mixD').value) : 0;
  S.ohR = $('#ohR').checked; S.ohW = $('#ohW').checked; S.ohD = $('#ohD').checked;
  S.monthlyVolume = Math.max(1, num($('#monthlyVolume').value));
  S.ing = $$('#ingredients .row').map(r=>({ mg:num(r.querySelector('.ingMg').value), usdmg:num(r.querySelector('.ingUsdMg').value) }));
  S.pack = $$('#pack_rows .row').map(r=> num(r.querySelector('.packCost').value));
  S.disp = $$('#disp_rows .row').map(r=> num(r.querySelector('.dispCost').value));
  S.oh   = $$('#oh_rows .row').map(r=> num(r.querySelector('.ohCost').value));
  S.reps = Array.from($('#salespersons').children).map(card=>({
    name: card.querySelector('.spName').value.trim()||'—',
    chR: card.querySelector('.spR').checked,
    chW: card.querySelector('.spW').checked,
    chD: card.querySelector('.spD').checked,
    type: card.querySelector('.spType').value,
    val: num(card.querySelector('.spVal').value),
    bonuses: Array.from(card.querySelectorAll('.spBonuses .row')).map(r=>({ metric:r.querySelector('.bMetric').value, thresh:num(r.querySelector('.bThresh').value), amt:num(r.querySelector('.bAmt').value) }))
  }));
  return S;
}

function calc(){
  const S=getState();
  const ingPerPack = S.ing.reduce((a,x)=> a + (x.mg*S.pills*x.usdmg), 0);
  const packPerPack = S.pack.reduce((a,x)=> a + x, 0);
  const dispPerPack = (S.disp.reduce((a,x)=> a + x, 0)) / S.packsPerDisplay;
  const cogs = ingPerPack + packPerPack + dispPerPack;

  const priceR=S.retailPrice;
  const priceW=S.retailPrice*(1 - S.wDisc/100);
  const priceD=S.retailPrice*(1 - S.dDisc/100);

  const gpR=priceR-cogs, gpW=priceW-cogs, gpD=priceD-cogs;
  const gmR=priceR>0? gpR/priceR:0, gmW=priceW>0? gpW/priceW:0, gmD=priceD>0? gpD/priceD:0;

  const ohTotal=S.oh.reduce((a,x)=> a+x, 0);
  const ohPerPack = S.monthlyVolume > 0 ? ohTotal / S.monthlyVolume : 0;
  const shipPerPack = S.includeShip? (S.shipCost/Math.max(1,S.packsPerOrder)) : 0;

  const opR=gpR - (S.ohR?ohPerPack:0) - shipPerPack;
  const opW=gpW - (S.ohW?ohPerPack:0);
  const opD=gpD - (S.ohD?ohPerPack:0);
  const omR=priceR>0? opR/priceR:0, omW=priceW>0? opW/priceW:0, omD=priceD>0? opD/priceD:0;

  const mR=S.mixR/100, mW=S.mixW/100, mD=S.mixD/100;
  const brev = priceR*mR + priceW*mW + priceD*mD;
  const bgpp = gpR*mR + gpW*mW + gpD*mD;
  const bopp = opR*mR + opW*mW + opD*mD;
  const bgmp = brev>0? bgpp/brev:0; const bomp = brev>0? bopp/brev:0;
  
  const retailerProfit = priceR - priceW;
  const distProfit = priceR - priceD;
  
  const totalMgPerPack = S.ing.reduce((a,x)=> a + x.mg*S.pills, 0);
  const costPerMg = totalMgPerPack > 0 ? cogs / totalMgPerPack : 0;
  const costPerGram = costPerMg * 1000;


  // commissions (projection period)
  if(!$('#projPeriod')){ /* build once */
    $('#projTable').innerHTML = '\
      <div class="row"><label>Projection period</label>\
        <select id="projPeriod" class="w-160"><option>Daily</option><option>Weekly</option><option selected>Monthly</option><option>Yearly</option></select>\
        <span class="muted">(uses Monthly pack volume × period)</span></div>\
      <div class="scroller" style="max-height:260px"><table>\
        <thead><tr><th>Salesperson</th><th>Base commission</th><th>Bonuses earned</th><th>Total pay</th></tr></thead>\
        <tbody id="proj_body"></tbody>\
        <tfoot><tr><td style="text-align:left"><strong>Total</strong></td><td></td><td></td><td style="text-align:right" id="proj_totals">$0</td></tr></tfoot>\
      </table></div>';
    $('#projPeriod').onchange = ()=> $('#autoCalc').checked? render():0;
  }
  const periodSel = $('#projPeriod').value;
  const mult = periodSel==='Daily'? 1/30 : periodSel==='Weekly'? 1/4 : periodSel==='Yearly'? 12 : 1;
  const vol = S.monthlyVolume * mult;
  const vR = vol*mR, vW=vol*mW, vD=vol*mD;

  let totalBase=0, totalBonus=0; const perRep=[];
  S.reps.forEach(rep=>{
    const ch = [];
    if(rep.chR) ch.push({vol:vR, price:priceR, gp:gpR});
    if(rep.chW) ch.push({vol:vW, price:priceW, gp:gpW});
    if(rep.chD) ch.push({vol:vD, price:priceD, gp:gpD});
    let base=0, units=0, grossRev=0, grossProfit=0;
    ch.forEach(c=>{ units+=c.vol; grossRev+=c.vol*c.price; grossProfit+=c.vol*c.gp; });
    if(rep.type==='pctGrossRev') base = grossRev*(rep.val/100);
    else if(rep.type==='perPack') base = units*rep.val;
    let bonus=0; rep.bonuses.forEach(b=>{ const met = b.metric==='units'? units : b.metric==='grossRev'? grossRev : grossProfit; if(met>=b.thresh) bonus += b.amt; });
    totalBase+=base; totalBonus+=bonus; perRep.push({name:rep.name, base, bonus, total:base+bonus});
  });
  const totalComm = totalBase+totalBonus;
  const totalRevenue = brev * vol;
  const totalOpProfit = bopp * vol;
  const commPctGross = totalRevenue > 0 ? totalComm / totalRevenue : 0;
  const commPctOp = totalOpProfit > 0 ? totalComm / totalOpProfit : 0;
  const blendedOpPlusComm = totalRevenue > 0 ? (totalOpProfit - totalComm) / totalRevenue : 0;


  return {S, ingPerPack, packPerPack, dispPerPack, cogs, priceR, priceW, priceD, gpR, gpW, gpD, gmR, gmW, gmD, ohPerPack, shipPerPack, opR, opW, opD, omR, omW, omD, brev, bgpp, bopp, bgmp, bomp, retailerProfit, distProfit, vol, vR, vW, vD, perRep, totalBase, totalBonus, totalComm, commPctGross, commPctOp, totalRevenue, totalOpProfit, blendedOpPlusComm, costPerMg, costPerGram };
}

function render(){
  const C = calc();
  const {S}=C;
  // outputs
  $('#packCostPerPack').value = money3(C.packPerPack);
  $('#dispCostPerPack').value = money3(C.dispPerPack);
  $('#kpi_ing').textContent = money3(C.ingPerPack);
  $('#kpi_cogs').textContent = money3(C.cogs);
  $('#kpi_costmg').textContent = C.costPerMg > 0 ? money3(C.costPerMg) : '$0';
  $('#kpi_costg').textContent = C.costPerGram > 0 ? money(C.costPerGram) : '$0';

  $('#wPrice').value = money3(C.priceW);
  $('#dPrice').value = money3(C.priceD);
  $('#revR').value = money3(C.priceR);
  $('#gpR').value = money3(C.gpR); $('#gmR').value = pct(C.gmR);
  $('#gpW').value = money3(C.gpW); $('#gmW').value = pct(C.gmW);
  $('#gpD').value = money3(C.gpD); $('#gmD').value = pct(C.gmD);
  $('#opR').value = money3(C.opR); $('#omR').value = pct(C.omR);
  $('#opW').value = money3(C.opW); $('#omW').value = pct(C.omW);
  $('#opD').value = money3(C.opD); $('#omD').value = pct(C.omD);
  $('#retailerProfit').value = money3(C.retailerProfit);
  $('#distProfit').value = money3(C.distProfit);

  $('#kpi_brev').textContent = money3(C.brev);
  $('#kpi_bgpp').textContent = money3(C.bgpp);
  $('#kpi_bgmp').textContent = pct(C.bgmp);
  $('#kpi_ohpp').textContent = money3(C.ohPerPack);
  $('#kpi_bopp').textContent = money3(C.bopp);
  $('#kpi_bomp').textContent = pct(C.bomp);

  // commissions table
  const tbody = $('#proj_body'); tbody.innerHTML='';
  C.perRep.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = '<td>'+r.name+'</td><td style="text-align:right">'+money3(r.base)+'</td><td style="text-align:right">'+money3(r.bonus)+'</td><td style="text-align:right">'+money3(r.total)+'</td>'; tbody.appendChild(tr) });
  $('#proj_totals').textContent = money3(C.totalComm);
  
  // commission projections
  $('#comm_proj_table').innerHTML = `
    <table>
      <thead><tr><th>Total Comm.</th><th>Blended OP %</th><th>Blended OP-Comm %</th></tr></thead>
      <tbody><tr>
        <td>${money(C.totalComm)}</td>
        <td>${pct(C.bomp)}</td>
        <td>${pct(C.blendedOpPlusComm)}</td>
      </tr></tbody>
    </table>`;


  // tooltips
  wireTips(C);

  // scenarios UI
  drawScenarioTableHeaders();
  drawScenarioRows();

  $('#status').textContent = 'Calculated ' + new Date().toLocaleString();
}

function wireTips(C){
  const S=C.S; const ship = S.includeShip? money3(C.shipPerPack)+' per pack' : '$0 not included';
  const tips = {
    prod:{title:'Product specs', body:()=> 'Inputs feed every calculation.'},
    pills:{title:'Pills per pack', body:()=> S.pills+' pills/pack'},
    price:{title:'Retail price', body:()=> '= <b>'+money3(S.retailPrice)+'</b>'},
    packsDisp:{title:'Packs per display', body:()=> 'Σ(display)/'+S.packsPerDisplay+' = <b>'+money3(C.dispPerPack)+'</b>'},
    packCost:{title:'Packaging / pack', body:()=> 'Σ(pack rows) = <b>'+money3(C.packPerPack)+'</b>'},
    dispCost:{title:'Display / pack', body:()=> 'Σ(display rows)/'+S.packsPerDisplay+' = <b>'+money3(C.dispPerPack)+'</b>'},
    ingredients:{title:'Ingredients', body:()=> 'Σ(mg/pill × pills × $/mg)'},
    k_ing:{title:'Ingredient cost / pack', body:()=> '= <b>'+money3(C.ingPerPack)+'</b>'},
    k_cogs:{title:'COGS / pack', body:()=> money3(C.ingPerPack)+' + '+money3(C.packPerPack)+' + '+money3(C.dispPerPack)+' = <b>'+money3(C.cogs)+'</b>'},
    k_mg:{title:'Fully loaded $/mg', body:()=> { const mg=S.ing.reduce((a,x)=>a+x.mg*S.pills,0); return mg? money3(C.cogs)+' / '+mg.toFixed(0)+' mg = <b>'+money3(C.costPerMg)+'</b>':'—' }},
    k_g:{title:'Fully loaded $/gram', body:()=> { const mg=S.ing.reduce((a,x)=>a+x.mg*S.pills,0); return mg? money3(C.costPerMg)+' × 1000 = <b>'+money(C.costPerGram)+'</b>':'—' }},
    channels:{title:'Channels', body:()=> 'Wholesale/Distributor apply discounts to Retail price.'},
    mix:{title:'Mix %', body:()=> 'Auto‑redistribute keeps R/W/D totaling 100%'},
    priceW:{title:'Wholesale price', body:()=> money3(S.retailPrice)+' × (1 − '+S.wDisc.toFixed(2)+'%) = <b>'+money3(C.priceW)+'</b>'},
    priceD:{title:'Distributor price', body:()=> money3(S.retailPrice)+' × (1 − '+S.dDisc.toFixed(2)+'%) = <b>'+money3(C.priceD)+'</b>'},
    gpR:{title:'Retail GP/pack', body:()=> money3(S.retailPrice)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpR)+'</b>'},
    gpW:{title:'Wholesale GP/pack', body:()=> money3(C.priceW)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpW)+'</b>'},
    gpD:{title:'Distributor GP/pack', body:()=> money3(C.priceD)+' − '+money3(C.cogs)+' = <b>'+money3(C.gpD)+'</b>'},
    gmR:{title:'Retail GM%', body:()=> money3(C.gpR)+' / '+money3(C.priceR)+' = <b>'+pct(C.gmR)+'</b>'},
    gmW:{title:'Wholesale GM%', body:()=> money3(C.gpW)+' / '+money3(C.priceW)+' = <b>'+pct(C.gmW)+'</b>'},
    gmD:{title:'Distributor GM%', body:()=> money3(C.gpD)+' / '+money3(C.priceD)+' = <b>'+pct(C.gmD)+'</b>'},
    opR:{title:'Retail OP/pack', body:()=> money3(C.gpR)+' − '+(S.ohR?money3(C.ohPerPack):'$0')+' − '+ship+' = <b>'+money3(C.opR)+'</b>'},
    opW:{title:'Wholesale OP/pack', body:()=> money3(C.gpW)+' − '+(S.ohW?money3(C.ohPerPack):'$0')+' = <b>'+money3(C.opW)+'</b>'},
    opD:{title:'Distributor OP/pack', body:()=> money3(C.gpD)+' − '+(S.ohD?money3(C.ohPerPack):'$0')+' = <b>'+money3(C.opD)+'</b>'},
    omR:{title:'Retail OM%', body:()=> money3(C.opR)+' / '+money3(C.priceR)+' = <b>'+pct(C.omR)+'</b>'},
    omW:{title:'Wholesale OM%', body:()=> money3(C.opW)+' / '+money3(C.priceW)+' = <b>'+pct(C.omW)+'</b>'},
    omD:{title:'Distributor OM%', body:()=> money3(C.opD)+' / '+money3(C.priceD)+' = <b>'+pct(C.omD)+'</b>'},
    brev:{title:'Blended revenue/pack', body:()=> money3(C.priceR)+'×'+S.mixR+'% + '+money3(C.priceW)+'×'+S.mixW+'% + '+money3(C.priceD)+'×'+S.mixD+'% = <b>'+money3(C.brev)+'</b>'},
    bgpp:{title:'Blended GP/pack', body:()=> money3(C.gpR)+'×'+S.mixR+'% + '+money3(C.gpW)+'×'+S.mixW+'% + '+money3(C.gpD)+'×'+S.mixD+'% = <b>'+money3(C.bgpp)+'</b>'},
    bgmp:{title:'Blended GM%', body:()=> money3(C.bgpp)+' / '+money3(C.brev)+' = <b>'+pct(C.bgmp)+'</b>'},
    ohpp:{title:'Overhead / pack', body:()=> 'Σ(overhead)/'+S.monthlyVolume+' = <b>'+money3(C.ohPerPack)+'</b>'},
    bopp:{title:'Blended OP/pack', body:()=> money3(C.opR)+'×'+S.mixR+'% + '+money3(C.opW)+'×'+S.mixW+'% + '+money3(C.opD)+'×'+S.mixD+'% = <b>'+money3(C.bopp)+'</b>'},
    bomp:{title:'Blended OM%', body:()=> money3(C.bopp)+' / '+money3(C.brev)+' = <b>'+pct(C.bomp)+'</b>'},
    scenarios:{title:'Scenarios', body:()=> 'v6 storage with timestamps. Use Choose columns to define capture.'},
    comm:{title:'Sales commissions', body:()=> 'Per salesperson: select channels, choose commission type, add optional bonuses. Calculated for selected period.'},
    revR: {title:'Retail Revenue/pack', body:()=> 'This is the retail price per pack. = <b>'+money3(C.priceR)+'</b>'},
    retailerProfit: {title: 'Retailer Profit/pack', body:()=> 'The profit the retailer makes on a wholesale transaction.<br>'+money3(C.priceR)+' (Retail) - '+money3(C.priceW)+' (Wholesale Price) = <b>'+money3(C.retailerProfit)+'</b>'},
    distProfit: {title: 'Distributor Profit/pack', body:()=> 'The profit the distributor makes.<br>'+money3(C.priceR)+' (Retail) - '+money3(C.priceD)+' (Distributor Price) = <b>'+money3(C.distProfit)+'</b>'},
    shipCost: {title: 'Shipping Cost', body:()=> 'Cost to ship a single retail order.'},
    packRows: {title: 'Packaging Items', body:()=> 'List all individual packaging costs per pack.'},
    dispRows: {title: 'Display Items', body:()=> 'List all individual costs for one display unit.'},
    overhead: {title: 'Monthly Overhead', body:()=> 'Fixed monthly business costs (salaries, rent, etc.).'},
    
    pills_input: {title: 'Input: Pills per pack', body:()=> 'Enter the number of pills in each retail pack.'},
    price_input: {title: 'Input: Retail price', body:()=> 'Enter the final consumer price for one pack.'},
    packsDisp_input: {title: 'Input: Packs per display', body:()=> 'How many packs fit into one shipping/store display?'},
    mix_input: {title: 'Input: Mix %', body:()=> 'What percentage of sales comes from this channel?'},
    wDisc_input: {title: 'Input: Wholesale Discount %', body:()=> 'Discount off retail price for wholesale customers.'},
    dDisc_input: {title: 'Input: Distributor Discount %', body:()=> 'Discount off retail price for distributors.'},
    shipCost_input: {title: 'Input: Shipping Cost', body:()=> 'Enter the cost to ship a single retail order.'},
    packsPerOrder_input: {title: 'Input: Packs per order', body:()=> 'Average number of packs in a single retail order.'},
    monthlyVolume_input: {title: 'Input: Monthly Volume', body:()=> 'Total number of packs sold across all channels in a month.'},
    ingName_input: {title: 'Input: Ingredient Name', body:()=> 'Name of the ingredient.'},
    ingMg_input: {title: 'Input: Milligrams per Pill', body:()=> 'How many milligrams of this ingredient are in one pill.'},
    ingUsdMg_input: {title: 'Input: Cost per Milligram', body:()=> 'The cost for one milligram of this ingredient.'},
    packName_input: {title: 'Input: Packaging Item Name', body:()=> 'Name of the packaging component (e.g., box, bottle).'},
    packCost_input: {title: 'Input: Cost per Pack', body:()=> 'Cost of this packaging component for one pack.'},
    dispName_input: {title: 'Input: Display Item Name', body:()=> 'Name of the display component (e.g., cardboard stand).'},
    dispCost_input: {title: 'Input: Cost per Display', body:()=> 'Cost of this component for one display unit.'},
    ohName_input: {title: 'Input: Overhead Item Name', body:()=> 'Name of the monthly overhead cost (e.g., Salaries).'},
    ohCost_input: {title: 'Input: Monthly Cost', body:()=> 'The total cost for this item per month.'},
    spName_input: {title: 'Input: Salesperson Name', body:()=> 'Name of the sales representative.'},
    spType_input: {title: 'Input: Commission Type', body:()=> 'How the commission is calculated.'},
    spVal_input: {title: 'Input: Commission Value', body:()=> 'The percentage or dollar amount for the commission.'},
    bMetric_input: {title: 'Input: Bonus Metric', body:()=> 'The metric for achieving a bonus.'},
    bThresh_input: {title: 'Input: Bonus Threshold', body:()=> 'The target value to achieve for the bonus.'},
    bAmt_input: {title: 'Input: Bonus Amount', body:()=> 'The bonus amount paid when the threshold is met.'},
    
    ch_retail: {title: 'Retail Channel', body:()=> 'Direct-to-consumer sales at full retail price.'},
    ch_wholesale: {title: 'Wholesale Channel', body:()=> 'Sales to retailers at a discounted price.'},
    ch_distributor: {title: 'Distributor Channel', body:()=> 'Sales to distributors at a larger discount.'},
  };

  ALL_COLUMNS.forEach(col => {
    tips[`col_tip_${col.key}`] = { title: col.label, body: () => col.tooltip };
  });

  Object.assign(T, tips);
}

function updateChannelStates() {
    const channels = [
        { id: 'R', card: $('#mixR').closest('.card'), checkbox: $('#includeR'), mixInput: $('#mixR') },
        { id: 'W', card: $('#mixW').closest('.card'), checkbox: $('#includeW'), mixInput: $('#mixW') },
        { id: 'D', card: $('#mixD').closest('.card'), checkbox: $('#includeD'), mixInput: $('#mixD') }
    ];

    channels.forEach(ch => {
        const isEnabled = ch.checkbox.checked;
        ch.card.style.opacity = isEnabled ? '1' : '0.6';
        ch.card.querySelectorAll('input, select').forEach(input => {
            if (input.type !== 'checkbox') {
                 input.disabled = !isEnabled;
            }
        });
        if (!isEnabled) {
            ch.mixInput.value = 0;
        }
    });
}


function enforceMix(changedId) {
    if (!$('#autoMix').checked) return;

    const channels = [
        { id: 'R', checkbox: $('#includeR'), mixInput: $('#mixR') },
        { id: 'W', checkbox: $('#includeW'), mixInput: $('#mixW') },
        { id: 'D', checkbox: $('#includeD'), mixInput: $('#mixD') }
    ];

    const activeChannels = channels.filter(ch => ch.checkbox.checked);
    if (activeChannels.length === 0) {
        channels.forEach(ch => ch.mixInput.value = 0);
        if ($('#autoCalc').checked) render();
        return;
    }

    const changedChannel = activeChannels.find(ch => ch.mixInput.id === changedId);

    if (changedChannel) {
        let val = Math.max(0, Math.min(100, num(changedChannel.mixInput.value)));
        changedChannel.mixInput.value = val;

        const otherActiveChannels = activeChannels.filter(ch => ch.mixInput.id !== changedId);
        if (otherActiveChannels.length > 0) {
            const rem = 100 - val;
            const split = rem / otherActiveChannels.length;
            otherActiveChannels.forEach(ch => ch.mixInput.value = split.toFixed(1));
        } else {
             changedChannel.mixInput.value = 100;
        }
    } else {
        const split = 100 / activeChannels.length;
        activeChannels.forEach(ch => ch.mixInput.value = split.toFixed(1));
    }

    const finalTotal = activeChannels.reduce((sum, ch) => sum + num(ch.mixInput.value), 0);
    const diff = 100 - finalTotal;
    if (diff.toFixed(1) != 0.0 && activeChannels.length > 0) {
        activeChannels[0].mixInput.value = (num(activeChannels[0].mixInput.value) + diff).toFixed(1);
    }
    if ($('#autoCalc').checked) render();
}

// ===== Scenarios (v6) + captures + migration =====
const LS_KEY='channel_calc_scenarios_v6';
const OLD_KEYS=['channel_calc_scenarios_v3','channel_calc_scenarios_v5'];
let CAPTURES={ '__full__': [] };

const ALL_COLUMNS = [
  {key:'savedAt', label:'Saved', tooltip: 'The date the scenario was saved.'}, 
  {key:'label', label:'Label', tooltip: 'A custom name for the scenario.'}, 
  {key:'lastCalculatedAt', label:'Last Calculated At', tooltip: 'The last time the calculations were run for this scenario.'},
  {key:'pills', label:'Pills', tooltip: 'Number of pills per pack.'}, 
  {key:'retailPrice', label:'Retail Price', tooltip: 'The selling price to the end customer.'}, 
  {key:'packsPerDisplay', label:'Packs per Display', tooltip: 'Number of packs in a shipping display.'},
  {key:'ingPerPack', label:'Ingredients / pack', tooltip: 'Total cost of ingredients for one pack.'}, 
  {key:'packPerPack', label:'Packaging / pack', tooltip: 'Total cost of packaging for one pack.'}, 
  {key:'dispPerPack', label:'Display / pack', tooltip: 'Amortized cost of the display per pack.'}, 
  {key:'cogs', label:'Total COGS', tooltip: 'Total Cost of Goods Sold per pack.'}, 
  {key:'ohPerPack', label:'Overhead / pack', tooltip: 'Amortized monthly overhead cost per pack.'}, 
  {key:'shipPerPack', label:'Shipping / pack', tooltip: 'Amortized shipping cost per pack for retail orders.'},
  {key:'wDisc', label:'Wholesale Discount %', tooltip: 'Discount percentage for wholesale channel.'}, 
  {key:'dDisc', label:'Distributor Discount %', tooltip: 'Discount percentage for distributor channel.'}, 
  {key:'mixR', label:'Mix Retail %', tooltip: 'Percentage of sales from the retail channel.'}, 
  {key:'mixW', label:'Mix Wholesale %', tooltip: 'Percentage of sales from the wholesale channel.'}, 
  {key:'mixD', label:'Mix Distributor %', tooltip: 'Percentage of sales from the distributor channel.'}, 
  {key:'gmR', label:'Gross Margin % Retail', tooltip: 'Gross Margin percentage for the retail channel.'}, 
  {key:'gmW', label:'Gross Margin % Wholesale', tooltip: 'Gross Margin percentage for the wholesale channel.'}, 
  {key:'gmD', label:'Gross Margin % Distributor', tooltip: 'Gross Margin percentage for the distributor channel.'}, 
  {key:'omR', label:'Operating Margin % Retail', tooltip: 'Operating Margin percentage for the retail channel.'}, 
  {key:'omW', label:'Operating Margin % Wholesale', tooltip: 'Operating Margin percentage for the wholesale channel.'}, 
  {key:'omD', label:'Operating Margin % Distributor', tooltip: 'Operating Margin percentage for the distributor channel.'},
  {key:'brev', label:'Blended Revenue/Pack', tooltip: 'Blended revenue per pack across all active channels.'}, 
  {key:'bgpp', label:'Blended Gross Profit/Pack', tooltip: 'Blended gross profit per pack across all active channels.'}, 
  {key:'bgmp', label:'Blended Gross Margin %', tooltip: 'Blended gross margin percentage across all active channels.'}, 
  {key:'bopp', label:'Blended Operating Profit/Pack', tooltip: 'Blended operating profit per pack across all active channels.'}, 
  {key:'bomp', label:'Blended Operating Margin %', tooltip: 'Blended operating margin percentage across all active channels.'},
  {key:'salespersonCount', label:'Salesperson Count', tooltip: 'Total number of salespersons.'}, 
  {key:'totalComm', label:'Total Commissions', tooltip: 'Total commissions paid for the projection period.'}, 
  {key:'totalBonus', label:'Total Bonuses', tooltip: 'Total bonuses paid for the projection period.'}, 
  {key:'commPctGross', label:'Commission % of Revenue', tooltip: 'Total commissions as a percentage of total revenue.'}, 
  {key:'commPctOp', label:'Commission % of Operating Profit', tooltip: 'Total commissions as a percentage of operating profit.'},
  {key:'totalRevenue', label:'Total Revenue', tooltip: 'Total projected revenue for the period.'},
  {key:'totalOpProfit', label:'Blended OP Profit', tooltip: 'Total projected operating profit for the period.'},
  {key:'anonymous', label:'Anonymous', tooltip: 'Placeholder for user data.'}, 
  {key:'if', label:'IF', tooltip: 'Placeholder for conditional logic.'}, 
  {key:'load', label:'Load', tooltip: 'Load this scenario\'s inputs.'}
];

const SCENARIO_TABLE_KEYS = ['savedAt', 'label', 'retailPrice', 'cogs', 'brev', 'bopp', 'totalRevenue', 'commPctGross', 'totalOpProfit', 'anonymous', 'if', 'load'];

function ensureFullCapture(){ CAPTURES['__full__'] = ALL_COLUMNS.map(c=>c.key) }
function currentCaptureKeys(){ const sel=$('#capture_sel').value; return CAPTURES[sel]||ALL_COLUMNS.map(c=>c.key) }
function drawScenarioTableHeaders(){ const head=$('#scenarios_head'); head.innerHTML=''; const tr=document.createElement('tr'); SCENARIO_TABLE_KEYS.forEach(key=>{ const colInfo = ALL_COLUMNS.find(c => c.key === key); const th=document.createElement('th'); th.textContent=colInfo.label; tr.appendChild(th) }); head.appendChild(tr) }
function loadScenarios(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]') }catch(e){ return [] } }
function saveScenarios(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)) }
function migrateOld(){ /* Migration logic can be re-added if needed */ }
function scenarioFromCurrent(C){ 
  const S=C.S; 
  const row={}; 
  row.savedAt = new Date().toLocaleDateString(); 
  row.label = ($('#scenario_label').value||'').trim(); 
  row.retailPrice=money(S.retailPrice); 
  row.cogs=money(C.cogs); 
  row.brev=money(C.brev); 
  row.bopp=money(C.bopp); 
  row.totalRevenue = money(C.totalRevenue);
  row.commPctGross = pct(C.commPctGross);
  row.totalOpProfit = money(C.totalOpProfit);
  row.anonymous = 'Anonymous';
  row.if = 'IF';
  row.__inputs={ pills:S.pills, retailPrice:S.retailPrice, packsPerDisplay:S.packsPerDisplay, wDisc:S.wDisc, dDisc:S.dDisc, mixR:S.mixR, mixW:S.mixW, mixD:S.mixD, monthlyVolume:S.monthlyVolume, includeShip:S.includeShip, shipCost:S.shipCost, packsPerOrder:S.packsPerOrder, oh: S.oh, reps: S.reps }; 
  return row 
}
function drawScenarioRows(){ 
  const body=$('#scenarios_body'); 
  body.innerHTML=''; 
  const list=loadScenarios(); 
  list.forEach((r)=>{ 
    const tr=document.createElement('tr'); 
    SCENARIO_TABLE_KEYS.forEach(key=>{ 
      const td=document.createElement('td'); 
      if (key === 'load') {
        const btn=document.createElement('button'); 
        btn.className='btn small'; 
        btn.textContent='Load'; 
        btn.onclick=()=> restoreScenario(r.__inputs||{}); 
        td.appendChild(btn); 
      } else {
        td.textContent = r[key] ?? '—'; 
      }
      tr.appendChild(td) 
    }); 
    body.appendChild(tr) 
  }) 
}
function restoreScenario(inputs){ 
  if(inputs.pills!=null) $('#pills').value=inputs.pills; 
  if(inputs.retailPrice!=null) $('#retailPrice').value=inputs.retailPrice; 
  if(inputs.packsPerDisplay!=null) $('#packsPerDisplay').value=inputs.packsPerDisplay; 
  if(inputs.wDisc!=null) $('#wDisc').value=inputs.wDisc; 
  if(inputs.dDisc!=null) $('#dDisc').value=inputs.dDisc; 
  if(inputs.mixR!=null) $('#mixR').value=inputs.mixR; 
  if(inputs.mixW!=null) $('#mixW').value=inputs.mixW; 
  if(inputs.mixD!=null) $('#mixD').value=inputs.mixD; 
  if(inputs.monthlyVolume!=null) $('#monthlyVolume').value=inputs.monthlyVolume; 
  if(inputs.includeShip!=null) $('#includeShip').checked=!!inputs.includeShip; 
  if(inputs.shipCost!=null) $('#shipCost').value=inputs.shipCost; 
  if(inputs.packsPerOrder!=null) $('#packsPerOrder').value=inputs.packsPerOrder; 
  
  // Restore dynamic rows
  $('#oh_rows').innerHTML = '';
  if(inputs.oh) inputs.oh.forEach((cost, i) => $('#oh_rows').appendChild(makeOhRow(`Overhead ${i+1}`, cost)));
  
  $('#salespersons').innerHTML = '';
  if(inputs.reps) inputs.reps.forEach(repData => {
      const sp = makeSP();
      sp.querySelector('.spName').value = repData.name;
      sp.querySelector('.spR').checked = repData.chR;
      sp.querySelector('.spW').checked = repData.chW;
      sp.querySelector('.spD').checked = repData.chD;
      sp.querySelector('.spType').value = repData.type;
      sp.querySelector('.spVal').value = repData.val;
      // Bonuses would need more complex restoration logic if needed
      $('#salespersons').appendChild(sp);
  });

  render();
}
function onSaveScenario(){ const C=calc(); const row=scenarioFromCurrent(C); const list=loadScenarios(); list.unshift(row); saveScenarios(list); drawScenarioRows() }
function toCSV(){ const list=loadScenarios(); if(!list.length){ alert('No scenarios saved.'); return } const keys=SCENARIO_TABLE_KEYS.filter(c=>c !== 'load'); const header=keys.map(k => (ALL_COLUMNS.find(c=>c.key===k) || {}).label).join(','); const rows=list.map(r=> keys.map(k=> (r[k]??'').toString().replace(/\"/g,'""')).map(x=>'"'+x+'"').join(',')); const csv=[header, ...rows].join('\n'); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='scenarios.csv'; a.click(); URL.revokeObjectURL(url) }

// Capture modal
const GROUPS = { 
  'Meta': ['savedAt','label','lastCalculatedAt'], 
  'Product': ['pills','retailPrice','packsPerDisplay'], 
  'Costs': ['ingPerPack','packPerPack','dispPerPack','cogs','ohPerPack','shipPerPack'], 
  'Channels': ['wDisc','dDisc','mixR','mixW','mixD','gmR','gmW','gmD','omR','omW','omD'], 
  'Blended': ['brev','bgpp','bgmp','bopp','bomp'], 
  'Commissions': ['salespersonCount','totalComm','totalBonus','commPctGross','commPctOp'] 
};

function openCaptureModal(){ 
  wireTips(calc()); // Ensure tooltips are populated
  const host=$('#cols_groups'); 
  host.innerHTML=''; 
  for(const [group,keys] of Object.entries(GROUPS)){ 
    const card=document.createElement('div'); 
    card.className='card'; 
    const h=document.createElement('div'); 
    h.innerHTML='<strong>'+group+'</strong>'; 
    card.appendChild(h); 
    keys.forEach(k=>{ 
      const c=document.createElement('div'); 
      c.className='row'; 
      const id='col_'+k; 
      const colInfo = ALL_COLUMNS.find(x=>x.key===k) || {label: k, tooltip: ''};
      c.innerHTML = `<label class="row" style="justify-content:flex-start" data-tip="col_tip_${k}"><input id="${id}" type="checkbox" checked> ${colInfo.label}</label>`; 
      card.appendChild(c);
    }); 
    host.appendChild(card);
  } 
  $('#modal').style.display='flex';
}
function saveCapture(){ const name = ($('#cap_name').value||'').trim() || 'Custom capture'; const keys=[]; Object.values(GROUPS).flat().forEach(k=>{ if($('#col_'+k).checked) keys.push(k) }); CAPTURES[name]=keys; const opt=document.createElement('option'); opt.value=name; opt.textContent=name; $('#capture_sel').appendChild(opt); $('#capture_sel').value=name; $('#modal').style.display='none' }

// ===== Events =====
function wireInputs(){ 
    document.addEventListener('input', e=>{ 
        const t=e.target; 
        if((t.type === 'number' || t.type === 'text') && t.closest('.card')){
            if(t.id==='mixR'||t.id==='mixW'||t.id==='mixD') {
                enforceMix(t.id);
            }
        }
        if ($('#autoCalc').checked) render();
    }); 
    
    $('#channel_toggles').addEventListener('change', () => {
        updateChannelStates();
        enforceMix(null);
    });

    $('#recalcBtn').onclick = render; 
    $('#btn_save').onclick = onSaveScenario; 
    $('#btn_csv').onclick = toCSV; 
    $('#btn_clear').onclick = ()=>{ localStorage.removeItem(LS_KEY); drawScenarioRows() }; 
    $('#btn_choose_cols').onclick = openCaptureModal; 
    $('#modal_close').onclick = ()=> $('#modal').style.display='none'; 
    $('#save_capture').onclick = saveCapture;
}

// ===== Boot =====
function boot(){ 
    ensureFullCapture(); 
    initializeTooltipEvents();
    wireInputs(); 
    migrateOld(); 
    updateChannelStates();
    render(); 
}
boot();
</script>
</body>
</html>
