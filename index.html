<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Channel Calculator — Enhanced (with Commissions)</title>
  <style>
    :root{ color-scheme: light dark; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; background: Canvas; color: CanvasText; line-height:1.45; }
    header{ padding:16px 20px; border-bottom:1px solid ButtonBorder; background: Canvas; position:sticky;top:0;z-index:3; }
    header h1{margin:0 0 4px;font-size:20px;font-weight:700}
    header .sub{color: GrayText;font-size:12px}
    .wrap{ max-width:1280px; padding:20px; margin:0 auto; display:grid; grid-template-columns:1.15fr 1fr; gap:16px; }
    @media (max-width: 1024px) { .wrap { grid-template-columns: 1fr; } }
    section{ background: Field; border:1px solid ButtonBorder; border-radius:14px; padding:14px; display:flex; flex-direction:column; gap: 10px; }
    h2{margin:0 0 10px;font-size:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color: GrayText;margin-bottom:6px}
    input[type="text"],input[type="number"],input[type="checkbox"], select{ accent-color: AccentColor }
    input[type="text"],input[type="number"], select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid ButtonBorder; background: Field; color: FieldText; font-size:14px; }
    input[readonly]{ background: color-mix(in srgb, Field 92%, CanvasText 8%); color: color-mix(in srgb, FieldText 70%, CanvasText 30%); }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{ background: color-mix(in srgb, Field 85%, CanvasText 15%); border:1px solid ButtonBorder; padding:6px 8px; border-radius:10px; font-size:12px; color: GrayText; }
    .toggle{display:flex;align-items:center;gap:8px;font-size:13px;color: CanvasText}
    .toggle input{transform:scale(1.05)}
    table{width:100%; border-collapse:collapse; font-size:13px; background: Field; border-radius:12px; overflow:hidden;}
    th,td{padding:8px 10px;border-bottom:1px solid ButtonBorder;text-align:right;white-space:nowrap}
    th:first-child,td:first-child{text-align:left}
    .btn{ appearance:none; border:1px solid ButtonBorder; background: ButtonFace; color: ButtonText; padding:9px 12px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background: AccentColor; color: AccentColorText; border-color: AccentColor}
    .muted{color: GrayText}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .card{background: Field;border:1px solid ButtonBorder;border-radius:12px;padding:10px}
    .salesperson-card { background: Canvas; border:1px solid ButtonBorder; border-radius:12px; padding:12px; margin-bottom:10px; }
    .bonus-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: flex-end; margin-top: 8px; }
    .card .big{font-size:19px;font-weight:700}
    .thin{font-variant-numeric:tabular-nums;letter-spacing:.3px}
    .disabled{opacity:.6; pointer-events: none;}
    .note{font-size:12px;color: GrayText;margin-top:6px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .w-120{width:120px}
    .w-90{width:90px}
    .w-160{width:160px}
    .scroller{overflow:auto}
    .sticky-actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
    .small{font-size:12px}
    .t{ position:relative; cursor:help; }
    .t[tabindex="0"]:focus::after,
    .t:hover::after{ content: attr(data-tip); position:absolute; z-index:10; left:0; top:100%; margin-top:6px; max-width:420px; background: CanvasText; color: Canvas; border: 1px solid ButtonBorder; padding:10px 12px; border-radius:10px; box-shadow: 0 6px 16px 0 color-mix(in srgb, CanvasText 15%, transparent); white-space:pre-wrap; }
    .t[tabindex="0"]:focus::before,
    .t:hover::before{ content:""; position:absolute; left:16px; top:100%; border:6px solid transparent; border-bottom-color: CanvasText; transform: translateY(-1px); }
    .pill{padding:2px 6px;border:1px solid ButtonBorder;border-radius:999px;font-size:11px;color:GrayText}
  </style>
</head>
<body>
  <header>
    <h1>Channel Calculator — Enhanced</h1>
    <div class="sub">Now with Sales Commission tracking, bonuses, and flexible time period projections.</div>
  </header>

  <div class="wrap">
    <!-- Left column: Inputs -->
    <section>
      <div>
        <h2>Product Specifications</h2>
        <div class="grid-3">
          <div>
            <label class="t" tabindex="0" data-tip="Number of tablets in each pack.">Pills per pack</label>
            <input id="inp_pills" type="number" min="1" step="1" value="3">
          </div>
          <div>
            <label class="t" tabindex="0" data-tip="Consumer-facing price; other channel prices are discounts from this.">Retail price per pack (USD)</label>
            <input id="inp_retail_price" type="number" min="0" step="0.01" value="12.95">
          </div>
          <div class="toggle">
            <input id="auto_calc" type="checkbox" checked>
            <label class="t" tabindex="0" data-tip="When ON, results update as you type. When OFF, click Calculate / Recalculate to update and timestamp the run.">Auto‑recalculate</label>
          </div>
        </div>

        <div class="grid-3" style="margin-top:10px">
          <div>
            <label class="t" tabindex="0" data-tip="All packaging components per pack. Use breakdown rows below; this field shows the rolled-up total.">Packaging cost per pack (USD)</label>
            <input id="inp_packaging" type="number" min="0" step="0.01" value="0.50" readonly>
          </div>
          <div>
            <label class="t" tabindex="0" data-tip="How many packs share one display.">Packs per display</label>
            <input id="inp_packs_per_display" type="number" min="1" step="1" value="12">
          </div>
          <div>
            <label class="t" id="tip_display_per_pack" tabindex="0" data-tip="Display per pack = $0.00 ÷ 0 = $0.00">Amortized display cost per pack (USD)</label>
            <input id="out_display_per_pack" type="text" readonly>
          </div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:14px">Ingredients (add up to five)
          <span class="t chip" id="tip_ing_sum" tabindex="0" data-tip="No ingredients yet">Formula</span>
        </h2>
        <div id="ingredients"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btn_add_ing" title="Add an ingredient row (maximum five)">Add ingredient</button>
          <span class="note">Each ingredient: Name, milligrams per pill, cost per milligram.</span>
        </div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="muted small">Total ingredient cost per pack <span class="t chip" id="tip_ing_total" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_ing_cost">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Total COGS per pack (for Gross) <span class="t chip" id="tip_total_cost" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_total_cost">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Fully loaded cost per mg <span class="t chip" id="tip_cost_per_mg" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_cost_per_mg">$0.0000</div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:16px">Packaging Cost Breakdown
          <span class="chip muted">up to 4 rows</span>
        </h2>
        <div id="pack_rows"></div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btn_add_pack">Add packaging item</button>
          <span class="note">Each row: Name + Cost per pack ($)</span>
        </div>
      </div>

      <div>
        <h2 style="margin-top:16px">Display Cost Breakdown
          <span class="chip muted">up to 4 rows</span>
        </h2>
        <div id="disp_rows"></div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btn_add_disp">Add display item</button>
          <span class="note">Each row: Name + Cost per display ($). Amortized by packs per display.</span>
        </div>
      </div>
    </section>

    <!-- Right column: Channels + Monthly Costs -->
    <section>
      <div>
        <h2>Sales Channels</h2>
        <div class="row">
          <label class="toggle t" tabindex="0" data-tip="When enabled, the mix percentages are auto-normalized across the enabled channels. Disable to edit mix manually."><input id="chk_auto_mix" type="checkbox" checked> Auto-redistribute mix</label>
        </div>

        <div style="margin-top:8px" class="grid-3">
          <!-- Retail -->
          <div class="card" id="card_retail">
            <div class="flex" style="justify-content:space-between">
              <label class="toggle t" tabindex="0" data-tip="Turn retail channel on or off for blended calculations."><input id="use_retail" type="checkbox" checked> Retail</label>
              <span class="chip">Price = retail input</span>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label class="t" tabindex="0" data-tip="Share of total volume expected through Retail.">Mix percent</label>
                <input id="mix_retail" class="w-120" type="number" min="0" max="100" step="0.01" value="50">
              </div>
              <div>
                <label class="t" id="tip_gm_retail" tabindex="0" data-tip="—">Gross margin (%)</label>
                <input id="gm_retail" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_profit_retail" tabindex="0" data-tip="—">Gross profit per pack</label>
                <input id="profit_retail" class="w-120" type="text" readonly>
              </div>
              <div>
                <label>Revenue per pack</label>
                <input id="rev_retail" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_oper_profit_retail" tabindex="0" data-tip="—">Operating profit per pack</label>
                <input id="oper_profit_retail" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_oper_gm_retail" tabindex="0" data-tip="—">Operating margin (%)</label>
                <input id="oper_gm_retail" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" tabindex="0" data-tip="Shipping cost per retail order; converted to per-pack by packs per order.">Shipping per retail order ($)</label>
                <input id="ship_per_order" class="w-120" type="number" min="0" step="0.01" value="2.50">
              </div>
              <div>
                <label class="t" tabindex="0" data-tip="Assumed packs per retail order for shipping allocation.">Packs per retail order</label>
                <input id="packs_per_order" class="w-120" type="number" min="1" step="1" value="1">
              </div>
              <label class="toggle t" tabindex="0" data-tip="Include shipping in Retail operating costs? Affects Operating profit/margin for Retail only."><input id="include_shipping" type="checkbox" checked> Include shipping</label>
            </div>
          </div>

          <!-- Wholesale -->
          <div class="card" id="card_wholesale">
            <div class="flex" style="justify-content:space-between">
              <label class="toggle t" tabindex="0" data-tip="Turn wholesale channel on or off for blended calculations."><input id="use_wholesale" type="checkbox" checked> Wholesale</label>
              <span class="chip t" id="tip_price_wholesale" tabindex="0" data-tip="—">Pricing rule</span>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label class="t" tabindex="0" data-tip="Share of total volume through Wholesale.">Mix percent</label>
                <input id="mix_wholesale" class="w-120" type="number" min="0" max="100" step="0.01" value="30">
              </div>
              <div>
                <label class="t" tabindex="0" data-tip="Percent discount from retail to arrive at wholesale price.">Wholesale discount (%)</label>
                <input id="disc_wholesale" class="w-120" type="number" min="0" max="100" step="0.01" value="25">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Wholesale price per pack</label>
                <input id="price_wholesale" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_gm_wholesale" tabindex="0" data-tip="—">Gross margin (%)</label>
                <input id="gm_wholesale" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_profit_wholesale" tabindex="0" data-tip="—">Gross profit per pack</label>
                <input id="profit_wholesale" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_partner_retailer" tabindex="0" data-tip="—">Retailer profit per pack</label>
                <input id="partner_profit_wh" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_oper_profit_wholesale" tabindex="0" data-tip="—">Operating profit per pack</label>
                <input id="oper_profit_wholesale" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_oper_gm_wholesale" tabindex="0" data-tip="—">Operating margin (%)</label>
                <input id="oper_gm_wholesale" class="w-120" type="text" readonly>
              </div>
            </div>
          </div>

          <!-- Distributor -->
          <div class="card" id="card_distributor">
            <div class="flex" style="justify-content:space-between">
              <label class="toggle t" tabindex="0" data-tip="Turn distributor channel on or off for blended calculations."><input id="use_distributor" type="checkbox" checked> Distributor</label>
              <span class="chip t" id="tip_price_distributor" tabindex="0" data-tip="—">Pricing rule</span>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label class="t" tabindex="0" data-tip="Share of total volume through Distributor.">Mix percent</label>
                <input id="mix_distributor" class="w-120" type="number" min="0" max="100" step="0.01" value="20">
              </div>
              <div>
                <label class="t" tabindex="0" data-tip="Percent discount from retail to arrive at distributor price.">Distributor discount (%)</label>
                <input id="disc_distributor" class="w-120" type="number" min="0" max="100" step="0.01" value="40">
              </div>
            </div>
            <div class="row">
              <div>
                <label>Distributor price per pack</label>
                <input id="price_distributor" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_gm_distributor" tabindex="0" data-tip="—">Gross margin (%)</label>
                <input id="gm_distributor" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_profit_distributor" tabindex="0" data-tip="—">Gross profit per pack</label>
                <input id="profit_distributor" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_partner_distributor" tabindex="0" data-tip="—">Distributor profit per pack</label>
                <input id="partner_profit_dist" class="w-120" type="text" readonly>
              </div>
            </div>
            <div class="row">
              <div>
                <label class="t" id="tip_oper_profit_distributor" tabindex="0" data-tip="—">Operating profit per pack</label>
                <input id="oper_profit_distributor" class="w-120" type="text" readonly>
              </div>
              <div>
                <label class="t" id="tip_oper_gm_distributor" tabindex="0" data-tip="—">Operating margin (%)</label>
                <input id="oper_gm_distributor" class="w-120" type="text" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:14px">Monthly Costs (Operating Overhead)</h2>
        <div class="row">
          <div>
              <label class="t" tabindex="0" data-tip="Estimated packs produced/sold per month for overhead allocation.">Monthly pack volume</label>
              <input id="monthly_volume" type="number" min="1" step="1" value="1000">
          </div>
        </div>
        <div id="overhead_rows" style="margin-top:8px"></div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="btn_add_overhead">Add overhead item</button>
          <span class="note">Each row: Name + Monthly Cost ($)</span>
        </div>

        <div class="row" style="margin-top:8px">
          <label class="toggle"><input id="oh_retail" type="checkbox" checked> Include overhead in Retail</label>
          <label class="toggle"><input id="oh_wholesale" type="checkbox" checked> Include overhead in Wholesale</label>
          <label class="toggle"><input id="oh_distributor" type="checkbox" checked> Include overhead in Distributor</label>
        </div>
      </div>

      <div>
        <h2 style="margin-top:14px">Sales Commissions</h2>
        <div class="note">Define up to 10 salespersons, their commission structures, and target bonuses.</div>
        <div id="salespersons_wrap" style="margin-top:8px"></div>
        <div class="row" style="margin-top:6px">
            <button class="btn" id="btn_add_salesperson">Add Salesperson</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px; justify-content:space-between">
        <div class="flex">
          <button class="btn primary" id="btn_calc">Calculate / Recalculate</button>
          <span class="note" id="last_calc">Last calculated: —</span>
        </div>
        <span class="muted small">Scenarios now save commission data.</span>
      </div>

      <div>
        <h2 style="margin-top:14px">Blended KPIs</h2>
        <div class="kpi">
          <div class="card">
            <div class="muted small">Blended revenue per pack <span class="t chip" id="tip_blended_rev" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_blended_rev">$0.00</div>
          </div>
          <div class="card">
            <div class="muted small">Blended gross profit per pack <span class="t chip" id="tip_blended_profit" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_blended_profit">$0.00</div>
          </div>
          <div class="card">
            <div class="muted small">Blended gross margin (%) <span class="t chip" id="tip_blended_gm" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_blended_gm">0.00%</div>
          </div>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="card">
            <div class="muted small">Blended operating profit per pack <span class="t chip" id="tip_blended_op" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_blended_oper">$0.00</div>
          </div>
          <div class="card">
            <div class="muted small">Blended operating margin (%) <span class="t chip" id="tip_blended_opm" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_blended_opm">0.00%</div>
          </div>
          <div class="card">
            <div class="muted small">Overhead per pack <span class="t chip" id="tip_oh_per_pack" tabindex="0" data-tip="—">i</span></div>
            <div class="big thin" id="kpi_oh_per_pack">$0.00</div>
          </div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:14px">Commission Projections</h2>
        <div class="row">
            <div>
                <label class="t" tabindex="0" data-tip="Calculate commissions over this time period. All figures will be scaled from the monthly inputs.">Projection Period</label>
                <select id="projection_period" class="btn w-160">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly" selected>Monthly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
        </div>
        <div class="scroller" style="margin-top:10px; max-height:320px;">
            <table id="commissions_tbl">
                <thead>
                    <tr>
                        <th>Salesperson</th>
                        <th>Base Commission</th>
                        <th>Bonuses Earned</th>
                        <th>Total Pay</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="kpi" style="margin-top:10px">
            <div class="card">
                <div class="muted small">Total Commissions Paid <span class="t chip" id="tip_total_comm" tabindex="0" data-tip="—">i</span></div>
                <div class="big thin" id="kpi_total_comm">$0.00</div>
            </div>
            <div class="card">
                <div class="muted small">Commission as % of Gross <span class="t chip" id="tip_comm_pct_gross" tabindex="0" data-tip="—">i</span></div>
                <div class="big thin" id="kpi_comm_pct_gross">0.00%</div>
            </div>
            <div class="card">
                <div class="muted small">Commission as % of Op Profit <span class="t chip" id="tip_comm_pct_oper" tabindex="0" data-tip="—">i</span></div>
                <div class="big thin" id="kpi_comm_pct_oper">0.00%</div>
            </div>
        </div>
      </div>
    </section>

    <!-- Full width: Scenarios -->
    <section style="grid-column:1 / -1;">
      <div class="flex" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2>Scenarios</h2>
          <div class="note">Save inputs and computed fields. Load to restore. Stored in your browser.</div>
        </div>
        <div class="sticky-actions">
          <input id="scenario_label" class="w-160" type="text" placeholder="Label (optional)">
          <button class="btn primary" id="btn_save" title="Save the current configuration">Save scenario</button>
          <button class="btn" id="btn_download" title="Export all saved scenarios as a comma-separated values file">Download CSV</button>
          <button class="btn" id="btn_clear" title="Remove all saved scenarios">Clear all</button>
        </div>
      </div>
      <div class="scroller" style="margin-top:10px; max-height:420px;">
        <table id="scenarios_tbl">
          <thead>
            <tr>
              <th>Saved</th>
              <th>Label</th>
              <th>Retail Price</th>
              <th>Total COGS</th>
              <th>Blended GM%</th>
              <th>Blended Op M%</th>
              <th>Total Comm.</th>
              <th>Total Bonuses</th>
              <th>Comm % Gross</th>
              <th>Comm % Op Profit</th>
              <th># Salespersons</th>
              <th>Load</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
(function(){
  // --- Utilities ---
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const money = n => "$" + (isFinite(n) ? Number(n).toFixed(2) : "0.00");
  const pct2  = n => (isFinite(n) ? Number(n).toFixed(2) : "0.00") + "%";
  function valNum(el){ const v = parseFloat((el && el.value)!=null ? el.value : el); return isFinite(v) ? v : 0; }
  const setTip = (id, text)=>{ const el = document.getElementById(id); if(el){ el.setAttribute('data-tip', text); } };
  const SCENARIO_KEY = 'channel_calc_scenarios_v5'; // Incremented version for new structure

  let commissionResults = []; // Globally accessible results for snapshotting

  // --- Auto calc gate ---
  const autoCalc = ()=> $('#auto_calc').checked;
  let dirty = false;
  function onMaybeCalc(){ if(autoCalc()) computeAll(); else dirty=true; }

  // --- Dynamic Row Management ---
  function createDynamicRow(container, pref, options, onAddCallback) {
      if (container.children.length >= options.max) return;
      const row = document.createElement('div');
      row.className = options.rowClass;
      row.innerHTML = options.template(pref, container.children.length + 1);
      container.appendChild(row);
      
      row.querySelectorAll('input, select').forEach(input => input.addEventListener('input', onMaybeCalc));
      row.querySelector('[data-act="rm"]').addEventListener('click', () => {
          row.remove();
          onMaybeCalc();
      });
      if(onAddCallback) onAddCallback(row);
  }

  // --- Ingredients ---
  const ingWrap = $("#ingredients");
  const ingOptions = { max: 5, rowClass: 'grid-4', template: (pref = {}, idx) => `<div><label class="t" tabindex="0" data-tip="Free text name for your tracking.">Ingredient ${idx} name</label><input type="text" class="ing_name" value="${pref.name||""}"></div><div><label class="t" tabindex="0" data-tip="Active amount per pill.">Milligrams per pill</label><input type="number" class="ing_mg" min="0" step="0.0001" value="${pref.mg||0}"></div><div><label class="t" tabindex="0" data-tip="Cost in dollars per milligram.">Cost per milligram (USD)</label><input type="number" class="ing_cpmg" min="0" step="0.000001" value="${pref.cpmg||0}"></div><div><label>&nbsp;</label><button class="btn w-90" data-act="rm" title="Remove this ingredient">Remove</button></div>` };
  function addIngredientRow(pref={}) { createDynamicRow(ingWrap, pref, ingOptions); }
  $("#btn_add_ing").addEventListener("click", e => { e.preventDefault(); addIngredientRow(); });

  // --- Packaging, Display, Overhead rows ---
  const packWrap = $('#pack_rows'), dispWrap = $('#disp_rows'), overheadWrap = $('#overhead_rows');
  const simpleRowOptions = (max, name) => ({ max, rowClass: 'row', template: (pref = {}) => `<input type="text" class="${name}_name w-160" placeholder="Name" value="${pref.name||''}"> <input type="number" class="${name}_cost w-120" step="0.01" min="0" value="${pref.cost||0}"> <button class="btn small" data-act="rm">Remove</button>` });
  function addPackRow(pref={}) { createDynamicRow(packWrap, pref, simpleRowOptions(4, 'pack')); }
  function addDispRow(pref={}) { createDynamicRow(dispWrap, pref, simpleRowOptions(4, 'disp')); }
  function addOverheadRow(pref={}) { createDynamicRow(overheadWrap, pref, simpleRowOptions(10, 'overhead')); }
  $('#btn_add_pack').addEventListener('click', e => { e.preventDefault(); addPackRow(); });
  $('#btn_add_disp').addEventListener('click', e => { e.preventDefault(); addDispRow(); });
  $('#btn_add_overhead').addEventListener('click', e => { e.preventDefault(); addOverheadRow(); });

  // --- Salespersons and Bonuses ---
  const salespersonsWrap = $('#salespersons_wrap');
  const bonusTemplate = (pref = {}) => `
    <div class="bonus-row">
        <div>
            <label>Bonus Type</label>
            <select class="bonus_type btn">
                <option value="units" ${pref.type === 'units' ? 'selected' : ''}>Units Sold</option>
                <option value="gross_rev" ${pref.type === 'gross_rev' ? 'selected' : ''}>Gross Revenue</option>
                <option value="gross_profit" ${pref.type === 'gross_profit' ? 'selected' : ''}>Gross Profit</option>
            </select>
        </div>
        <div>
            <label>Target</label>
            <input type="number" class="bonus_target" min="0" value="${pref.target || 0}">
        </div>
        <div>
            <label>Bonus ($)</label>
            <input type="number" class="bonus_amount" min="0" value="${pref.amount || 0}">
        </div>
        <button class="btn small" data-act="rm">Remove</button>
    </div>`;

  const salespersonTemplate = (pref = {}) => `
    <div class="row">
        <input type="text" class="salesperson_name" placeholder="Salesperson Name" value="${pref.name || ''}">
        <button class="btn" data-act="rm">Remove Person</button>
    </div>
    <div class="row" style="margin-top:8px">
        <label class="toggle"><input type="checkbox" class="sp_chan_retail" ${pref.channels?.retail ? 'checked' : ''}> Retail</label>
        <label class="toggle"><input type="checkbox" class="sp_chan_wholesale" ${pref.channels?.wholesale ? 'checked' : ''}> Wholesale</label>
        <label class="toggle"><input type="checkbox" class="sp_chan_distributor" ${pref.channels?.distributor ? 'checked' : ''}> Distributor</label>
    </div>
    <div class="grid-2" style="margin-top:8px">
        <div>
            <label>Commission Type</label>
            <select class="commission_type btn">
                <option value="pct_gross" ${pref.commissionType === 'pct_gross' ? 'selected' : ''}>% of Gross Revenue</option>
                <option value="usd_pack" ${pref.commissionType === 'usd_pack' ? 'selected' : ''}>$ per Pack Sold</option>
            </select>
        </div>
        <div>
            <label>Commission Value</label>
            <input type="number" class="commission_value" min="0" step="0.01" value="${pref.commissionValue || 0}">
        </div>
    </div>
    <div style="margin-top:8px">
        <label>Target Bonuses</label>
        <div class="bonuses_wrap"></div>
        <button class="btn small" data-act="add_bonus" style="margin-top:4px">Add Bonus</button>
    </div>`;

  function addBonusRow(wrap, pref = {}) {
      const bonusRow = document.createElement('div');
      bonusRow.innerHTML = bonusTemplate(pref);
      wrap.appendChild(bonusRow);
      bonusRow.querySelector('[data-act="rm"]').addEventListener('click', () => {
          bonusRow.remove();
          onMaybeCalc();
      });
      bonusRow.querySelectorAll('input, select').forEach(el => el.addEventListener('input', onMaybeCalc));
  }

  const salespersonOptions = { max: 10, rowClass: 'salesperson-card', template: salespersonTemplate };
  function addSalespersonRow(pref = {}) {
      createDynamicRow(salespersonsWrap, pref, salespersonOptions, (row) => {
          const bonusesWrap = row.querySelector('.bonuses_wrap');
          row.querySelector('[data-act="add_bonus"]').addEventListener('click', (e) => {
              e.preventDefault();
              addBonusRow(bonusesWrap);
          });
          if (pref.bonuses) {
              pref.bonuses.forEach(bonusPref => addBonusRow(bonusesWrap, bonusPref));
          }
      });
  }
  $('#btn_add_salesperson').addEventListener('click', e => { e.preventDefault(); addSalespersonRow(); });


  // --- Element refs ---
  const pills=$('#inp_pills'), retailPrice=$('#inp_retail_price'), packsPerDisplay=$('#inp_packs_per_display'), packagingTotal=$('#inp_packaging'), displayPerPack=$('#out_display_per_pack');
  const useRetail=$('#use_retail'), useWholesale=$('#use_wholesale'), useDistributor=$('#use_distributor');
  const mixRetail=$('#mix_retail'), mixWholesale=$('#mix_wholesale'), mixDistributor=$('#mix_distributor');
  const discWholesale=$('#disc_wholesale'), discDistributor=$('#disc_distributor');
  const priceWholesale=$('#price_wholesale'), priceDistributor=$('#price_distributor');
  const profitRetail=$('#profit_retail'), profitWholesale=$('#profit_wholesale'), profitDistributor=$('#profit_distributor');
  const gmRetail=$('#gm_retail'), gmWholesale=$('#gm_wholesale'), gmDistributor=$('#gm_distributor');
  const operProfitRetail=$('#oper_profit_retail'), operProfitWholesale=$('#oper_profit_wholesale'), operProfitDistributor=$('#oper_profit_distributor');
  const operGmRetail=$('#oper_gm_retail'), operGmWholesale=$('#oper_gm_wholesale'), operGmDistributor=$('#oper_gm_distributor');
  const partnerProfitWh=$('#partner_profit_wh'), partnerProfitDist=$('#partner_profit_dist');
  const chkAutoMix=$('#chk_auto_mix');
  const shipPerOrder=$('#ship_per_order'), packsPerOrder=$('#packs_per_order'), includeShipping=$('#include_shipping');
  const kIngr=$('#kpi_ing_cost'), kTotal=$('#kpi_total_cost'), kCostPerMg=$('#kpi_cost_per_mg');
  const kBlendRev=$('#kpi_blended_rev'), kBlendProfit=$('#kpi_blended_profit'), kBlendGM=$('#kpi_blended_gm');
  const kBlendOper=$('#kpi_blended_oper'), kBlendOPM=$('#kpi_blended_opm');
  const kOHPerPack=$('#kpi_oh_per_pack');
  const mv=$('#monthly_volume');
  const ohR=$('#oh_retail'), ohW=$('#oh_wholesale'), ohD=$('#oh_distributor');
  const tblBody=$('#scenarios_tbl tbody');
  const btnSave=$('#btn_save'), btnDownload=$('#btn_download'), btnClear=$('#btn_clear'), lbl=$('#scenario_label');
  const btnCalc=$('#btn_calc'), lastCalc=$('#last_calc');
  const projectionPeriod = $('#projection_period');
  const commissionsTblBody = $('#commissions_tbl tbody');
  const kTotalComm = $('#kpi_total_comm'), kCommPctGross = $('#kpi_comm_pct_gross'), kCommPctOper = $('#kpi_comm_pct_oper');

  // --- Mix & channel helpers ---
  function enabledChannels(){
    return [
      {key:"Retail", id:"retail", use:useRetail.checked, mix:mixRetail},
      {key:"Wholesale", id:"wholesale", use:useWholesale.checked, mix:mixWholesale},
      {key:"Distributor", id:"distributor", use:useDistributor.checked, mix:mixDistributor}
    ];
  }

  function normalizeMix(){
    const chans = enabledChannels();
    const enabled = chans.filter(c=>c.use);
    if(chkAutoMix.checked){
      let sum = enabled.reduce((s,c)=> s+valNum(c.mix), 0);
      if(sum<=0 && enabled.length > 0){ const each = 100/enabled.length; enabled.forEach(c=> c.mix.value = each.toFixed(2)); }
      else if (sum > 0) { enabled.forEach(c=> c.mix.value = (valNum(c.mix)/sum*100).toFixed(2)); }
      chans.forEach(c=> { c.mix.readOnly=true; c.mix.style.pointerEvents = 'none'; });
    }else{
      chans.forEach(c=>{c.mix.readOnly=!c.use; c.mix.style.pointerEvents = c.use ? 'auto' : 'none';});
    }
  }

  function toggleChannelCards(){
    $('#card_retail').classList.toggle('disabled', !useRetail.checked);
    $('#card_wholesale').classList.toggle('disabled', !useWholesale.checked);
    $('#card_distributor').classList.toggle('disabled', !useDistributor.checked);
  }

  // --- Breakdown helpers ---
  function sumBreakdown(container, nameClass, costClass) {
      let sum = 0, lines = [];
      [...container.children].forEach(row => {
          const name = row.querySelector(nameClass).value || 'Item';
          const cost = parseFloat(row.querySelector(costClass).value) || 0;
          sum += cost;
          if (cost > 0) lines.push(`${name}: ${money(cost)}`);
      });
      return { sum, lines };
  }

  // --- Core compute ---
  function computeAll(){
    dirty=false; lastCalc.textContent = `Last calculated: ${new Date().toLocaleTimeString()}`;

    // --- Product & COGS ---
    const nPills = Math.max(0, Math.floor(valNum(pills)));
    const pack = sumBreakdown(packWrap, '.pack_name', '.pack_cost');
    packagingTotal.value = pack.sum.toFixed(2);
    const disp = sumBreakdown(dispWrap, '.disp_name', '.disp_cost');
    const ppd = Math.max(1, Math.floor(valNum(packsPerDisplay)));
    const dispPer = disp.sum / ppd;
    displayPerPack.value = money(dispPer);
    setTip('tip_display_per_pack', `Amortized display per pack = ${money(disp.sum)} ÷ ${ppd} packs = ${money(dispPer)}`);
    let ingCost = 0, totalMg = 0;
    $$("#ingredients .grid-4").forEach(row=>{
      const mg = valNum(row.querySelector(".ing_mg")), cpmg = valNum(row.querySelector(".ing_cpmg"));
      ingCost += mg * nPills * cpmg; totalMg += mg * nPills;
    });
    const totalCOGS = ingCost + pack.sum + dispPer;
    kIngr.textContent = money(ingCost);
    kTotal.textContent = money(totalCOGS);

    // --- Overhead ---
    const ohTotal = sumBreakdown(overheadWrap, '.overhead_name', '.overhead_cost').sum;
    const vol = Math.max(1, Math.floor(valNum(mv)));
    const ohPerPack = ohTotal/vol;
    kOHPerPack.textContent = money(ohPerPack);
    setTip('tip_oh_per_pack', `Overhead per pack = ${money(ohTotal)} ÷ ${vol} = ${money(ohPerPack)}`);

    // --- Channel Financials ---
    const rPrice = valNum(retailPrice);
    const wlPrice = rPrice * (1 - (valNum(discWholesale)/100));
    const dsPrice = rPrice * (1 - (valNum(discDistributor)/100));
    priceWholesale.value = money(wlPrice); priceDistributor.value = money(dsPrice);
    const prR = rPrice - totalCOGS, prW = wlPrice - totalCOGS, prD = dsPrice - totalCOGS;
    profitRetail.value = money(prR); profitWholesale.value = money(prW); profitDistributor.value = money(prD);
    gmRetail.value = pct2(rPrice > 0 ? (prR/rPrice*100) : 0); gmWholesale.value = pct2(wlPrice > 0 ? (prW/wlPrice*100) : 0); gmDistributor.value = pct2(dsPrice > 0 ? (prD/dsPrice*100) : 0);
    partnerProfitWh.value = money(rPrice - wlPrice); partnerProfitDist.value = money(wlPrice - dsPrice);
    const shipPerPack = includeShipping.checked ? (valNum(shipPerOrder) / Math.max(1, Math.floor(valNum(packsPerOrder)))) : 0;
    const ohInc = { retail: ohR.checked ? ohPerPack : 0, wholesale: ohW.checked ? ohPerPack : 0, distributor: ohD.checked ? ohPerPack : 0 };
    const opAdj = { retail: ohInc.retail + shipPerPack, wholesale: ohInc.wholesale, distributor: ohInc.distributor };
    const opR = prR - opAdj.retail, opW = prW - opAdj.wholesale, opD = prD - opAdj.distributor;
    operProfitRetail.value = money(opR); operProfitWholesale.value = money(opW); operProfitDistributor.value = money(opD);
    operGmRetail.value = pct2(rPrice>0 ? (opR/rPrice*100) : 0); operGmWholesale.value = pct2(wlPrice>0 ? (opW/wlPrice*100) : 0); operGmDistributor.value = pct2(dsPrice>0 ? (opD/dsPrice*100) : 0);

    // --- Blended KPIs ---
    const chans = [
      {use:useRetail.checked, mix:valNum(mixRetail)/100, price:rPrice, gross:prR, oper:opR},
      {use:useWholesale.checked, mix:valNum(mixWholesale)/100, price:wlPrice, gross:prW, oper:opW},
      {use:useDistributor.checked, mix:valNum(mixDistributor)/100, price:dsPrice, gross:prD, oper:opD},
    ].map(c => (c.use ? c : {...c, mix:0}));
    let blendedRev=0, blendedGross=0, blendedOper=0;
    chans.forEach(c=>{ blendedRev+=c.price*c.mix; blendedGross+=c.gross*c.mix; blendedOper+=c.oper*c.mix; });
    kBlendRev.textContent = money(blendedRev); kBlendProfit.textContent = money(blendedGross); kBlendGM.textContent = pct2(blendedRev>0 ? (blendedGross/blendedRev*100) : 0);
    kBlendOper.textContent = money(blendedOper); kBlendOPM.textContent = pct2(blendedRev>0 ? (blendedOper/blendedRev*100) : 0);

    // --- Commission Calculations ---
    const period = projectionPeriod.value;
    const scale = { daily: 1/30.44, weekly: 1/4.345, monthly: 1, yearly: 12 }[period] || 1;
    const periodVolume = vol * scale;
    
    let totalCommissions = 0;
    commissionResults = []; // Clear and recalculate
    const salespersonCards = $$('.salesperson-card');

    salespersonCards.forEach(card => {
        const name = card.querySelector('.salesperson_name').value || 'Unnamed';
        const channels = {
            retail: card.querySelector('.sp_chan_retail').checked,
            wholesale: card.querySelector('.sp_chan_wholesale').checked,
            distributor: card.querySelector('.sp_chan_distributor').checked,
        };
        const commissionType = card.querySelector('.commission_type').value;
        const commissionValue = valNum(card.querySelector('.commission_value'));

        let personVolume = 0, personGrossRev = 0, personGrossProfit = 0;
        if (channels.retail && useRetail.checked) {
            const channelVol = periodVolume * (valNum(mixRetail)/100);
            personVolume += channelVol;
            personGrossRev += channelVol * rPrice;
            personGrossProfit += channelVol * prR;
        }
        if (channels.wholesale && useWholesale.checked) {
            const channelVol = periodVolume * (valNum(mixWholesale)/100);
            personVolume += channelVol;
            personGrossRev += channelVol * wlPrice;
            personGrossProfit += channelVol * prW;
        }
        if (channels.distributor && useDistributor.checked) {
            const channelVol = periodVolume * (valNum(mixDistributor)/100);
            personVolume += channelVol;
            personGrossRev += channelVol * dsPrice;
            personGrossProfit += channelVol * prD;
        }

        let baseCommission = 0;
        if (commissionType === 'pct_gross') {
            baseCommission = personGrossRev * (commissionValue / 100);
        } else { // usd_pack
            baseCommission = personVolume * commissionValue;
        }

        let bonusesEarned = 0;
        card.querySelectorAll('.bonus-row').forEach(bonusRow => {
            const type = bonusRow.querySelector('.bonus_type').value;
            const target = valNum(bonusRow.querySelector('.bonus_target'));
            const amount = valNum(bonusRow.querySelector('.bonus_amount'));
            
            let metric;
            if (type === 'units') metric = personVolume;
            else if (type === 'gross_rev') metric = personGrossRev;
            else metric = personGrossProfit;

            if (metric >= target) {
                bonusesEarned += amount;
            }
        });

        const totalPay = baseCommission + bonusesEarned;
        totalCommissions += totalPay;
        commissionResults.push({ name, baseCommission, bonusesEarned, totalPay });
    });

    // --- Render Commission Results ---
    commissionsTblBody.innerHTML = '';
    commissionResults.forEach(res => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${res.name}</td><td>${money(res.baseCommission)}</td><td>${money(res.bonusesEarned)}</td><td>${money(res.totalPay)}</td>`;
        commissionsTblBody.appendChild(row);
    });

    const totalPeriodGross = periodVolume * blendedRev;
    const totalPeriodOper = periodVolume * blendedOper;
    kTotalComm.textContent = money(totalCommissions);
    kCommPctGross.textContent = pct2(totalPeriodGross > 0 ? (totalCommissions / totalPeriodGross * 100) : 0);
    kCommPctOper.textContent = pct2(totalPeriodOper > 0 ? (totalCommissions / totalPeriodOper * 100) : 0);
    
    setTip('tip_total_comm', `Total commissions and bonuses paid for the selected ${period} period.`);
    setTip('tip_comm_pct_gross', `Total Commissions ${money(totalCommissions)} ÷ Total Gross Revenue ${money(totalPeriodGross)}`);
    setTip('tip_comm_pct_oper', `Total Commissions ${money(totalCommissions)} ÷ Total Operating Profit ${money(totalPeriodOper)}`);


    // --- Final UI Updates ---
    normalizeMix();
    toggleChannelCards();
    $('#rev_retail').value = money(rPrice);
  }

  // --- Events ---
  const allInputs = [pills, retailPrice, packsPerDisplay, discWholesale, discDistributor, mixRetail, mixWholesale, mixDistributor, mv, shipPerOrder, packsPerOrder, projectionPeriod];
  allInputs.forEach(el=> el.addEventListener("input", onMaybeCalc));
  const allToggles = [useRetail, useWholesale, useDistributor, chkAutoMix, ohR, ohW, ohD, includeShipping, $('#auto_calc')];
  allToggles.forEach(el=> el.addEventListener("change", ()=>{ normalizeMix(); onMaybeCalc(); }));
  btnCalc.addEventListener('click', ()=> computeAll());

  // --- Scenarios ---
  let scenarios = [];
  function snapshot(){
    const salespersonRows = $$('.salesperson-card').map(card => {
        const bonuses = [...card.querySelectorAll('.bonus-row')].map(bRow => ({
            type: bRow.querySelector('.bonus_type').value,
            target: valNum(bRow.querySelector('.bonus_target')),
            amount: valNum(bRow.querySelector('.bonus_amount')),
        }));
        return {
            name: card.querySelector('.salesperson_name').value,
            channels: {
                retail: card.querySelector('.sp_chan_retail').checked,
                wholesale: card.querySelector('.sp_chan_wholesale').checked,
                distributor: card.querySelector('.sp_chan_distributor').checked,
            },
            commissionType: card.querySelector('.commission_type').value,
            commissionValue: valNum(card.querySelector('.commission_value')),
            bonuses
        };
    });
    
    const totalBonuses = commissionResults.reduce((sum, res) => sum + res.bonusesEarned, 0);

    return {
      ts:new Date().toISOString(), label:($('#scenario_label').value||""),
      pills:valNum(pills), retailPrice:valNum(retailPrice), packsPerDisplay:valNum(packsPerDisplay),
      totalCost: parseFloat($('#kpi_total_cost').textContent.replace(/[^0-9.]/g,""))||0,
      wlDisc: valNum(discWholesale), dsDisc: valNum(discDistributor),
      useR: useRetail.checked, useW: useWholesale.checked, useD: useDistributor.checked,
      mixR: valNum(mixRetail), mixW: valNum(mixWholesale), mixD: valNum(mixDistributor),
      blendedGM: parseFloat(kBlendGM.textContent)||0,
      blendedOPM: parseFloat(kBlendOPM.textContent)||0,
      ohIncR: ohR.checked, ohIncW: ohW.checked, ohIncD: ohD.checked,
      monthlyVolume: valNum(mv),
      shipPerOrder: valNum(shipPerOrder), packsPerOrder: valNum(packsPerOrder), includeShipping: includeShipping.checked,
      projectionPeriod: projectionPeriod.value,
      totalCommissions: parseFloat(kTotalComm.textContent.replace(/[^0-9.]/g,""))||0,
      totalBonuses: totalBonuses,
      commPctGross: parseFloat(kCommPctGross.textContent) || 0,
      commPctOper: parseFloat(kCommPctOper.textContent) || 0,
      salespersonRows,
      ingRows: [...ingWrap.children].map(r=>({name: r.querySelector('.ing_name').value||'', mg: valNum(r.querySelector('.ing_mg')), cpmg: valNum(r.querySelector('.ing_cpmg'))})),
      packRows: [...packWrap.children].map(r=>({name: r.querySelector('.pack_name').value||'', cost: valNum(r.querySelector('.pack_cost'))})),
      dispRows: [...dispWrap.children].map(r=>({name: r.querySelector('.disp_name').value||'', cost: valNum(r.querySelector('.disp_cost'))})),
      overheadRows: [...overheadWrap.children].map(r=>({name: r.querySelector('.overhead_name').value||'', cost: valNum(r.querySelector('.overhead_cost'))}))
    };
  }

  function renderScenarios(){
    tblBody.innerHTML = "";
    scenarios.forEach((s,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(s.ts).toLocaleString()}</td>
        <td>${s.label||""}</td>
        <td>${money(s.retailPrice)}</td>
        <td>${money(s.totalCost)}</td>
        <td>${pct2(s.blendedGM)}</td>
        <td>${pct2(s.blendedOPM)}</td>
        <td>${money(s.totalCommissions)}</td>
        <td>${money(s.totalBonuses)}</td>
        <td>${pct2(s.commPctGross)}</td>
        <td>${pct2(s.commPctOper)}</td>
        <td>${(s.salespersonRows || []).length}</td>
        <td><button class="btn small" data-idx="${i}" data-act="load">Load</button></td>
      `;
      tblBody.appendChild(tr);
    });
    $$('#scenarios_tbl [data-act="load"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const s = scenarios[parseInt(e.currentTarget.dataset.idx)]; if(!s) return;
        pills.value = s.pills; retailPrice.value = s.retailPrice; packsPerDisplay.value = s.packsPerDisplay;
        ingWrap.innerHTML=''; (s.ingRows||[]).forEach(p=> addIngredientRow(p));
        packWrap.innerHTML=''; (s.packRows||[]).forEach(p=> addPackRow(p));
        dispWrap.innerHTML=''; (s.dispRows||[]).forEach(p=> addDispRow(p));
        overheadWrap.innerHTML=''; (s.overheadRows||[]).forEach(p=> addOverheadRow(p));
        salespersonsWrap.innerHTML = ''; (s.salespersonRows || []).forEach(p => addSalespersonRow(p));
        useRetail.checked = s.useR; useWholesale.checked = s.useW; useDistributor.checked = s.useD;
        mixRetail.value = s.mixR; mixWholesale.value = s.mixW; mixDistributor.value = s.mixD;
        discWholesale.value = s.wlDisc; discDistributor.value = s.dsDisc;
        mv.value = s.monthlyVolume;
        ohR.checked = !!s.ohIncR; ohW.checked = !!s.ohIncW; ohD.checked = !!s.ohIncD;
        shipPerOrder.value = s.shipPerOrder; packsPerOrder.value = s.packsPerOrder; includeShipping.checked = !!s.includeShipping;
        projectionPeriod.value = s.projectionPeriod || 'monthly';
        computeAll();
      });
    });
  }
  
  function saveScenariosToStorage() { localStorage.setItem(SCENARIO_KEY, JSON.stringify(scenarios)); }

  btnSave.addEventListener("click",()=>{computeAll(); scenarios.unshift(snapshot()); renderScenarios(); saveScenariosToStorage(); $('#scenario_label').value="";});
  
  btnDownload.addEventListener("click",()=>{
    if(scenarios.length===0){ return; }
    const cols = Object.keys(scenarios[0]).filter(k => typeof scenarios[0][k] !== 'object');
    const header = cols.join(",") + "\n";
    const csv = header + scenarios.map(row => cols.map(col => `"${row[col]}"`).join(',')).join('\n');
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
    link.download = `scenarios-${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
  });
  
  btnClear.addEventListener("click", () => {
      if (confirm("Are you sure you want to delete all saved scenarios? This cannot be undone.")) {
          scenarios = []; renderScenarios(); saveScenariosToStorage();
      }
  });
  
  // --- Initial Load ---
  function init() {
      addIngredientRow({name:"Metocin (4-HO-MET)", mg:2, cpmg:0.002});
      addPackRow({name:'Box/Outer', cost:0.50});
      addOverheadRow({name: 'Salaries', cost: 5000});
     addSalespersonRow({ name: "Lead Rep", channels: { retail: true, wholesale: true }, commissionType: 'pct_gross', commissionValue: 5, bonuses: [{ type: 'gross_rev', target: 5000, amount: 250 }] });
      try {
          const stored = localStorage.getItem(SCENARIO_KEY);
          if (stored) { scenarios = JSON.parse(stored); renderScenarios(); }
      } catch (e) { console.error("Failed to load scenarios", e); scenarios = []; }
      computeAll();
  }

  init();

})();
</script>
</body>
</html>
