<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Channel Calculator — Enhanced (Completed)</title>
  <style>
    :root{ color-scheme: light dark; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; background: Canvas; color: CanvasText; line-height:1.45; }
    header{ padding:16px 20px; border-bottom:1px solid ButtonBorder; background: Canvas; position:sticky;top:0;z-index:3; }
    header h1{margin:0 0 4px;font-size:20px;font-weight:700}
    header .sub{color: GrayText;font-size:12px}
    .wrap{ max-width:1280px; padding:20px; margin:0 auto; display:grid; grid-template-columns:1.15fr 1fr; gap:16px; }
    @media (max-width: 1024px) { .wrap { grid-template-columns: 1fr; } }
    section{ background: Field; border:1px solid ButtonBorder; border-radius:14px; padding:14px; }
    h2{margin:0 0 10px;font-size:16px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color: GrayText;margin-bottom:6px}
    input[type="text"],input[type="number"],input[type="checkbox"]{ accent-color: AccentColor }
    input[type="text"],input[type="number"]{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid ButtonBorder; background: Field; color: FieldText; font-size:14px; }
    input[readonly]{ background: color-mix(in srgb, Field 92%, CanvasText 8%); color: color-mix(in srgb, FieldText 70%, CanvasText 30%); }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{ background: color-mix(in srgb, Field 85%, CanvasText 15%); border:1px solid ButtonBorder; padding:6px 8px; border-radius:10px; font-size:12px; color: GrayText; }
    .toggle{display:flex;align-items:center;gap:8px;font-size:13px;color: CanvasText}
    .toggle input{transform:scale(1.05)}
    table{width:100%; border-collapse:collapse; font-size:13px; background: Field; border-radius:12px; overflow:hidden;}
    th,td{padding:8px 10px;border-bottom:1px solid ButtonBorder;text-align:right;white-space:nowrap}
    th:first-child,td:first-child{text-align:left}
    .btn{ appearance:none; border:1px solid ButtonBorder; background: ButtonFace; color: ButtonText; padding:9px 12px; border-radius:10px; font-size:13px; cursor:pointer; }
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background: AccentColor; color: AccentColorText; border-color: AccentColor}
    .muted{color: GrayText}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .card{background: Field;border:1px solid ButtonBorder;border-radius:12px;padding:10px}
    .card .big{font-size:19px;font-weight:700}
    .thin{font-variant-numeric:tabular-nums;letter-spacing:.3px}
    .disabled{opacity:.6; pointer-events: none;}
    .note{font-size:12px;color: GrayText;margin-top:6px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .w-120{width:120px}
    .w-90{width:90px}
    .w-160{width:160px}
    .scroller{overflow:auto}
    .sticky-actions{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
    .small{font-size:12px}
    /* Tooltip system */
    .t{ position:relative; cursor:help; }
    .t[tabindex="0"]:focus::after,
    .t:hover::after{ content: attr(data-tip); position:absolute; z-index:10; left:0; top:100%; margin-top:6px; max-width:420px; background: CanvasText; color: Canvas; border: 1px solid ButtonBorder; padding:10px 12px; border-radius:10px; box-shadow: 0 6px 16px 0 color-mix(in srgb, CanvasText 15%, transparent); white-space:pre-wrap; }
    .t[tabindex="0"]:focus::before,
    .t:hover::before{ content:""; position:absolute; left:16px; top:100%; border:6px solid transparent; border-bottom-color: CanvasText; transform: translateY(-1px); }
    .pill{padding:2px 6px;border:1px solid ButtonBorder;border-radius:999px;font-size:11px;color:GrayText}
    .danger{color: color-mix(in srgb, CanvasText 20%, red)}
  </style>
</head>
<body>
  <header>
    <h1>Channel Calculator — Enhanced</h1>
    <div class="sub">System colors. Precise tooltips. Manual <span class="pill">Recalculate</span> + optional auto-calc. Defaults: 3 pills/pack, $12.95 retail.</div>
  </header>

  <div class="wrap">
    <!-- Left column: Inputs -->
    <section>
      <h2>Product Specifications</h2>
      <div class="grid-3">
        <div>
          <label class="t" tabindex="0" data-tip="Number of tablets in each pack.">Pills per pack</label>
          <input id="inp_pills" type="number" min="1" step="1" value="3">
        </div>
        <div>
          <label class="t" tabindex="0" data-tip="Consumer-facing price; other channel prices are discounts from this.">Retail price per pack (USD)</label>
          <input id="inp_retail_price" type="number" min="0" step="0.01" value="12.95">
        </div>
        <div class="toggle">
          <input id="auto_calc" type="checkbox" checked>
          <label class="t" tabindex="0" data-tip="When ON, results update as you type. When OFF, click Calculate / Recalculate to update and timestamp the run.">Auto‑recalculate</label>
        </div>
      </div>

      <div class="grid-3" style="margin-top:10px">
        <div>
          <label class="t" tabindex="0" data-tip="All packaging components per pack. Use breakdown rows below; this field shows the rolled-up total.">Packaging cost per pack (USD)</label>
          <input id="inp_packaging" type="number" min="0" step="0.01" value="0.50" readonly>
        </div>
        <div>
          <label class="t" tabindex="0" data-tip="How many packs share one display.">Packs per display</label>
          <input id="inp_packs_per_display" type="number" min="1" step="1" value="12">
        </div>
        <div>
          <label class="t" id="tip_display_per_pack" tabindex="0" data-tip="Display per pack = $0.00 ÷ 0 = $0.00">Amortized display cost per pack (USD)</label>
          <input id="out_display_per_pack" type="text" readonly>
        </div>
      </div>

      <h2 style="margin-top:14px">Ingredients (add up to five)
        <span class="t chip" id="tip_ing_sum" tabindex="0" data-tip="No ingredients yet">Formula</span>
      </h2>
      <div id="ingredients"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn_add_ing" title="Add an ingredient row (maximum five)">Add ingredient</button>
        <span class="note">Each ingredient: Name, milligrams per pill, cost per milligram.</span>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="muted small">Total ingredient cost per pack <span class="t chip" id="tip_ing_total" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_ing_cost">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Total COGS per pack (for Gross) <span class="t chip" id="tip_total_cost" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_total_cost">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Fully loaded cost per mg <span class="t chip" id="tip_cost_per_mg" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_cost_per_mg">$0.0000</div>
        </div>
      </div>

      <h2 style="margin-top:16px">Packaging Cost Breakdown
        <span class="chip muted">up to 4 rows</span>
      </h2>
      <div id="pack_rows"></div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn_add_pack">Add packaging item</button>
        <span class="note">Each row: Name + Cost per pack ($)</span>
      </div>

      <h2 style="margin-top:16px">Display Cost Breakdown
        <span class="chip muted">up to 4 rows</span>
      </h2>
      <div id="disp_rows"></div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn_add_disp">Add display item</button>
        <span class="note">Each row: Name + Cost per display ($). Amortized by packs per display.</span>
      </div>

    </section>

    <!-- Right column: Channels + Monthly Costs -->
    <section>
      <h2>Sales Channels</h2>
      <div class="row">
        <label class="toggle t" tabindex="0" data-tip="When enabled, the mix percentages are auto-normalized across the enabled channels. Disable to edit mix manually."><input id="chk_auto_mix" type="checkbox" checked> Auto-redistribute mix among enabled channels</label>
        <span class="chip">Uncheck to edit mix manually.</span>
      </div>

      <div style="margin-top:8px" class="grid-3">
        <!-- Retail -->
        <div class="card" id="card_retail">
          <div class="flex" style="justify-content:space-between">
            <label class="toggle t" tabindex="0" data-tip="Turn retail channel on or off for blended calculations."><input id="use_retail" type="checkbox" checked> Retail</label>
            <span class="chip">Price = retail input</span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="t" tabindex="0" data-tip="Share of total volume expected through Retail.">Mix percent</label>
              <input id="mix_retail" class="w-120" type="number" min="0" max="100" step="0.01" value="50">
            </div>
            <div>
              <label class="t" id="tip_gm_retail" tabindex="0" data-tip="—">Gross margin (%)</label>
              <input id="gm_retail" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_profit_retail" tabindex="0" data-tip="—">Gross profit per pack</label>
              <input id="profit_retail" class="w-120" type="text" readonly>
            </div>
            <div>
              <label>Revenue per pack</label>
              <input id="rev_retail" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_oper_profit_retail" tabindex="0" data-tip="—">Operating profit per pack</label>
              <input id="oper_profit_retail" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_oper_gm_retail" tabindex="0" data-tip="—">Operating margin (%)</label>
              <input id="oper_gm_retail" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" tabindex="0" data-tip="Shipping cost per retail order; converted to per-pack by packs per order.">Shipping per retail order ($)</label>
              <input id="ship_per_order" class="w-120" type="number" min="0" step="0.01" value="2.50">
            </div>
            <div>
              <label class="t" tabindex="0" data-tip="Assumed packs per retail order for shipping allocation.">Packs per retail order</label>
              <input id="packs_per_order" class="w-120" type="number" min="1" step="1" value="1">
            </div>
            <label class="toggle t" tabindex="0" data-tip="Include shipping in Retail operating costs? Affects Operating profit/margin for Retail only."><input id="include_shipping" type="checkbox" checked> Include shipping</label>
          </div>
        </div>

        <!-- Wholesale -->
        <div class="card" id="card_wholesale">
          <div class="flex" style="justify-content:space-between">
            <label class="toggle t" tabindex="0" data-tip="Turn wholesale channel on or off for blended calculations."><input id="use_wholesale" type="checkbox" checked> Wholesale</label>
            <span class="chip t" id="tip_price_wholesale" tabindex="0" data-tip="—">Pricing rule</span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="t" tabindex="0" data-tip="Share of total volume through Wholesale.">Mix percent</label>
              <input id="mix_wholesale" class="w-120" type="number" min="0" max="100" step="0.01" value="30">
            </div>
            <div>
              <label class="t" tabindex="0" data-tip="Percent discount from retail to arrive at wholesale price.">Wholesale discount (%)</label>
              <input id="disc_wholesale" class="w-120" type="number" min="0" max="100" step="0.01" value="25">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Wholesale price per pack</label>
              <input id="price_wholesale" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_gm_wholesale" tabindex="0" data-tip="—">Gross margin (%)</label>
              <input id="gm_wholesale" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_profit_wholesale" tabindex="0" data-tip="—">Gross profit per pack</label>
              <input id="profit_wholesale" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_partner_retailer" tabindex="0" data-tip="—">Retailer profit per pack</label>
              <input id="partner_profit_wh" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_oper_profit_wholesale" tabindex="0" data-tip="—">Operating profit per pack</label>
              <input id="oper_profit_wholesale" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_oper_gm_wholesale" tabindex="0" data-tip="—">Operating margin (%)</label>
              <input id="oper_gm_wholesale" class="w-120" type="text" readonly>
            </div>
          </div>
        </div>

        <!-- Distributor -->
        <div class="card" id="card_distributor">
          <div class="flex" style="justify-content:space-between">
            <label class="toggle t" tabindex="0" data-tip="Turn distributor channel on or off for blended calculations."><input id="use_distributor" type="checkbox" checked> Distributor</label>
            <span class="chip t" id="tip_price_distributor" tabindex="0" data-tip="—">Pricing rule</span>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label class="t" tabindex="0" data-tip="Share of total volume through Distributor.">Mix percent</label>
              <input id="mix_distributor" class="w-120" type="number" min="0" max="100" step="0.01" value="20">
            </div>
            <div>
              <label class="t" tabindex="0" data-tip="Percent discount from retail to arrive at distributor price.">Distributor discount (%)</label>
              <input id="disc_distributor" class="w-120" type="number" min="0" max="100" step="0.01" value="40">
            </div>
          </div>
          <div class="row">
            <div>
              <label>Distributor price per pack</label>
              <input id="price_distributor" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_gm_distributor" tabindex="0" data-tip="—">Gross margin (%)</label>
              <input id="gm_distributor" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_profit_distributor" tabindex="0" data-tip="—">Gross profit per pack</label>
              <input id="profit_distributor" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_partner_distributor" tabindex="0" data-tip="—">Distributor profit per pack</label>
              <input id="partner_profit_dist" class="w-120" type="text" readonly>
            </div>
          </div>
          <div class="row">
            <div>
              <label class="t" id="tip_oper_profit_distributor" tabindex="0" data-tip="—">Operating profit per pack</label>
              <input id="oper_profit_distributor" class="w-120" type="text" readonly>
            </div>
            <div>
              <label class="t" id="tip_oper_gm_distributor" tabindex="0" data-tip="—">Operating margin (%)</label>
              <input id="oper_gm_distributor" class="w-120" type="text" readonly>
            </div>
          </div>
        </div>
      </div>

      <h2 style="margin-top:14px">Monthly Costs (Operating Overhead)</h2>
      <div class="row">
        <div>
            <label class="t" tabindex="0" data-tip="Estimated packs produced/sold per month for overhead allocation.">Monthly pack volume</label>
            <input id="monthly_volume" type="number" min="1" step="1" value="1000">
        </div>
      </div>
      <div id="overhead_rows" style="margin-top:8px"></div>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="btn_add_overhead">Add overhead item</button>
        <span class="note">Each row: Name + Monthly Cost ($)</span>
      </div>

      <div class="row" style="margin-top:8px">
        <label class="toggle"><input id="oh_retail" type="checkbox" checked> Include overhead in Retail</label>
        <label class="toggle"><input id="oh_wholesale" type="checkbox" checked> Include overhead in Wholesale</label>
        <label class="toggle"><input id="oh_distributor" type="checkbox" checked> Include overhead in Distributor</label>
      </div>

      <div class="row" style="margin-top:10px; justify-content:space-between">
        <div class="flex">
          <button class="btn primary" id="btn_calc">Calculate / Recalculate</button>
          <span class="note" id="last_calc">Last calculated: —</span>
        </div>
        <span class="muted small">Scenarios remain compatible and will save new fields.</span>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="card">
          <div class="muted small">Blended revenue per pack <span class="t chip" id="tip_blended_rev" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_blended_rev">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Blended gross profit per pack <span class="t chip" id="tip_blended_profit" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_blended_profit">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Blended gross margin (%) <span class="t chip" id="tip_blended_gm" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_blended_gm">0.00%</div>
        </div>
      </div>

      <div class="kpi" style="margin-top:10px">
        <div class="card">
          <div class="muted small">Blended operating profit per pack <span class="t chip" id="tip_blended_op" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_blended_oper">$0.00</div>
        </div>
        <div class="card">
          <div class="muted small">Blended operating margin (%) <span class="t chip" id="tip_blended_opm" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_blended_opm">0.00%</div>
        </div>
        <div class="card">
          <div class="muted small">Overhead per pack <span class="t chip" id="tip_oh_per_pack" tabindex="0" data-tip="—">i</span></div>
          <div class="big thin" id="kpi_oh_per_pack">$0.00</div>
        </div>
      </div>

    </section>

    <!-- Full width: Scenarios -->
    <section style="grid-column:1 / -1;">
      <div class="flex" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2>Scenarios</h2>
          <div class="note">Save inputs and computed fields. Load to restore. Stored in your browser.</div>
        </div>
        <div class="sticky-actions">
          <input id="scenario_label" class="w-160" type="text" placeholder="Label (optional)">
          <button class="btn primary" id="btn_save" title="Save the current configuration">Save scenario</button>
          <button class="btn" id="btn_download" title="Export all saved scenarios as a comma-separated values file">Download CSV</button>
          <button class="btn" id="btn_clear" title="Remove all saved scenarios">Clear all</button>
        </div>
      </div>
      <div class="scroller" style="margin-top:10px; max-height:420px;">
        <table id="scenarios_tbl">
          <thead>
            <tr>
              <th>Saved</th>
              <th>Label</th>
              <th>Pills</th>
              <th>Retail Price</th>
              <th>Total COGS</th>
              <th>WL Disc%</th>
              <th>Dst Disc%</th>
              <th>Use R</th>
              <th>Use W</th>
              <th>Use D</th>
              <th>Mix R%</th>
              <th>Mix W%</th>
              <th>Mix D%</th>
              <th>Price W</th>
              <th>Price D</th>
              <th>Gross Profit R</th>
              <th>Gross Profit W</th>
              <th>Gross Profit D</th>
              <th>GM R%</th>
              <th>GM W%</th>
              <th>GM D%</th>
              <th>Op Profit R</th>
              <th>Op Profit W</th>
              <th>Op Profit D</th>
              <th>Op Margin R%</th>
              <th>Op Margin W%</th>
              <th>Op Margin D%</th>
              <th>Blended Rev</th>
              <th>Blended Gross Prof</th>
              <th>Blended GM%</th>
              <th>Blended Op Prof</th>
              <th>Blended Op M%</th>
              <th>Retailer Profit</th>
              <th>Distributor Profit</th>
              <th>OH/pack</th>
              <th>OH inc R</th>
              <th>OH inc W</th>
              <th>OH inc D</th>
              <th>Ingr. rows</th>
              <th>Pack rows</th>
              <th>Disp rows</th>
              <th>OH rows</th>
              <th>Load</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

<script>
(function(){
  // --- Utilities ---
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));
  const money = n => "$" + (isFinite(n) ? Number(n).toFixed(2) : "0.00");
  const pct2  = n => (isFinite(n) ? Number(n).toFixed(2) : "0.00") + "%";
  function valNum(el){ const v = parseFloat((el && el.value)!=null ? el.value : el); return isFinite(v) ? v : 0; }
  const setTip = (id, text)=>{ const el = document.getElementById(id); if(el){ el.setAttribute('data-tip', text); } };
  const SCENARIO_KEY = 'channel_calc_scenarios_v3'; // Incremented version for new structure

  // --- Auto calc gate ---
  const autoCalc = ()=> $('#auto_calc').checked;
  let dirty = false;
  function onMaybeCalc(){ if(autoCalc()) computeAll(); else dirty=true; }

  // --- Dynamic Row Management ---
  function createDynamicRow(container, pref, options) {
      if (container.children.length >= options.max) return;
      const row = document.createElement('div');
      row.className = options.rowClass;
      row.innerHTML = options.template(pref, container.children.length + 1);
      container.appendChild(row);
      
      row.querySelectorAll('input').forEach(input => input.addEventListener('input', onMaybeCalc));
      row.querySelector('[data-act="rm"]').addEventListener('click', () => {
          row.remove();
          onMaybeCalc();
      });
  }

  // --- Ingredients ---
  const ingWrap = $("#ingredients");
  const ingOptions = {
      max: 5,
      rowClass: 'grid-4',
      template: (pref = {}, idx) => `
          <div>
              <label class="t" tabindex="0" data-tip="Free text name for your tracking.">Ingredient ${idx} name</label>
              <input type="text" class="ing_name" value="${pref.name||""}">
          </div>
          <div>
              <label class="t" tabindex="0" data-tip="Active amount per pill.">Milligrams per pill</label>
              <input type="number" class="ing_mg" min="0" step="0.0001" value="${pref.mg||0}">
          </div>
          <div>
              <label class="t" tabindex="0" data-tip="Cost in dollars per milligram.">Cost per milligram (USD)</label>
              <input type="number" class="ing_cpmg" min="0" step="0.000001" value="${pref.cpmg||0}">
          </div>
          <div>
              <label>&nbsp;</label>
              <button class="btn w-90" data-act="rm" title="Remove this ingredient">Remove</button>
          </div>`
  };
  function addIngredientRow(pref={}) { createDynamicRow(ingWrap, pref, ingOptions); }
  $("#btn_add_ing").addEventListener("click", e => { e.preventDefault(); addIngredientRow(); });

  // --- Packaging rows ---
  const packWrap = $('#pack_rows');
  const packOptions = {
      max: 4,
      rowClass: 'row',
      template: (pref = {}) => `<input type="text" class="pack_name w-160" placeholder="Name" value="${pref.name||''}"> <input type="number" class="pack_cost w-120" step="0.01" min="0" value="${pref.cost||0}"> <button class="btn small" data-act="rm">Remove</button>`
  };
  function addPackRow(pref={}) { createDynamicRow(packWrap, pref, packOptions); }
  $('#btn_add_pack').addEventListener('click', e => { e.preventDefault(); addPackRow(); });

  // --- Display rows ---
  const dispWrap = $('#disp_rows');
  const dispOptions = {
      max: 4,
      rowClass: 'row',
      template: (pref = {}) => `<input type="text" class="disp_name w-160" placeholder="Name" value="${pref.name||''}"> <input type="number" class="disp_cost w-120" step="0.01" min="0" value="${pref.cost||0}"> <button class="btn small" data-act="rm">Remove</button>`
  };
  function addDispRow(pref={}) { createDynamicRow(dispWrap, pref, dispOptions); }
  $('#btn_add_disp').addEventListener('click', e => { e.preventDefault(); addDispRow(); });
  
  // --- Overhead rows ---
  const overheadWrap = $('#overhead_rows');
  const overheadOptions = {
      max: 10, // Allow more overhead items
      rowClass: 'row',
      template: (pref = {}) => `<input type="text" class="overhead_name w-160" placeholder="Name" value="${pref.name||''}"> <input type="number" class="overhead_cost w-120" step="0.01" min="0" value="${pref.cost||0}"> <button class="btn small" data-act="rm">Remove</button>`
  };
  function addOverheadRow(pref={}) { createDynamicRow(overheadWrap, pref, overheadOptions); }
  $('#btn_add_overhead').addEventListener('click', e => { e.preventDefault(); addOverheadRow(); });


  // --- Element refs ---
  const pills=$('#inp_pills'), retailPrice=$('#inp_retail_price'), packsPerDisplay=$('#inp_packs_per_display'), packagingTotal=$('#inp_packaging'), displayPerPack=$('#out_display_per_pack');
  const useRetail=$('#use_retail'), useWholesale=$('#use_wholesale'), useDistributor=$('#use_distributor');
  const mixRetail=$('#mix_retail'), mixWholesale=$('#mix_wholesale'), mixDistributor=$('#mix_distributor');
  const discWholesale=$('#disc_wholesale'), discDistributor=$('#disc_distributor');
  const priceWholesale=$('#price_wholesale'), priceDistributor=$('#price_distributor');
  const profitRetail=$('#profit_retail'), profitWholesale=$('#profit_wholesale'), profitDistributor=$('#profit_distributor');
  const gmRetail=$('#gm_retail'), gmWholesale=$('#gm_wholesale'), gmDistributor=$('#gm_distributor');
  const operProfitRetail=$('#oper_profit_retail'), operProfitWholesale=$('#oper_profit_wholesale'), operProfitDistributor=$('#oper_profit_distributor');
  const operGmRetail=$('#oper_gm_retail'), operGmWholesale=$('#oper_gm_wholesale'), operGmDistributor=$('#oper_gm_distributor');
  const partnerProfitWh=$('#partner_profit_wh'), partnerProfitDist=$('#partner_profit_dist');
  const chkAutoMix=$('#chk_auto_mix');
  const shipPerOrder=$('#ship_per_order'), packsPerOrder=$('#packs_per_order'), includeShipping=$('#include_shipping');
  const kIngr=$('#kpi_ing_cost'), kTotal=$('#kpi_total_cost'), kCostPerMg=$('#kpi_cost_per_mg');
  const kBlendRev=$('#kpi_blended_rev'), kBlendProfit=$('#kpi_blended_profit'), kBlendGM=$('#kpi_blended_gm');
  const kBlendOper=$('#kpi_blended_oper'), kBlendOPM=$('#kpi_blended_opm');
  const kOHPerPack=$('#kpi_oh_per_pack');
  const mv=$('#monthly_volume');
  const ohR=$('#oh_retail'), ohW=$('#oh_wholesale'), ohD=$('#oh_distributor');
  const tblBody=$('#scenarios_tbl tbody');
  const btnSave=$('#btn_save'), btnDownload=$('#btn_download'), btnClear=$('#btn_clear'), lbl=$('#scenario_label');
  const btnCalc=$('#btn_calc'), lastCalc=$('#last_calc');

  // --- Mix & channel helpers ---
  function enabledChannels(){
    return [
      {key:"Retail", id:"retail", use:useRetail.checked, mix:mixRetail},
      {key:"Wholesale", id:"wholesale", use:useWholesale.checked, mix:mixWholesale},
      {key:"Distributor", id:"distributor", use:useDistributor.checked, mix:mixDistributor}
    ];
  }

  function normalizeMix(){
    const chans = enabledChannels();
    const enabled = chans.filter(c=>c.use);
    if(chkAutoMix.checked){
      let sum = enabled.reduce((s,c)=> s+valNum(c.mix), 0);
      if(sum<=0 && enabled.length > 0){ const each = 100/enabled.length; enabled.forEach(c=> c.mix.value = each.toFixed(2)); }
      else if (sum > 0) { enabled.forEach(c=> c.mix.value = (valNum(c.mix)/sum*100).toFixed(2)); }
      chans.forEach(c=> { c.mix.readOnly=true; c.mix.style.pointerEvents = 'none'; });
    }else{
      chans.forEach(c=>{c.mix.readOnly=!c.use; c.mix.style.pointerEvents = c.use ? 'auto' : 'none';});
    }
  }

  function toggleChannelCards(){
    $('#card_retail').classList.toggle('disabled', !useRetail.checked);
    $('#card_wholesale').classList.toggle('disabled', !useWholesale.checked);
    $('#card_distributor').classList.toggle('disabled', !useDistributor.checked);
  }

  // --- Breakdown helpers ---
  function sumBreakdown(container, nameClass, costClass) {
      let sum = 0, lines = [];
      [...container.children].forEach(row => {
          const name = row.querySelector(nameClass).value || 'Item';
          const cost = parseFloat(row.querySelector(costClass).value) || 0;
          sum += cost;
          if (cost > 0) lines.push(`${name}: ${money(cost)}`);
      });
      return { sum, lines };
  }

  // --- Core compute ---
  function computeAll(){
    dirty=false; lastCalc.textContent = `Last calculated: ${new Date().toLocaleTimeString()}`;

    const nPills = Math.max(0, Math.floor(valNum(pills)));

    // Packaging breakdown
    const pack = sumBreakdown(packWrap, '.pack_name', '.pack_cost');
    packagingTotal.value = pack.sum.toFixed(2);

    // Display breakdown amortized per pack
    const disp = sumBreakdown(dispWrap, '.disp_name', '.disp_cost');
    const ppd = Math.max(1, Math.floor(valNum(packsPerDisplay)));
    const dispPer = disp.sum / ppd;
    displayPerPack.value = money(dispPer);
    setTip('tip_display_per_pack', `Amortized display per pack = (\n• ${disp.lines.join("\n• ") || '—'}\nΣ = ${money(disp.sum)}) ÷ ${ppd} packs = ${money(dispPer)}`);

    // Ingredients
    let ingCost = 0; let totalMg = 0; let lines = [];
    $$("#ingredients .grid-4").forEach(row=>{
      const name = (row.querySelector(".ing_name").value||"Ingredient").trim();
      const mg = valNum(row.querySelector(".ing_mg"));
      const cpmg = valNum(row.querySelector(".ing_cpmg"));
      const cost = mg * nPills * cpmg;
      ingCost += cost; totalMg += mg * nPills;
      if(mg>0 || cpmg>0) lines.push(`${name}: ${mg.toFixed(4)} mg × ${nPills} × ${money(cpmg)} = ${money(cost)}`);
    });
    if(lines.length===0) lines = ["No ingredient cost components yet."];
    setTip('tip_ing_sum', `Ingredient cost per pack is the sum of each line:\n\n• `+lines.join("\n• "));

    const totalCOGS = ingCost + pack.sum + dispPer;
    const costPerMg = totalMg>0 ? (totalCOGS/totalMg) : 0;

    kIngr.textContent = money(ingCost);
    kTotal.textContent = money(totalCOGS);
    kCostPerMg.textContent = isFinite(costPerMg) ? "$"+costPerMg.toFixed(4) : "$0.0000";

    setTip('tip_ing_total', `Total ingredient cost = Σ(ingredient mg per pill × ${nPills} pills × cost per mg) = ${money(ingCost)}`);
    setTip('tip_total_cost', `Total COGS per pack = ${money(ingCost)} (ingredients) + ${money(pack.sum)} (packaging) + ${money(dispPer)} (display per pack) = ${money(totalCOGS)}`);
    setTip('tip_cost_per_mg', `Fully loaded cost per mg = ${money(totalCOGS)} ÷ ${totalMg.toFixed(4)} mg = $${isFinite(costPerMg)?costPerMg.toFixed(4):'0.0000'}`);

    // Monthly overhead
    const ohBreakdown = sumBreakdown(overheadWrap, '.overhead_name', '.overhead_cost');
    const ohTotal = ohBreakdown.sum;
    const vol = Math.max(1, Math.floor(valNum(mv)));
    const ohPerPack = ohTotal/vol;
    kOHPerPack.textContent = money(ohPerPack);
    setTip('tip_oh_per_pack', `Overhead per pack = (Σ ${money(ohTotal)}) ÷ ${vol} = ${money(ohPerPack)}`);

    // Channel pricing
    const rPrice = valNum(retailPrice);
    const wlPrice = rPrice * (1 - (valNum(discWholesale)/100));
    const dsPrice = rPrice * (1 - (valNum(discDistributor)/100));
    priceWholesale.value = money(wlPrice);
    priceDistributor.value = money(dsPrice);

    setTip('tip_price_wholesale', `Wholesale price = Retail ${money(rPrice)} × (1 − ${valNum(discWholesale).toFixed(2)}%) = ${money(wlPrice)}`);
    setTip('tip_price_distributor', `Distributor price = Retail ${money(rPrice)} × (1 − ${valNum(discDistributor).toFixed(2)}%) = ${money(dsPrice)}`);

    // Per-channel gross profit and margin (exclude overhead)
    const prR = rPrice - totalCOGS;
    const prW = wlPrice - totalCOGS;
    const prD = dsPrice - totalCOGS;
    profitRetail.value = money(prR);
    profitWholesale.value = money(prW);
    profitDistributor.value = money(prD);

    gmRetail.value = pct2(rPrice > 0 ? (prR/rPrice*100) : 0);
    gmWholesale.value = pct2(wlPrice > 0 ? (prW/wlPrice*100) : 0);
    gmDistributor.value = pct2(dsPrice > 0 ? (prD/dsPrice*100) : 0);

    setTip('tip_profit_retail', `Retail GROSS profit = Retail ${money(rPrice)} − COGS ${money(totalCOGS)} = ${money(prR)}`);
    setTip('tip_profit_wholesale', `Wholesale GROSS profit = Wholesale ${money(wlPrice)} − COGS ${money(totalCOGS)} = ${money(prW)}`);
    setTip('tip_profit_distributor', `Distributor GROSS profit = Distributor ${money(dsPrice)} − COGS ${money(totalCOGS)} = ${money(prD)}`);

    setTip('tip_gm_retail', `Retail GM = ${money(prR)} ÷ ${money(rPrice)} = ${gmRetail.value}`);
    setTip('tip_gm_wholesale', `Wholesale GM = ${money(prW)} ÷ ${money(wlPrice)} = ${gmWholesale.value}`);
    setTip('tip_gm_distributor', `Distributor GM = ${money(prD)} ÷ ${money(dsPrice)} = ${gmDistributor.value}`);

    // Partner profits
    const retailerProfit = rPrice - wlPrice;
    partnerProfitWh.value = money(retailerProfit);
    const distributorProfit = wlPrice - dsPrice;
    partnerProfitDist.value = money(distributorProfit);
    setTip('tip_partner_retailer', `Retailer profit per pack = Retail ${money(rPrice)} − Wholesale ${money(wlPrice)} = ${money(retailerProfit)}`);
    setTip('tip_partner_distributor', `Distributor profit per pack = Wholesale ${money(wlPrice)} − Distributor ${money(dsPrice)} = ${money(distributorProfit)}`);

    // Operating adjustments per channel
    const shipPerPack = includeShipping.checked ? (valNum(shipPerOrder) / Math.max(1, Math.floor(valNum(packsPerOrder)))) : 0;
    const ohInc = { retail: ohR.checked ? ohPerPack : 0, wholesale: ohW.checked ? ohPerPack : 0, distributor: ohD.checked ? ohPerPack : 0 };
    const opAdj = { retail: ohInc.retail + shipPerPack, wholesale: ohInc.wholesale, distributor: ohInc.distributor };

    const opR = prR - opAdj.retail;
    const opW = prW - opAdj.wholesale;
    const opD = prD - opAdj.distributor;
    operProfitRetail.value = money(opR);
    operProfitWholesale.value = money(opW);
    operProfitDistributor.value = money(opD);

    operGmRetail.value = pct2(rPrice>0 ? (opR/rPrice*100) : 0);
    operGmWholesale.value = pct2(wlPrice>0 ? (opW/wlPrice*100) : 0);
    operGmDistributor.value = pct2(dsPrice>0 ? (opD/dsPrice*100) : 0);

    setTip('tip_oper_profit_retail', `Retail OPERATING profit = Gross ${money(prR)} − Overhead ${money(ohInc.retail)} − Shipping ${money(shipPerPack)} = ${money(opR)}`);
    setTip('tip_oper_profit_wholesale', `Wholesale OPERATING profit = Gross ${money(prW)} − Overhead ${money(ohInc.wholesale)} = ${money(opW)}`);
    setTip('tip_oper_profit_distributor', `Distributor OPERATING profit = Gross ${money(prD)} − Overhead ${money(ohInc.distributor)} = ${money(opD)}`);
    setTip('tip_oper_gm_retail', `Retail OPERATING margin = ${money(opR)} ÷ ${money(rPrice)} = ${operGmRetail.value}`);
    setTip('tip_oper_gm_wholesale', `Wholesale OPERATING margin = ${money(opW)} ÷ ${money(wlPrice)} = ${operGmWholesale.value}`);
    setTip('tip_oper_gm_distributor', `Distributor OPERATING margin = ${money(opD)} ÷ ${money(dsPrice)} = ${operGmDistributor.value}`);

    // Blended metrics
    const chans = [
      {name:'Retail', use:useRetail.checked, mix:valNum(mixRetail)/100, price:rPrice, gross:prR, oper:opR},
      {name:'Wholesale', use:useWholesale.checked, mix:valNum(mixWholesale)/100, price:wlPrice, gross:prW, oper:opW},
      {name:'Distributor', use:useDistributor.checked, mix:valNum(mixDistributor)/100, price:dsPrice, gross:prD, oper:opD},
    ].map(c => (c.use ? c : {...c, mix:0}));

    let blendedRev=0, blendedGross=0, blendedOper=0; let revLines=[], gLines=[], oLines=[];
    chans.forEach(c=>{ const rev=c.price*c.mix; const gp=c.gross*c.mix; const op=c.oper*c.mix; blendedRev+=rev; blendedGross+=gp; blendedOper+=op; revLines.push(`${c.name}: ${money(c.price)} × ${(c.mix*100).toFixed(2)}% = ${money(rev)}`); gLines.push(`${c.name}: ${money(c.gross)} × ${(c.mix*100).toFixed(2)}% = ${money(gp)}`); oLines.push(`${c.name}: ${money(c.oper)} × ${(c.mix*100).toFixed(2)}% = ${money(op)}`); });
    const blendedGM = blendedRev>0 ? (blendedGross/blendedRev*100) : 0;
    const blendedOPM= blendedRev>0 ? (blendedOper/blendedRev*100) : 0;
    kBlendRev.textContent = money(blendedRev);
    kBlendProfit.textContent = money(blendedGross);
    kBlendGM.textContent = pct2(blendedGM);
    kBlendOper.textContent = money(blendedOper);
    kBlendOPM.textContent = pct2(blendedOPM);

    setTip('tip_blended_rev', `Blended revenue =\n`+revLines.join("\n" )+`\n= ${money(blendedRev)}`);
    setTip('tip_blended_profit', `Blended GROSS profit =\n`+gLines.join("\n" )+`\n= ${money(blendedGross)}`);
    setTip('tip_blended_gm', `Blended GROSS margin = ${money(blendedGross)} ÷ ${money(blendedRev)} = ${pct2(blendedGM)}`);
    setTip('tip_blended_op', `Blended OPERATING profit =\n`+oLines.join("\n" )+`\n= ${money(blendedOper)}`);
    setTip('tip_blended_opm', `Blended OPERATING margin = ${money(blendedOper)} ÷ ${money(blendedRev)} = ${pct2(blendedOPM)}`);

    normalizeMix();
    toggleChannelCards();
    $('#rev_retail').value = money(rPrice);
  }

  // --- Events ---
  const allInputs = [pills, retailPrice, packsPerDisplay, discWholesale, discDistributor, mixRetail, mixWholesale, mixDistributor, mv, shipPerOrder, packsPerOrder];
  allInputs.forEach(el=> el.addEventListener("input", onMaybeCalc));
  const allToggles = [useRetail, useWholesale, useDistributor, chkAutoMix, ohR, ohW, ohD, includeShipping, $('#auto_calc')];
  allToggles.forEach(el=> el.addEventListener("change", ()=>{ normalizeMix(); onMaybeCalc(); }));
  btnCalc.addEventListener('click', ()=> computeAll());

  // --- Scenarios ---
  let scenarios = [];
  function snapshot(){
    const ingRows = [...ingWrap.children].map(row=>({name: row.querySelector('.ing_name').value||'', mg: valNum(row.querySelector('.ing_mg')), cpmg: valNum(row.querySelector('.ing_cpmg'))}));
    const packRows = [...packWrap.children].map(row=>({name: row.querySelector('.pack_name').value||'', cost: valNum(row.querySelector('.pack_cost'))}));
    const dispRows = [...dispWrap.children].map(row=>({name: row.querySelector('.disp_name').value||'', cost: valNum(row.querySelector('.disp_cost'))}));
    const overheadRows = [...overheadWrap.children].map(row=>({name: row.querySelector('.overhead_name').value||'', cost: valNum(row.querySelector('.overhead_cost'))}));

    return {
      ts:new Date().toISOString(), label:($('#scenario_label').value||""),
      pills:valNum(pills), retailPrice:valNum(retailPrice), packsPerDisplay:valNum(packsPerDisplay),
      totalCost: parseFloat($('#kpi_total_cost').textContent.replace(/[^0-9.]/g,""))||0,
      wlDisc: valNum(discWholesale), dsDisc: valNum(discDistributor),
      useR: useRetail.checked, useW: useWholesale.checked, useD: useDistributor.checked,
      mixR: valNum(mixRetail), mixW: valNum(mixWholesale), mixD: valNum(mixDistributor),
      priceW: parseFloat(priceWholesale.value.replace(/[^0-9.]/g,""))||0,
      priceD: parseFloat(priceDistributor.value.replace(/[^0-9.]/g,""))||0,
      prR: parseFloat(profitRetail.value.replace(/[^0-9.]/g,""))||0,
      prW: parseFloat(profitWholesale.value.replace(/[^0-9.]/g,""))||0,
      prD: parseFloat(profitDistributor.value.replace(/[^0-9.]/g,""))||0,
      gmR: parseFloat(gmRetail.value)||0, gmW: parseFloat(gmWholesale.value)||0, gmD: parseFloat(gmDistributor.value)||0,
      opR: parseFloat(operProfitRetail.value.replace(/[^0-9.]/g,""))||0,
      opW: parseFloat(operProfitWholesale.value.replace(/[^0-9.]/g,""))||0,
      opD: parseFloat(operProfitDistributor.value.replace(/[^0-9.]/g,""))||0,
      opmR: parseFloat(operGmRetail.value)||0, opmW: parseFloat(operGmWholesale.value)||0, opmD: parseFloat(operGmDistributor.value)||0,
      blendedRev: parseFloat(kBlendRev.textContent.replace(/[^0-9.]/g,""))||0,
      blendedProfit: parseFloat(kBlendProfit.textContent.replace(/[^0-9.]/g,""))||0,
      blendedGM: parseFloat(kBlendGM.textContent)||0,
      blendedOper: parseFloat(kBlendOper.textContent.replace(/[^0-9.]/g,""))||0,
      blendedOPM: parseFloat(kBlendOPM.textContent)||0,
      partnerRetailer: parseFloat(partnerProfitWh.value.replace(/[^0-9.]/g,""))||0,
      partnerDistributor: parseFloat(partnerProfitDist.value.replace(/[^0-9.]/g,""))||0,
      ohPerPack: parseFloat(kOHPerPack.textContent.replace(/[^0-9.]/g,""))||0,
      ohIncR: ohR.checked, ohIncW: ohW.checked, ohIncD: ohD.checked,
      monthlyVolume: valNum(mv),
      shipPerOrder: valNum(shipPerOrder), packsPerOrder: valNum(packsPerOrder), includeShipping: includeShipping.checked,
      ingRows, packRows, dispRows, overheadRows
    };
  }

  function renderScenarios(){
    tblBody.innerHTML = "";
    scenarios.forEach((s,i)=>{
      const tr = document.createElement("tr");
      const td=(v,l=false)=>`<td${l?' style="text-align:left"':''}>${v}</td>`;
      tr.innerHTML = [
        td(new Date(s.ts).toLocaleString(), true), td(s.label||"", true),
        td(s.pills), td(money(s.retailPrice)), td(money(s.totalCost)),
        td(s.wlDisc.toFixed(2)), td(s.dsDisc.toFixed(2)),
        td(s.useR?"On":"Off"), td(s.useW?"On":"Off"), td(s.useD?"On":"Off"),
        td((s.mixR).toFixed(2)), td((s.mixW).toFixed(2)), td((s.mixD).toFixed(2)),
        td(money(s.priceW)), td(money(s.priceD)),
        td(money(s.prR)), td(money(s.prW)), td(money(s.prD)),
        td(pct2(s.gmR)), td(pct2(s.gmW)), td(pct2(s.gmD)),
        td(money(s.opR)), td(money(s.opW)), td(money(s.opD)),
        td(pct2(s.opmR)), td(pct2(s.opmW)), td(pct2(s.opmD)),
        td(money(s.blendedRev)), td(money(s.blendedProfit)), td(pct2(s.blendedGM)),
        td(money(s.blendedOper)), td(pct2(s.blendedOPM)),
        td(money(s.partnerRetailer)), td(money(s.partnerDistributor)),
        td(money(s.ohPerPack)), td(s.ohIncR?"Yes":"No"), td(s.ohIncW?"Yes":"No"), td(s.ohIncD?"Yes":"No"),
        td(s.ingRows.length), td(s.packRows.length), td(s.dispRows.length), td((s.overheadRows || []).length),
        `<td><button class=\"btn small\" data-idx=\"${i}\" data-act=\"load\" title=\"Load this scenario into the inputs above\">Load</button></td>`
      ].join("");
      tblBody.appendChild(tr);
    });
    $$('#scenarios_tbl [data-act="load"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const s = scenarios[parseInt(e.currentTarget.dataset.idx)]; if(!s) return;
        pills.value = s.pills; retailPrice.value = s.retailPrice; packsPerDisplay.value = s.packsPerDisplay;
        
        ingWrap.innerHTML=''; (s.ingRows||[]).slice(0,5).forEach(obj=> addIngredientRow(obj));
        packWrap.innerHTML=''; (s.packRows||[]).slice(0,4).forEach(obj=> addPackRow(obj));
        dispWrap.innerHTML=''; (s.dispRows||[]).slice(0,4).forEach(obj=> addDispRow(obj));
        
        overheadWrap.innerHTML='';
        if (s.overheadRows && s.overheadRows.length > 0) {
            s.overheadRows.slice(0,10).forEach(obj => addOverheadRow(obj));
        } else { // Fallback for older scenario format
            if(s.rent) addOverheadRow({name: 'Rent', cost: s.rent});
            if(s.salaries) addOverheadRow({name: 'Salaries', cost: s.salaries});
            if(s.marketing) addOverheadRow({name: 'Marketing', cost: s.marketing});
            if(s.website) addOverheadRow({name: 'Website Fees', cost: s.website});
            if(s.utilities) addOverheadRow({name: 'Utilities', cost: s.utilities});
        }

        useRetail.checked = s.useR; useWholesale.checked = s.useW; useDistributor.checked = s.useD;
        mixRetail.value = s.mixR; mixWholesale.value = s.mixW; mixDistributor.value = s.mixD;
        discWholesale.value = s.wlDisc; discDistributor.value = s.dsDisc;
        
        mv.value = s.monthlyVolume;
        ohR.checked = !!s.ohIncR; ohW.checked = !!s.ohIncW; ohD.checked = !!s.ohIncD;
        
        shipPerOrder.value = s.shipPerOrder; packsPerOrder.value = s.packsPerOrder; includeShipping.checked = !!s.includeShipping;
        
        computeAll();
      });
    });
  }
  
  function saveScenariosToStorage() {
      try {
          localStorage.setItem(SCENARIO_KEY, JSON.stringify(scenarios));
      } catch (e) {
          console.error("Failed to save scenarios to localStorage", e);
      }
  }

  btnSave.addEventListener("click",()=>{computeAll(); scenarios.unshift(snapshot()); renderScenarios(); saveScenariosToStorage(); $('#scenario_label').value="";});
  
  btnDownload.addEventListener("click",()=>{
    if(scenarios.length===0){ alert("No scenarios saved yet."); return; }
    const cols = Object.keys(scenarios[0]).filter(k => !['ingRows', 'packRows', 'dispRows', 'overheadRows'].includes(k));
    const header = cols.join(",") + "\n";
    const csvRows = scenarios.map(row => {
        return cols.map(colName => {
            let cell = row[colName] === null ? '' : String(row[colName]);
            if (cell.includes(',')) cell = `"${cell}"`;
            return cell;
        }).join(',');
    });
    const csv = header + csvRows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", `scenarios-${new Date().toISOString().slice(0,10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });
  
  btnClear.addEventListener("click", () => {
      if (confirm("Are you sure you want to delete all saved scenarios? This cannot be undone.")) {
          scenarios = [];
          renderScenarios();
          saveScenariosToStorage();
      }
  });
  
  // --- Initial Load ---
  function init() {
      // Seed example rows
      addIngredientRow({name:"Metocin (4-HO-MET)", mg:2, cpmg:0.002});
      addPackRow({name:'Box/Outer', cost:0.50});
      addPackRow({name:'Product Package', cost:1.25});
      addDispRow({name:'Counter Display', cost:4.00});
      addOverheadRow({name: 'Rent', cost: 1000});
      addOverheadRow({name: 'Salaries', cost: 5000});
      addOverheadRow({name: 'Marketing', cost: 2000});
      addOverheadRow({name: 'Website Fees', cost: 100});
      addOverheadRow({name: 'Utilities', cost: 500});
      
      // Load scenarios from localStorage
      try {
          const stored = localStorage.getItem(SCENARIO_KEY);
          if (stored) {
              scenarios = JSON.parse(stored);
              renderScenarios();
          }
      } catch (e) {
          console.error("Failed to load scenarios from localStorage", e);
          scenarios = [];
      }
      
      // Initial calculation
      computeAll();
  }

  init();

})();
</script>
</body>
</html>
